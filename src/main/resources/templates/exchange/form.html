<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layouts/main}">
<head>
    <title th:text="${isEdit ? 'êµí™˜/ë°˜í’ˆ ìˆ˜ì •' : 'êµí™˜/ë°˜í’ˆ ë“±ë¡'}">êµí™˜/ë°˜í’ˆ ë“±ë¡</title>
    <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}"/>
    <meta name="_csrf" th:unless="${_csrf}" content=""/>
    <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}"/>
    <meta name="_csrf_header" th:unless="${_csrf}" content="X-CSRF-TOKEN"/>
    
    <style>
        /* ğŸ¨ í¼ ì „ìš© ìŠ¤íƒ€ì¼ */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #35b27f;
            --warning-color: #ffc107;
            --danger-color: #f44336;
            --info-color: #06b6d4;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-color: #e5e7eb;
            --text-color: #374151;
            --text-muted: #6b7280;
            --bg-color: #ffffff;
            --radius: 0.5rem;
        }

        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg-color);
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .page-header h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.875rem;
            font-weight: 700;
        }

        .page-header p {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* ğŸ¯ ìƒë‹¨ ì„ íƒ ë²„íŠ¼ ì˜ì—­ */
        .top-selections {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .selection-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .selection-row:last-child {
            margin-bottom: 0;
        }

        .selection-label {
            min-width: 100px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .selection-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .selection-btn {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-color);
            white-space: nowrap;
        }

        .selection-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2);
        }

        .selection-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }

        /* ì„ íƒëœ ì •ë³´ í‘œì‹œ */
        .selected-info {
            background: var(--success-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 2px 4px rgba(53, 178, 127, 0.3);
        }

        /* ğŸ¯ í¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .form-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-section-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section-header::before {
            content: '';
            width: 4px;
            height: 1.25rem;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--danger-color);
        }

        .form-control {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: var(--bg-color);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* ğŸ¨ í•„ë“œ ìƒíƒœë³„ ìƒ‰ìƒ */
        .form-control.original-data {
            background-color: #e8f5e8 !important;
            border-color: var(--success-color) !important;
            color: #2e7d32 !important;
            font-weight: 600 !important;
        }

        .form-control.modified {
            background-color: #ffebee !important;
            border-color: var(--danger-color) !important;
            color: #d32f2f !important;
            font-weight: 600 !important;
        }

        .form-control.new-data {
            background-color: #e3f2fd !important;
            border-color: var(--info-color) !important;
            color: #1976d2 !important;
            font-weight: 600 !important;
        }

        /* Hidden í•„ë“œë“¤ */
        .hidden-fields {
            display: none;
        }

        /* ğŸ¯ ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ */
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--gray-100);
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-600);
            transform: translateY(-1px);
        }

        /* ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ */
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            background: var(--gray-100);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }

        .image-upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(53, 178, 127, 0.1);
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        /* ğŸ”¥ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ ì „ìš© ìŠ¤íƒ€ì¼ */
        .defect-detail-cell {
            font-size: 0.75rem;
            color: #dc3545;
            background-color: #f8d7da;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #f1aeb5;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
            transition: all 0.2s ease;
        }

        .defect-detail-cell:hover {
            background-color: #f5c2c7;
            border-color: #dc3545;
            transform: scale(1.05);
            z-index: 10;
            position: relative;
        }

        /* ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #defectDetail {
            resize: vertical;
            min-height: 100px;
            border-color: #dc3545 !important;
            background-color: #fff5f5;
            transition: all 0.3s ease;
        }

        #defectDetail:focus {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15) !important;
            background-color: #ffffff;
        }

        #defectDetail::placeholder {
            color: #dc3545;
            opacity: 0.7;
        }

        /* ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ ê·¸ë£¹ ì• ë‹ˆë©”ì´ì…˜ */
        #defectDetailGroup {
            border: 2px solid #f1aeb5;
            border-radius: var(--radius);
            background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
        }

        /* ë¶ˆëŸ‰ ê´€ë ¨ ê°•ì¡° í‘œì‹œ */
        .defect-highlight {
            position: relative;
        }

        .defect-highlight::before {
            content: 'ğŸ”´';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .form-container {
                padding: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .selection-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .selection-buttons {
                width: 100%;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            /* ğŸ”¥ ëª¨ë°”ì¼ì—ì„œ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ ìµœì í™” */
            .defect-detail-cell {
                max-width: 100px;
                font-size: 0.7rem;
            }
            
            #defectDetailGroup {
                padding: 0.75rem;
                margin-top: 0.75rem;
            }
        }
    </style>

    <!-- ğŸ”¥ JavaScript í•¨ìˆ˜ë“¤ -->
    <script th:inline="javascript">
        // CSRF í† í° ì„¤ì •
        window.csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
        window.csrfHeader = /*[[${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}]]*/ 'X-CSRF-TOKEN';

        // ğŸ¯ ì„œë²„ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬
        const serverData = {
            isEdit: /*[[${isEdit}]]*/ false,
            siteName: /*[[${returnItem?.siteName}]]*/ '',
            returnTypeCode: /*[[${returnItem?.returnTypeCode}]]*/ '',
            returnReason: /*[[${returnItem?.returnReason}]]*/ '',
            orderNumber: /*[[${returnItem?.orderNumber}]]*/ '',
            orderItemCode: /*[[${returnItem?.orderItemCode}]]*/ '',
            customerName: /*[[${returnItem?.customerName}]]*/ '',
            customerPhone: /*[[${returnItem?.customerPhone}]]*/ '',
            productColor: /*[[${returnItem?.productColor}]]*/ '',
            productSize: /*[[${returnItem?.productSize}]]*/ '',
            quantity: /*[[${returnItem?.quantity}]]*/ '',
            refundAmount: /*[[${returnItem?.refundAmount}]]*/ '',
            shippingFee: /*[[${returnItem?.shippingFee}]]*/ '',
            trackingNumber: /*[[${returnItem?.trackingNumber}]]*/ '',
            processor: /*[[${returnItem?.processor}]]*/ '',
            remarks: /*[[${returnItem?.remarks}]]*/ ''
        };

        console.log('ğŸ¯ ì„œë²„ ë°ì´í„°:', serverData);

        // ğŸ¯ ë¸Œëœë“œ ì„ íƒ í•¨ìˆ˜
        function selectBrand(brand, element) {
            console.log('ğŸ·ï¸ ë¸Œëœë“œ ì„ íƒ:', brand);

            // ëª¨ë“  ë¸Œëœë“œ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.selection-row:first-child .selection-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            element.classList.add('active');

            // ì‚¬ì´íŠ¸ ë²„íŠ¼ ìƒì„±
            const siteButtonsContainer = document.getElementById('siteButtons');
            let siteButtons = '';

            if (brand === 'ë ˆë…¸ë§ˆ') {
                siteButtons = `
                    <div class="selection-btn" onclick="selectSite('29CM-ë ˆë…¸ë§ˆ', this)">29CM-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ë¡¯ë°ì˜¨-ë ˆë…¸ë§ˆ', this)">ë¡¯ë°ì˜¨-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ë¬´ì‹ ì‚¬-ë ˆë…¸ë§ˆ', this)">ë¬´ì‹ ì‚¬-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ìŠ¤í† ì–´íŒœ-ë ˆë…¸ë§ˆ', this)">ìŠ¤í† ì–´íŒœ-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ìì‚¬ëª°-ë ˆë…¸ë§ˆ', this)">ìì‚¬ëª°-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ì§€ê·¸ì¬ê·¸-ë ˆë…¸ë§ˆ', this)">ì§€ê·¸ì¬ê·¸-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('ì¹´ì¹´ì˜¤-ë ˆë…¸ë§ˆ', this)">ì¹´ì¹´ì˜¤-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('íŒ¨ì…˜í”ŒëŸ¬ìŠ¤-ë ˆë…¸ë§ˆ', this)">íŒ¨ì…˜í”ŒëŸ¬ìŠ¤-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('í•˜í”„í´ëŸ½-ë ˆë…¸ë§ˆ', this)">í•˜í”„í´ëŸ½-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('SSG-ë ˆë…¸ë§ˆ', this)">SSG-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('EQL-ë ˆë…¸ë§ˆ', this)">EQL-ë ˆë…¸ë§ˆ</div>
                    <div class="selection-btn" onclick="selectSite('Wì»¨ì…‰-ë ˆë…¸ë§ˆ', this)">Wì»¨ì…‰-ë ˆë…¸ë§ˆ</div>
                `;
            } else if (brand === 'ì½”ë„ë¦¬í¬') {
                siteButtons = `
                    <div class="selection-btn" onclick="selectSite('29CM-ì½”ë„ë¦¬í¬', this)">29CM-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('ë¬´ì‹ ì‚¬-ì½”ë„ë¦¬í¬', this)">ë¬´ì‹ ì‚¬-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('ìì‚¬ëª°-ì½”ë„ë¦¬í¬', this)">ìì‚¬ëª°-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('ì§€ê·¸ì¬ê·¸-ì½”ë„ë¦¬í¬', this)">ì§€ê·¸ì¬ê·¸-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('CJì˜¤ì‡¼í•‘-ì½”ë„ë¦¬í¬', this)">CJì˜¤ì‡¼í•‘-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('SSG-ì½”ë„ë¦¬í¬', this)">SSG-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('EQL-ì½”ë„ë¦¬í¬', this)">EQL-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('LFëª°-ì½”ë„ë¦¬í¬', this)">LFëª°-ì½”ë„ë¦¬í¬</div>
                    <div class="selection-btn" onclick="selectSite('ìŠ¤í† ì–´íŒœ-ì½”ë„ë¦¬í¬', this)">ìŠ¤í† ì–´íŒœ-ì½”ë„ë¦¬í¬</div>
                `;
            }

            if (siteButtonsContainer) {
                siteButtonsContainer.innerHTML = siteButtons;
            }
            updateSelectedInfo();
        }

        // ğŸ¯ ì‚¬ì´íŠ¸ ì„ íƒ í•¨ìˆ˜
        function selectSite(site, element) {
            console.log('ğŸŒ ì‚¬ì´íŠ¸ ì„ íƒ:', site);

            // ëª¨ë“  ì‚¬ì´íŠ¸ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('#siteButtons .selection-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            element.classList.add('active');

            // í¼ì— ì‚¬ì´íŠ¸ ì •ë³´ ì„¤ì •
            const siteNameField = document.getElementById('siteName');
            if (siteNameField) {
                siteNameField.value = site;
                updateFieldColor(siteNameField);
            }

            updateSelectedInfo();
        }

        // ğŸ¯ ìœ í˜• ì„ íƒ í•¨ìˆ˜
        function selectType(type, element) {
            console.log('ğŸ“‹ ìœ í˜• ì„ íƒ:', type);

            // ëª¨ë“  ìœ í˜• ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.selection-row:nth-child(3) .selection-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            element.classList.add('active');

            // í¼ì— ìœ í˜• ì •ë³´ ì„¤ì •
            const returnTypeCodeField = document.getElementById('returnTypeCode');
            if (returnTypeCodeField) {
                returnTypeCodeField.value = type;
                updateFieldColor(returnTypeCodeField);
            }

            updateSelectedInfo();
        }

        // ğŸ¯ ì‚¬ìœ  ì„ íƒ í•¨ìˆ˜
        function selectReason(reason, element) {
            console.log('ğŸ“ ì‚¬ìœ  ì„ íƒ:', reason);

            // ëª¨ë“  ì‚¬ìœ  ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.selection-row:nth-child(4) .selection-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            element.classList.add('active');

            // í¼ì— ì‚¬ìœ  ì •ë³´ ì„¤ì •
            const returnReasonField = document.getElementById('returnReason');
            if (returnReasonField) {
                returnReasonField.value = reason;
                updateFieldColor(returnReasonField);
            }

            // ğŸ”¥ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ ì¡°ê±´ë¶€ í‘œì‹œ/ìˆ¨ê¹€
            const defectDetailGroup = document.getElementById('defectDetailGroup');
            const defectDetailField = document.getElementById('defectDetail');
            
            if (reason === 'ë¶ˆëŸ‰') {
                // ë¶ˆëŸ‰ ì‚¬ìœ  ì„ íƒ ì‹œ í•„ë“œ í‘œì‹œ ë° í•„ìˆ˜ ì„¤ì •
                defectDetailGroup.style.display = 'block';
                defectDetailField.setAttribute('required', 'required');
                defectDetailField.setAttribute('aria-required', 'true');
                
                // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                defectDetailGroup.style.opacity = '0';
                defectDetailGroup.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    defectDetailGroup.style.transition = 'all 0.3s ease';
                    defectDetailGroup.style.opacity = '1';
                    defectDetailGroup.style.transform = 'translateY(0)';
                }, 10);
                
                console.log('ğŸ”´ ë¶ˆëŸ‰ ì‚¬ìœ  ì„ íƒ: ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ í‘œì‹œ');
            } else {
                // ë‹¤ë¥¸ ì‚¬ìœ  ì„ íƒ ì‹œ í•„ë“œ ìˆ¨ê¹€ ë° í•„ìˆ˜ í•´ì œ
                defectDetailGroup.style.display = 'none';
                defectDetailField.removeAttribute('required');
                defectDetailField.removeAttribute('aria-required');
                defectDetailField.value = ''; // ë‚´ìš© ì´ˆê¸°í™”
                
                console.log('ğŸŸ¢ ë‹¤ë¥¸ ì‚¬ìœ  ì„ íƒ: ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ ìˆ¨ê¹€');
            }

            updateSelectedInfo();
        }

        // ğŸ¯ ì„ íƒ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectedInfo() {
            const siteName = document.getElementById('siteName')?.value || '';
            const returnTypeCode = document.getElementById('returnTypeCode')?.value || '';
            const returnReason = document.getElementById('returnReason')?.value || '';

            const typeDisplayMap = {
                'FULL_RETURN': 'ì „ì²´ë°˜í’ˆ',
                'FULL_EXCHANGE': 'ì „ì²´êµí™˜',
                'PARTIAL_RETURN': 'ë¶€ë¶„ë°˜í’ˆ',
                'PARTIAL_EXCHANGE': 'ë¶€ë¶„êµí™˜'
            };

            const typeDisplay = typeDisplayMap[returnTypeCode] || returnTypeCode;

            const selectedInfoElement = document.getElementById('selectedInfo');
            if (selectedInfoElement) {
                if (siteName && returnTypeCode && returnReason) {
                    selectedInfoElement.innerHTML = `âœ… ${siteName} â†’ ${typeDisplay} â†’ ${returnReason}`;
                    selectedInfoElement.style.display = 'block';
                } else {
                    selectedInfoElement.style.display = 'none';
                }
            }
        }

        // ğŸ¨ í•„ë“œ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        function updateFieldColor(field) {
            if (!field) return;

            const originalValue = field.dataset.originalValue || '';
            const currentValue = field.value || '';
            const isEditMode = serverData.isEdit;

            // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
            field.classList.remove('original-data', 'modified', 'new-data');

            if (isEditMode) {
                if (currentValue !== originalValue && currentValue !== '') {
                    field.classList.add('modified'); // ìˆ˜ì •ë¨ - ë¹¨ê°„ìƒ‰
                } else if (currentValue === originalValue && originalValue !== '') {
                    field.classList.add('original-data'); // ì›ë³¸ê°’ - ë…¹ìƒ‰
                }
            } else {
                if (currentValue !== '') {
                    field.classList.add('new-data'); // ì‹ ê·œ ì…ë ¥ - íŒŒë€ìƒ‰
                }
            }
        }

        // ğŸ¯ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”¥ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');

            // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ì›ë³¸ê°’ ì„¤ì •
            if (serverData.isEdit) {
                console.log('ğŸ”§ ìˆ˜ì • ëª¨ë“œ - ì›ë³¸ê°’ ì„¤ì •');
                Object.keys(serverData).forEach(key => {
                    const field = document.getElementById(key);
                    const value = serverData[key];
                    
                    if (field && value !== null && value !== undefined && value !== '') {
                        field.dataset.originalValue = value;
                        field.value = value;
                        updateFieldColor(field);
                    }
                });
            }

            // CS ì ‘ìˆ˜ì¼ ìë™ ì„¤ì • (ë“±ë¡ ëª¨ë“œ)
            if (!serverData.isEdit) {
                const csReceivedDateField = document.getElementById('csReceivedDate');
                if (csReceivedDateField && !csReceivedDateField.value) {
                    const today = new Date();
                    const todayString = today.getFullYear() + '-' +
                        String(today.getMonth() + 1).padStart(2, '0') + '-' +
                        String(today.getDate()).padStart(2, '0');
                    csReceivedDateField.value = todayString;
                    updateFieldColor(csReceivedDateField);
                }
            }

            // ëª¨ë“  ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const allFields = document.querySelectorAll('input, select, textarea');
            allFields.forEach(field => {
                ['input', 'change'].forEach(eventType => {
                    field.addEventListener(eventType, function() {
                        setTimeout(() => updateFieldColor(this), 100);
                    });
                });
            });

            // ğŸ”¥ ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ ì´ˆê¸° í‘œì‹œ ì²˜ë¦¬
            if (serverData.isEdit && serverData.returnReason === 'ë¶ˆëŸ‰') {
                const defectDetailGroup = document.getElementById('defectDetailGroup');
                const defectDetailField = document.getElementById('defectDetail');
                
                if (defectDetailGroup && defectDetailField) {
                    defectDetailGroup.style.display = 'block';
                    defectDetailField.setAttribute('required', 'required');
                    defectDetailField.setAttribute('aria-required', 'true');
                    console.log('ğŸ”§ ìˆ˜ì • ëª¨ë“œ: ë¶ˆëŸ‰ ì‚¬ìœ ë¡œ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ í‘œì‹œ');
                }
            }
        });

        // ğŸ¯ í¼ ì œì¶œ ì „ ê²€ì¦
        function validateForm() {
            const requiredFields = [
                'siteName', 'returnTypeCode', 'returnReason', 'orderNumber', 
                'customerName', 'customerPhone', 'orderItemCode', 'productColor', 
                'productSize', 'quantity', 'csReceivedDate'
            ];

            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    alert(`${field?.labels?.[0]?.textContent || fieldId} í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    field?.focus();
                    return false;
                }
            }

            // ğŸ”¥ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ ì¶”ê°€ ê²€ì¦
            const returnReason = document.getElementById('returnReason')?.value;
            const defectDetailField = document.getElementById('defectDetail');
            
            if (returnReason === 'ë¶ˆëŸ‰' && (!defectDetailField.value || !defectDetailField.value.trim())) {
                alert('ë¶ˆëŸ‰ ì‚¬ìœ  ì„ íƒ ì‹œ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                defectDetailField.focus();
                return false;
            }

            return true;
        }

        // ğŸ¯ í¼ ì œì¶œ
        function submitForm() {
            if (!validateForm()) {
                return false;
            }

            const form = document.getElementById('exchangeForm');
            if (form) {
                form.submit();
            }
        }
    </script>
</head>

<div layout:fragment="content">
    <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
        <div class="d-flex flex-column flex-column-fluid">
            <!--begin::Toolbar-->
            <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
                <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                    <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                        <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0" 
                            th:text="${isEdit ? 'êµí™˜/ë°˜í’ˆ ìˆ˜ì •' : 'êµí™˜/ë°˜í’ˆ ë“±ë¡'}">êµí™˜/ë°˜í’ˆ ë“±ë¡</h1>
                        <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                            <li class="breadcrumb-item text-muted">
                                <a href="/main" class="text-muted text-hover-primary">Home</a>
                            </li>
                            <li class="breadcrumb-item">
                                <span class="bullet bg-gray-500 w-5px h-2px"></span>
                            </li>
                            <li class="breadcrumb-item text-muted">êµí™˜/ë°˜í’ˆ ê´€ë¦¬</li>
                            <li class="breadcrumb-item">
                                <span class="bullet bg-gray-500 w-5px h-2px"></span>
                            </li>
                            <li class="breadcrumb-item text-muted" 
                                th:text="${isEdit ? 'ìˆ˜ì •' : 'ë“±ë¡'}">ë“±ë¡</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!--end::Toolbar-->

            <!--begin::Content-->
            <div id="kt_app_content" class="app-content flex-column-fluid">
                <div id="kt_app_content_container" class="app-container container-fluid">
                    
                    <div class="form-container">
                        <div class="page-header">
                            <h2 th:text="${isEdit ? 'êµí™˜/ë°˜í’ˆ ìˆ˜ì •' : 'êµí™˜/ë°˜í’ˆ ë“±ë¡'}">êµí™˜/ë°˜í’ˆ ë“±ë¡</h2>
                            <p th:text="${isEdit ? 'ê¸°ì¡´ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ì„¸ìš”' : 'ë¸Œëœë“œ, ì‚¬ì´íŠ¸, ìœ í˜•ì„ ì„ íƒí•œ í›„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”'}">ë¸Œëœë“œ, ì‚¬ì´íŠ¸, ìœ í˜•ì„ ì„ íƒí•œ í›„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>

                        <!-- ğŸ¯ ìƒë‹¨ ì„ íƒ ë²„íŠ¼ë“¤ -->
                        <div class="top-selections">
                            <div class="selection-row">
                                <div class="selection-label">ë¸Œëœë“œ:</div>
                                <div class="selection-buttons">
                                    <div class="selection-btn" onclick="selectBrand('ë ˆë…¸ë§ˆ', this)">ë ˆë…¸ë§ˆ</div>
                                    <div class="selection-btn" onclick="selectBrand('ì½”ë„ë¦¬í¬', this)">ì½”ë„ë¦¬í¬</div>
                                </div>
                            </div>

                            <div class="selection-row">
                                <div class="selection-label">ì‚¬ì´íŠ¸:</div>
                                <div class="selection-buttons" id="siteButtons">
                                    <!-- ì‚¬ì´íŠ¸ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>

                            <div class="selection-row">
                                <div class="selection-label">ìœ í˜•:</div>
                                <div class="selection-buttons">
                                    <div class="selection-btn" onclick="selectType('FULL_RETURN', this)">ì „ì²´ë°˜í’ˆ</div>
                                    <div class="selection-btn" onclick="selectType('PARTIAL_RETURN', this)">ë¶€ë¶„ë°˜í’ˆ</div>
                                    <div class="selection-btn" onclick="selectType('FULL_EXCHANGE', this)">ì „ì²´êµí™˜</div>
                                    <div class="selection-btn" onclick="selectType('PARTIAL_EXCHANGE', this)">ë¶€ë¶„êµí™˜</div>
                                </div>
                            </div>

                            <div class="selection-row">
                                <div class="selection-label">ì‚¬ìœ :</div>
                                <div class="selection-buttons">
                                    <div class="selection-btn" onclick="selectReason('ê³ ê°ë³€ì‹¬', this)">ê³ ê°ë³€ì‹¬</div>
                                    <div class="selection-btn" onclick="selectReason('ë¶ˆëŸ‰', this)">ë¶ˆëŸ‰</div>
                                    <div class="selection-btn" onclick="selectReason('ì˜¤ë°°ì†¡', this)">ì˜¤ë°°ì†¡</div>
                                    <div class="selection-btn" onclick="selectReason('ê¸°íƒ€', this)">ê¸°íƒ€</div>
                                </div>
                            </div>
                        </div>

                        <!-- ì„ íƒ ì •ë³´ í‘œì‹œ -->
                        <div id="selectedInfo" class="selected-info" style="display: none;"></div>

                        <!-- ğŸ¯ ë©”ì¸ í¼ -->
                        <form id="exchangeForm" th:action="@{/exchange/save}" method="post" enctype="multipart/form-data" th:object="${returnItem}">
                            <!-- Hidden í•„ë“œë“¤ -->
                            <div class="hidden-fields">
                                <input type="hidden" th:if="${isEdit}" th:field="*{id}" />
                                <input type="hidden" id="siteName" name="siteName" th:field="*{siteName}" />
                                <input type="hidden" id="returnTypeCode" name="returnTypeCode" th:field="*{returnTypeCode}" />
                                <input type="hidden" id="returnReason" name="returnReason" th:field="*{returnReason}" />
                            </div>

                            <!-- ì£¼ë¬¸ ì •ë³´ -->
                            <div class="form-card">
                                <div class="form-section-header">ğŸ“¦ ì£¼ë¬¸ ì •ë³´</div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="orderDate">ì£¼ë¬¸ì¼</label>
                                        <input type="date" id="orderDate" name="orderDate" class="form-control" th:field="*{orderDate}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="csReceivedDate" class="required">CSì ‘ìˆ˜ì¼</label>
                                        <input type="date" id="csReceivedDate" name="csReceivedDate" class="form-control" th:field="*{csReceivedDate}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="orderNumber" class="required">ì£¼ë¬¸ë²ˆí˜¸</label>
                                        <input type="text" id="orderNumber" name="orderNumber" class="form-control" th:field="*{orderNumber}" placeholder="20250426-0001236-03" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="orderItemCode" class="required">ì£¼ë¬¸í’ˆë²ˆ</label>
                                        <input type="text" id="orderItemCode" name="orderItemCode" class="form-control" th:field="*{orderItemCode}" placeholder="RN-GSZD962" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="productColor" class="required">ìƒ‰ìƒ</label>
                                        <input type="text" id="productColor" name="productColor" class="form-control" th:field="*{productColor}" placeholder="PK" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="productSize" class="required">ì‚¬ì´ì¦ˆ</label>
                                        <input type="text" id="productSize" name="productSize" class="form-control" th:field="*{productSize}" placeholder="75" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="quantity" class="required">ìˆ˜ëŸ‰</label>
                                        <input type="number" id="quantity" name="quantity" class="form-control" th:field="*{quantity}" min="1" value="1" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="refundAmount">í™˜ë¶ˆê¸ˆì•¡</label>
                                        <input type="number" id="refundAmount" name="refundAmount" class="form-control" th:field="*{refundAmount}" placeholder="39200">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="shippingFee">ë°°ì†¡ë¹„</label>
                                        <select id="shippingFee" name="shippingFee" class="form-control" th:field="*{shippingFee}">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="6000">6000ì°¨ê°</option>
                                            <option value="3000">3000ì°¨ê°</option>
                                            <option value="0">ë¬´ìƒ</option>
                                            <option value="6350">6350ì°¨ê°</option>
                                            <option value="3350">3350ì°¨ê°</option>
                                            <option value="ì…ê¸ˆì˜ˆì •">ì…ê¸ˆì˜ˆì •</option>
                                            <option value="ê¸°íƒ€ë¬¸ì˜">ê¸°íƒ€ë¬¸ì˜</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ê³ ê° ì •ë³´ -->
                            <div class="form-card">
                                <div class="form-section-header">ğŸ‘¤ ê³ ê° ì •ë³´</div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="customerName" class="required">ê³ ê°ëª… (ìˆ˜ì·¨ì¸)</label>
                                        <input type="text" id="customerName" name="customerName" class="form-control" th:field="*{customerName}" placeholder="ê¹€ë¯¼ì§€" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="customerPhone" class="required">ì—°ë½ì²˜</label>
                                        <input type="tel" id="customerPhone" name="customerPhone" class="form-control" th:field="*{customerPhone}" placeholder="010-1234-5678" required>
                                    </div>
                                </div>
                            </div>

                            <!-- ì²˜ë¦¬ ì •ë³´ -->
                            <div class="form-card">
                                <div class="form-section-header">âš™ï¸ ì²˜ë¦¬ ì •ë³´</div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="trackingNumber">ìš´ì†¡ì¥ë²ˆí˜¸</label>
                                        <input type="text" id="trackingNumber" name="trackingNumber" class="form-control" th:field="*{trackingNumber}" placeholder="5738757014">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="collectionCompletedDate">íšŒìˆ˜ì™„ë£Œì¼</label>
                                        <input type="date" id="collectionCompletedDate" name="collectionCompletedDate" class="form-control" th:field="*{collectionCompletedDate}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="logisticsConfirmedDate">ë¬¼ë¥˜í™•ì¸ì¼</label>
                                        <input type="date" id="logisticsConfirmedDate" name="logisticsConfirmedDate" class="form-control" th:field="*{logisticsConfirmedDate}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="shippingDate">ì¶œê³ ì¼ì</label>
                                        <input type="date" id="shippingDate" name="shippingDate" class="form-control" th:field="*{shippingDate}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="refundDate">í™˜ë¶ˆì¼ì</label>
                                        <input type="date" id="refundDate" name="refundDate" class="form-control" th:field="*{refundDate}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="isCompleted">ì™„ë£Œ ì²˜ë¦¬</label>
                                        <select id="isCompleted" name="isCompleted" class="form-control" th:field="*{isCompleted}">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="true">ì™„ë£Œ</option>
                                            <option value="false">ë¯¸ì™„ë£Œ</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="processor">ì²˜ë¦¬ì</label>
                                        <input type="text" id="processor" name="processor" class="form-control" th:field="*{processor}" placeholder="ë‹´ë‹¹ìëª…">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="remarks">ë¹„ê³ </label>
                                        <textarea id="remarks" name="remarks" class="form-control" th:field="*{remarks}" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨ì‚¬í•­"></textarea>
                                    </div>
                                    
                                    <!-- ğŸ”¥ ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨ í•„ë“œ -->
                                    <div class="form-group" id="defectDetailGroup" style="display: none;">
                                        <label for="defectDetail" class="required text-danger">ë¶ˆëŸ‰ìƒì„¸ë©”ëª¨</label>
                                        <textarea id="defectDetail" name="defectDetail" class="form-control border-danger" 
                                                  th:field="*{defectDetail}" 
                                                  rows="4" 
                                                  maxlength="500" 
                                                  placeholder="ë¶ˆëŸ‰ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”... (ì˜ˆ: ì§€í¼ ê³ ì¥, ìƒ‰ìƒ ë¶ˆì¼ì¹˜, ì¬ë´‰ì„  í’€ë¦¼ ë“±)"></textarea>
                                        <small class="text-danger">âš ï¸ ë¶ˆëŸ‰ ì‚¬ìœ  ì„ íƒ ì‹œ í•„ìˆ˜ ì…ë ¥ (ìµœëŒ€ 500ì)</small>
                                        <div class="mt-1">
                                            <span class="badge bg-warning text-dark">ğŸ’¡ Tip</span>
                                            <small class="text-muted ml-1">êµ¬ì²´ì ì¸ ë¶ˆëŸ‰ ë‚´ìš©ì„ ê¸°ë¡í•˜ë©´ ì²˜ë¦¬ ì‹œ ë„ì›€ì´ ë©ë‹ˆë‹¤</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ì´ë¯¸ì§€ ì²¨ë¶€ -->
                            <div class="form-card">
                                <div class="form-section-header">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²¨ë¶€</div>
                                <div class="form-group">
                                    <label for="attachmentPhoto">ì´ë¯¸ì§€ íŒŒì¼</label>
                                    <input type="file" id="attachmentPhoto" name="attachmentPhoto" class="form-control" accept="image/*">
                                    <small class="text-muted">ê´€ë ¨ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)</small>
                                    
                                    <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ (ìˆ˜ì • ëª¨ë“œ) -->
                                    <div th:if="${isEdit and returnItem.defectPhotoUrl != null and !#strings.isEmpty(returnItem.defectPhotoUrl)}" class="mt-3">
                                        <p class="text-primary"><strong>í˜„ì¬ ë“±ë¡ëœ ì´ë¯¸ì§€:</strong></p>
                                        <img th:src="@{|http://175.119.224.45:8080/uploads/${returnItem.defectPhotoUrl}|}" class="image-preview" alt="í˜„ì¬ ì´ë¯¸ì§€" 
                                             onerror="this.onerror=null; this.src='/uploads/' + '${returnItem.defectPhotoUrl}'; console.error('ì™¸ë¶€ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ê²½ë¡œë¡œ ì‹œë„:', this.src);"
                                             onclick="window.open(this.src, '_blank')" style="cursor: pointer;">
                                        <br><small class="text-muted">ìƒˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ê°€ êµì²´ë©ë‹ˆë‹¤. (í´ë¦­í•˜ë©´ ì›ë³¸ í¬ê¸°ë¡œ ë³´ê¸°)</small>
                                        
                                        <!-- ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë§í¬ ì¶”ê°€ -->
                                        <div class="mt-2">
                                            <a th:href="@{|http://175.119.224.45:8080/uploads/${returnItem.defectPhotoUrl}|}" 
                                               class="btn btn-sm btn-light-primary" 
                                               download th:download="${returnItem.defectPhotoUrl}" 
                                               target="_blank">
                                                ğŸ“· ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                            <div class="form-actions">
                                <div>
                                    <a href="/exchange/list" class="btn btn-secondary">
                                        â† ëª©ë¡ìœ¼ë¡œ
                                    </a>
                                </div>
                                
                                <div>
                                    <button type="button" class="btn btn-primary" onclick="submitForm()">
                                        ğŸ’¾ <span th:text="${isEdit ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡ ì™„ë£Œ'}">ë“±ë¡ ì™„ë£Œ</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
            <!--end::Content-->
        </div>
    </div>
</div>
</html> 