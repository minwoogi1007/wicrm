<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/default}">
<head>
    <title>ë°°ì†¡ë¹„ ì…ê¸ˆ ë§¤í•‘ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- JavaScript ì‹¤í–‰ í™•ì¸ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // console.log('ğŸ”¥ HEAD ì„¹ì…˜ì—ì„œ ì‹¤í–‰ë¨');
    </script>

    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #eef2ff;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --warning-color: #f72585;
            --success-color: #35b27f;
            --danger-color: #ff4d6d;
            --info-color: #4a6fff;
            --dark-color: #1e2a3b;
            --text-color: #2d3748;
            --text-muted: #718096;
            --bg-color: #f8fafc;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s ease;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 100%;
            margin: 0;
            padding: 1rem;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-lg);
            padding: 1rem;
            color: white;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(30deg);
        }

        .dashboard-header h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .dashboard-header p {
            margin: 0.25rem 0 0;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
        }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-card h3 {
            margin: 0 0 0.25rem 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--dark-color);
        }

        .stat-card.primary .value { color: var(--primary-color); }
        .stat-card.success .value { color: var(--success-color); }
        .stat-card.warning .value { color: var(--warning-color); }
        .stat-card.info .value { color: var(--info-color); }

        /* ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            align-items: start;
        }

        /* ì…ê¸ˆ ë‚´ì—­ ì„¹ì…˜ */
        .payments-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #2a9d6f;
            transform: translateY(-1px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e91e63;
            transform: translateY(-1px);
        }

        /* ì…ê¸ˆ ë‚´ì—­ í…Œì´ë¸” */
        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payments-table th,
        .payments-table td {
            padding: 0.5rem 0.25rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .payments-table th {
            background-color: var(--bg-color);
            font-weight: 600;
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .payments-table tbody tr {
            transition: var(--transition);
            cursor: pointer;
        }

        .payments-table tbody tr:hover {
            background-color: var(--primary-light);
        }

        .payments-table tbody tr.selected {
            background-color: var(--primary-light);
            border-left: 3px solid var(--primary-color);
        }

        /* í›„ë³´ ì„¹ì…˜ */
        .candidates-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: sticky;
            top: 1rem;
        }

        .candidate-card {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .candidate-card:hover {
            background-color: var(--bg-color);
        }

        .candidate-card:last-child {
            border-bottom: none;
        }

        .candidate-card.selected {
            background-color: var(--primary-light);
            border-left: 3px solid var(--primary-color);
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .candidate-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .match-score {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .match-score.high {
            background-color: rgba(53, 178, 127, 0.1);
            color: var(--success-color);
        }

        .match-score.medium {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }

        .match-score.low {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning-color);
        }

        .candidate-details {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .candidate-details div {
            margin-bottom: 0.15rem;
        }

        /* ë§¤í•‘ ì•¡ì…˜ */
        .mapping-actions {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-color);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .mapping-actions .btn {
            width: 100%;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        /* ìµœê·¼ ë§¤í•‘ ë‚´ì—­ */
        .recent-mappings {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-top: 2rem;
        }

        .mapping-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mapping-item:last-child {
            border-bottom: none;
        }

        .mapping-info {
            flex: 1;
        }

        .mapping-customer {
            font-weight: 600;
            color: var(--dark-color);
        }

        .mapping-details {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .mapping-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(53, 178, 127, 0.1);
            color: var(--success-color);
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .loading::before {
            content: '';
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        .btn-success:hover {
            background: #059669 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-outline-danger:hover {
            background: #ef4444 !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .candidates-section {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-container {
                padding: 0.5rem;
            }
            
            .payments-table {
                font-size: 0.75rem;
            }
            
            .payments-table th,
            .payments-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="dashboard-container">
            <!-- í—¤ë” -->
            <div class="dashboard-header">
                <h1>ğŸ¯ ë°°ì†¡ë¹„ ì…ê¸ˆ ë§¤í•‘ ëŒ€ì‹œë³´ë“œ</h1>
                <p>ğŸ’¡ í†µì¥ ì…ê¸ˆ ë‚´ì—­ â†’ êµí™˜/ë°˜í’ˆ í›„ë³´ í™•ì¸ â†’ ìˆ˜ë™ ë§¤í•‘ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì²˜ë¦¬í•˜ì„¸ìš”<br/>
                âš ï¸ ìë™ ë§¤í•‘ì€ í˜„ì‹¤ì  ì œì•½ìœ¼ë¡œ ì¸í•´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤ (ë™ëª…ì´ì¸, ëŒ€ë¦¬ì…ê¸ˆ, ì—°ë½ì²˜ ë¶€ì¬ ë“±)</p>
            </div>
            
            <!-- ì„±ê³µ ë©”ì‹œì§€ -->
            <div th:if="${successMessage}" class="alert alert-success" style="background: #d1fae5; color: #065f46; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid #a7f3d0; font-size: 0.9rem;">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${successMessage}">ì„±ê³µ ë©”ì‹œì§€</span>
            </div>
            
            <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <h3>ì´ ì…ê¸ˆ ë‚´ì—­</h3>
                    <p class="value" th:text="${stats?.totalPayments ?: 0}">0</p>
                </div>
                <div class="stat-card warning">
                    <h3>ë¯¸ë§¤í•‘ ê±´ìˆ˜</h3>
                    <p class="value" th:text="${stats?.pendingPayments ?: 0}">0</p>
                </div>
                <div class="stat-card success">
                    <h3>ë§¤í•‘ ì™„ë£Œ</h3>
                    <p class="value" th:text="${stats?.mappedPayments ?: 0}">0</p>
                </div>
                <div class="stat-card info">
                    <h3>ì˜¤ëŠ˜ ë§¤í•‘</h3>
                    <p class="value" th:text="${stats?.todayMapped ?: 0}">0</p>
                </div>
            </div>
            
            <!-- ì…ê¸ˆ ë‚´ì—­ í•„í„° ì„¹ì…˜ -->
            <div class="payments-section" style="margin-bottom: 1rem;">
                <div class="section-header">
                    <h2>ğŸ” ì…ê¸ˆ ë‚´ì—­ í•„í„°</h2>
                    <div>
                        <a href="/shipping-payment/register" class="btn btn-primary">
                            â• ì…ê¸ˆ ë“±ë¡
                        </a>
                        <button class="btn btn-primary" id="refreshBtn">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
                
                <div style="padding: 0.75rem 1rem;">
                    <div class="filter-buttons" style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                        <button class="btn" id="filterAll" style="padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; background: var(--primary-color); color: white;">
                            ğŸ“‹ ì „ì²´
                        </button>
                        <button class="btn" id="filterUnmapped" style="padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; background: white; color: var(--text-muted);">
                            â³ ë¯¸ë§¤í•‘
                        </button>
                        <button class="btn" id="filterMapped" style="padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; background: white; color: var(--text-muted);">
                            âœ… ë§¤í•‘ì™„ë£Œ
                        </button>
                        <button class="btn" id="filterRenoma" style="padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; background: white; color: var(--text-muted);">
                            ğŸ’ ë ˆë…¸ë§ˆ
                        </button>
                        <button class="btn" id="filterCoralik" style="padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; background: white; color: var(--text-muted);">
                            ğŸ’– ì½”ë„ë¦¬í¬
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <input type="text" id="searchCustomerName" class="form-control" placeholder="ê³ ê°ëª… ê²€ìƒ‰" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                        <input type="number" id="searchAmount" class="form-control" placeholder="ì…ê¸ˆê¸ˆì•¡ ê²€ìƒ‰" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                        <input type="text" id="searchSiteName" class="form-control" placeholder="ì‚¬ì´íŠ¸ëª… ê²€ìƒ‰" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                        <button class="btn btn-primary" id="searchBtn" style="padding: 0.5rem 1rem;">
                            ğŸ” ê²€ìƒ‰
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
            <div class="main-grid">
                <!-- ì…ê¸ˆ ë‚´ì—­ ì„¹ì…˜ -->
                <div class="payments-section">
                    <div class="section-header">
                        <h2>ğŸ’° ì…ê¸ˆ ë‚´ì—­</h2>
                        <div>
                            <button class="btn btn-success" disabled style="opacity: 0.5; cursor: not-allowed;" title="í†µì¥ ì…ê¸ˆ ë‚´ì—­ë§Œìœ¼ë¡œëŠ” ì •í™•í•œ ìë™ ë§¤í•‘ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤" id="autoMappingBtn">
                                ğŸ¤– ìë™ ë§¤í•‘ (ë¹„í™œì„±í™”)
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="payments-table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">ì…ê¸ˆìëª…</th>
                                    <th style="width: 60px;">ì—°ë½ì²˜</th>
                                    <th style="width: 80px;">ê¸ˆì•¡</th>
                                    <th style="width: 60px;">ì…ê¸ˆì¼</th>
                                    <th style="width: 60px;">ë¸Œëœë“œ</th>
                                    <th style="width: 120px;">ì‚¬ì´íŠ¸</th>
                                    <th style="width: 60px;">ìƒíƒœ</th>
                                    <th style="width: 50px;">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr th:each="payment : ${allPayments}" 
                                    th:attr="data-payment-id=${payment.registerId},data-mapping-status=${payment.mappingStatus}"
                                    style="cursor: pointer;">
                                    <td class="candidate-name" th:text="${payment.customerName}">ê¹€ë¯¼ìˆ˜</td>
                                    <td th:text="${payment.customerPhone != null and payment.customerPhone.length() > 8 ? payment.customerPhone.substring(payment.customerPhone.length() - 4) : payment.customerPhone ?: ''}">5678</td>
                                    <td style="text-align: right; font-weight: 600;" 
                                        th:text="${payment.amount != null ? #numbers.formatInteger(payment.amount, 0, 'COMMA') + 'ì›' : ''}">3,000ì›</td>
                                    <td th:text="${payment.paymentDate != null ? #temporals.format(payment.paymentDate, 'MM-dd') : ''}">12-25</td>
                                    <td>
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.75rem; font-weight: 600; color: white;"
                                              th:style="${payment.brand == 'RENOMA'} ? 'background-color: #059669;' : 'background-color: #dc2626;'"
                                              th:text="${payment.brand == 'RENOMA'} ? 'ë ˆë…¸ë§ˆ' : 'ì½”ë„ë¦¬í¬'">ë ˆë…¸ë§ˆ</span>
                                    </td>
                                    <td th:text="${payment.siteName ?: ''}">ìì‚¬ëª°-ë ˆë…¸ë§ˆ</td>
                                    <td>
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.75rem; font-weight: 600;"
                                              th:style="${payment.mappingStatus == 'MAPPED'} ? 'background-color: #d1fae5; color: #065f46;' : 'background-color: #fef3c7; color: #92400e;'"
                                              th:text="${payment.mappingStatus == 'MAPPED'} ? 'ë§¤í•‘ì™„ë£Œ' : 'ë¯¸ë§¤í•‘'">ë¯¸ë§¤í•‘</span>
                                    </td>
                                    <td>
                                        <button th:if="${payment.mappingStatus == 'PENDING'}" 
                                                class="btn btn-success" 
                                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #10b981; border: none; color: white; border-radius: 4px;"
                                                th:onclick="'selectPayment(' + ${payment.registerId} + ')'"
                                                onclick="event.stopPropagation();"
                                                title="ë§¤í•‘ ì‹¤í–‰">
                                            âœ… ë§¤í•‘
                                        </button>
                                        <button th:if="${payment.mappingStatus == 'MAPPED'}" 
                                                class="btn btn-outline-danger" 
                                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px;"
                                                th:onclick="'cancelMapping(' + ${payment.registerId} + ')'"
                                                onclick="event.stopPropagation();"
                                                title="ë§¤í•‘ ì·¨ì†Œ">
                                            ğŸ—‘ï¸ ì·¨ì†Œ
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${allPayments == null or allPayments.empty}">
                                    <td colspan="8" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                        ë“±ë¡ëœ ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- í›„ë³´ ì„¹ì…˜ -->
                <div class="candidates-section">
                    <div class="section-header">
                        <h2>ğŸ” êµí™˜/ë°˜í’ˆ í›„ë³´</h2>
                    </div>
                    
                    <!-- í›„ë³´ ê²€ìƒ‰ -->
                    <div id="candidatesSearchContainer" style="display: none; padding: 0.75rem 1rem; background: #f8fafc; border-bottom: 1px solid var(--border-color);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; align-items: center;">
                            <input type="text" id="candidateSearchName" class="form-control" placeholder="ê³ ê°ëª… ê²€ìƒ‰" 
                                   style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 0.9rem;">
                            <input type="text" id="candidateSearchOrder" class="form-control" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰" 
                                   style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 0.9rem;">
                            <button class="btn btn-primary" id="candidateSearchBtn" 
                                    style="padding: 0.5rem 1rem; font-size: 0.9rem; white-space: nowrap;">
                                ğŸ” ê²€ìƒ‰
                            </button>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            ğŸ’¡ í›„ë³´ê°€ ë§ì„ ë•Œ ì´ë¦„ì´ë‚˜ ì£¼ë¬¸ë²ˆí˜¸ë¡œ í•„í„°ë§í•˜ì„¸ìš”
                        </div>
                    </div>
                    
                    <div id="candidatesContainer" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading" style="display: none;" id="candidatesLoading">
                            í›„ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                        </div>
                        
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.8rem;" id="candidatesEmpty">
                            ì…ê¸ˆ ë‚´ì—­ì„ ì„ íƒí•˜ë©´ ë§¤ì¹­ ê°€ëŠ¥í•œ êµí™˜/ë°˜í’ˆ í›„ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                        
                        <div id="candidatesList" style="display: none;">
                            <!-- í›„ë³´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    
                    <div class="mapping-actions" id="mappingActions" style="display: none;">
                        <button class="btn btn-primary" id="executeMappingBtn">
                            âœ… ë§¤í•‘ ì‹¤í–‰
                        </button>
                        <button class="btn btn-warning" id="cancelSelectionBtn">
                            âŒ ì„ íƒ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ìµœê·¼ ë§¤í•‘ ë‚´ì—­ (ì»´íŒ©íŠ¸) -->
            <div class="recent-mappings" th:if="${recentMappings != null and !recentMappings.empty}" style="margin-top: 1rem;">
                <div class="section-header" style="padding: 0.75rem 1rem;">
                    <h2 style="font-size: 1rem; margin: 0;">ğŸ“‹ ìµœê·¼ ë§¤í•‘ ë‚´ì—­</h2>
                    <small style="color: var(--text-muted);">ìµœê·¼ 3ê±´</small>
                </div>
                
                <div style="max-height: 150px; overflow-y: auto;">
                    <div th:each="mapping, iterStat : ${recentMappings}" 
                         th:if="${iterStat.index < 3}"
                         class="mapping-item" 
                         style="padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-color);">
                        <div class="mapping-info">
                            <div class="mapping-customer" 
                                 style="font-size: 0.8rem; font-weight: 600;"
                                 th:text="${mapping.payment?.customerName + ' â†’ ' + mapping.returnItem?.customerName}">
                                ê¹€ë¯¼ìˆ˜ â†’ ê¹€ë¯¼ìˆ˜
                            </div>
                            <div class="mapping-details" style="font-size: 0.7rem; margin-top: 0.25rem;">
                                <span th:text="${mapping.payment?.amount != null ? #numbers.formatInteger(mapping.payment.amount, 0, 'COMMA') + 'ì›' : ''}">3,000ì›</span>
                                <span th:text="' | ' + ${mapping.returnItem?.orderNumber}"> | 20250101-0001</span>
                                <span th:if="${mapping.canShipExchange}" style="color: var(--success-color); font-weight: 600;"> | ğŸššì¶œê³ ê°€ëŠ¥</span>
                            </div>
                        </div>
                        <div class="mapping-status" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">ì™„ë£Œ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="script">
    <script>
        // console.log('ğŸ”¥ JavaScript íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        // console.log('ğŸ”¥ í˜„ì¬ ì‹œê°„:', new Date());

        // ì „ì—­ ë³€ìˆ˜
        let selectedPaymentId = null;
        let selectedCandidateId = null;
        let currentPaymentData = null;
        let currentCandidates = [];
        let originalCandidates = []; // ì›ë³¸ í›„ë³´ ë°ì´í„° (ê²€ìƒ‰ìš©)
        let allPaymentsData = []; // ì „ì²´ ì…ê¸ˆ ë°ì´í„°
        let currentFilter = 'all'; // í˜„ì¬ í•„í„° ìƒíƒœ
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // console.log('ï¿½ï¿½ DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ!');
            // console.log('ë§¤í•‘ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”');
            // console.log('selectPayment í•¨ìˆ˜ ì •ì˜ë¨:', typeof selectPayment);
            
            // ğŸš¨ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸
            // console.log('ğŸ”¥ DOMì´ ì™„ì „íˆ ë¡œë“œë¨');
            // console.log('ğŸ”¥ í˜„ì¬ URL:', window.location.href);
            
            // ì´ˆê¸° ë°ì´í„° ìˆ˜ì§‘
            collectPaymentsData();
            
            // í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ì•ˆì „ì„± ê²€ì‚¬ ê°•í™”
            const paymentTable = document.getElementById('paymentsTableBody');
            // console.log('paymentTable ì°¾ê¸°:', paymentTable);
            
            if (paymentTable) {
                // console.log('í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
                paymentTable.addEventListener('click', function(e) {
                    try {
                        // ë²„íŠ¼ í´ë¦­ì€ í–‰ ì„ íƒìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                            return;
                        }
                        
                        // console.log('í…Œì´ë¸” í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ:', e.target);
                        const row = e.target.closest('tr');
                        // console.log('ê°€ì¥ ê°€ê¹Œìš´ í–‰:', row);
                        // console.log('í–‰ì˜ data-payment-id:', row ? row.dataset.paymentId : 'null');
                        
                        if (row && row.dataset.paymentId && row.dataset.mappingStatus === 'PENDING') {
                            // console.log('selectPayment í˜¸ì¶œ ì‹œë„:', row.dataset.paymentId);
                            selectPayment(parseInt(row.dataset.paymentId));
                        } else {
                            // console.log('âš ï¸ í–‰ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ë§¤í•‘ëœ ìƒíƒœì„. mappingStatus:', row ? row.dataset.mappingStatus : 'null');
                        }
                    } catch (error) {
                        // console.error('í…Œì´ë¸” í´ë¦­ ì´ë²¤íŠ¸ ì˜¤ë¥˜:', error);
                    }
                });
            } else {
                // console.error('âŒ paymentsTableBodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ì•ˆì „ì„± ê²€ì‚¬ ê°•í™”
            try {
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', refreshData);
                    // console.log('âœ… refreshBtn ì´ë²¤íŠ¸ ë“±ë¡ë¨');
                }
                
                const autoMappingBtn = document.getElementById('autoMappingBtn');
                if (autoMappingBtn) {
                    autoMappingBtn.addEventListener('click', executeAutoMapping);
                    // console.log('âœ… autoMappingBtn ì´ë²¤íŠ¸ ë“±ë¡ë¨');
                }
                
                const executeMappingBtn = document.getElementById('executeMappingBtn');
                if (executeMappingBtn) {
                    executeMappingBtn.addEventListener('click', executeMapping);
                    // console.log('âœ… executeMappingBtn ì´ë²¤íŠ¸ ë“±ë¡ë¨');
                }
                
                const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');
                if (cancelSelectionBtn) {
                    cancelSelectionBtn.addEventListener('click', cancelSelection);
                    // console.log('âœ… cancelSelectionBtn ì´ë²¤íŠ¸ ë“±ë¡ë¨');
                }
                
                // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const filterButtons = ['filterAll', 'filterUnmapped', 'filterMapped', 'filterRenoma', 'filterCoralik'];
                filterButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.addEventListener('click', () => applyFilter(btnId.replace('filter', '').toLowerCase()));
                    }
                });
                
                // ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', performSearch);
                }
                
                // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
                ['searchCustomerName', 'searchAmount', 'searchSiteName'].forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                performSearch();
                            }
                        });
                    }
                });
                
                // í›„ë³´ ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const candidateSearchBtn = document.getElementById('candidateSearchBtn');
                if (candidateSearchBtn) {
                    candidateSearchBtn.addEventListener('click', performCandidateSearch);
                }
                
                // í›„ë³´ ê²€ìƒ‰ ì—”í„°í‚¤ ì´ë²¤íŠ¸
                ['candidateSearchName', 'candidateSearchOrder'].forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                performCandidateSearch();
                            }
                        });
                    }
                });
                
            } catch (error) {
                // console.error('ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì˜¤ë¥˜:', error);
            }
            
            // í†µê³„ ìƒˆë¡œê³ ì¹¨ (5ë¶„ë§ˆë‹¤)
            setInterval(refreshStats, 5 * 60 * 1000);
        });
        
        // ì…ê¸ˆ ë‚´ì—­ ì„ íƒ
        function selectPayment(paymentId) {
            // console.log('âœ… selectPayment í•¨ìˆ˜ í˜¸ì¶œë¨! paymentId:', paymentId);
            
            // ì´ì „ ì„ íƒ í•´ì œ
            const allRows = document.querySelectorAll('.payments-table tbody tr');
            // console.log('ê¸°ì¡´ ì„ íƒ í•´ì œí•  í–‰ ê°œìˆ˜:', allRows.length);
            allRows.forEach(row => {
                row.classList.remove('selected');
            });
            
            // ìƒˆ ì„ íƒ í‘œì‹œ
            const selectedRow = document.querySelector(`tr[data-payment-id="${paymentId}"]`);
            // console.log('ì„ íƒí•  í–‰ ì°¾ê¸°:', selectedRow);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                // console.log('âœ… í–‰ ì„ íƒ í‘œì‹œ ì™„ë£Œ');
            } else {
                // console.error('âŒ ì„ íƒí•  í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            selectedPaymentId = paymentId;
            selectedCandidateId = null;
            
            // console.log('í›„ë³´ ì¡°íšŒ ì‹œì‘...');
            loadCandidates(paymentId);
        }
        
        // í›„ë³´ ì¡°íšŒ
        async function loadCandidates(paymentId) {
            // console.log('ï¿½ï¿½ loadCandidates í•¨ìˆ˜ í˜¸ì¶œë¨! paymentId:', paymentId);
            
            try {
                const candidatesContainer = document.getElementById('candidatesContainer');
                const candidatesLoading = document.getElementById('candidatesLoading');
                const candidatesEmpty = document.getElementById('candidatesEmpty');
                const candidatesList = document.getElementById('candidatesList');
                const mappingActions = document.getElementById('mappingActions');
                
                // console.log('DOM ìš”ì†Œë“¤ ì°¾ê¸°:');
                // console.log('- candidatesContainer:', candidatesContainer);
                // console.log('- candidatesLoading:', candidatesLoading);
                // console.log('- candidatesEmpty:', candidatesEmpty);
                // console.log('- candidatesList:', candidatesList);
                // console.log('- mappingActions:', mappingActions);
                
                // í•„ìˆ˜ ìš”ì†Œë“¤ì´ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ì²˜ë¦¬
                if (!candidatesLoading || !candidatesEmpty || !candidatesList || !mappingActions) {
                    // console.error('âŒ í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            // console.log('ë¡œë”© ìƒíƒœ í‘œì‹œ...');
            candidatesLoading.style.display = 'flex';
            candidatesEmpty.style.display = 'none';
            candidatesList.style.display = 'none';
            mappingActions.style.display = 'none';
            
            try {
                const url = `/shipping-payment/mapping/api/candidates/${paymentId}`;
                // console.log('API í˜¸ì¶œ URL:', url);
                
                const response = await fetch(url);
                // console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    // console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`í›„ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                }
                
                const candidates = await response.json();
                currentCandidates = candidates;
                originalCandidates = [...candidates]; // ì›ë³¸ ë°ì´í„° ë°±ì—…
                
                // console.log('í›„ë³´ ì¡°íšŒ ì™„ë£Œ:', candidates.length, 'ê°œ');
                // console.log('í›„ë³´ ë°ì´í„°:', candidates);
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                candidatesLoading.style.display = 'none';
                
                if (candidates.length === 0) {
                    candidatesEmpty.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
                            <p>ğŸ’¡ ë§¤ì¹­ ê°€ëŠ¥í•œ êµí™˜/ë°˜í’ˆ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="font-size: 0.8rem; margin-top: 1rem;">
                                ì›ì¸: PAYMENT_STATUSê°€ 'PENDING'ì¸ êµí™˜/ë°˜í’ˆ ë°ì´í„°ê°€ ì—†ìŒ<br/>
                                í•´ê²°: êµí™˜/ë°˜í’ˆ ë“±ë¡ ì‹œ ë°°ì†¡ë¹„ë¥¼ "ì…ê¸ˆì˜ˆì •"ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”
                            </p>
                        </div>
                    `;
                    candidatesEmpty.style.display = 'block';
                    // í›„ë³´ê°€ ì—†ìœ¼ë©´ ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
                    document.getElementById('candidatesSearchContainer').style.display = 'none';
                } else {
                    displayCandidates(candidates);
                    candidatesList.style.display = 'block';
                    // í›„ë³´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ í‘œì‹œ
                    document.getElementById('candidatesSearchContainer').style.display = 'block';
                    // ê²€ìƒ‰ ì…ë ¥ë€ ì´ˆê¸°í™”
                    document.getElementById('candidateSearchName').value = '';
                    document.getElementById('candidateSearchOrder').value = '';
                }
                
            } catch (error) {
                // console.error('í›„ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                candidatesLoading.style.display = 'none';
                candidatesEmpty.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--danger-color);">
                        <p>âŒ í›„ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 0.8rem; margin-top: 1rem;">
                            ì˜¤ë¥˜: ${error.message}<br/>
                            ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) â†’ Console íƒ­ì—ì„œ ìì„¸í•œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”
                        </p>
                    </div>
                `;
                candidatesEmpty.style.display = 'block';
            }
            } catch (error) {
                // console.error('loadCandidates í•¨ìˆ˜ ì „ì²´ ì˜¤ë¥˜:', error);
            }
        }
        
        // í›„ë³´ ëª©ë¡ í‘œì‹œ
        function displayCandidates(candidates) {
            try {
                const candidatesList = document.getElementById('candidatesList');
                
                if (!candidatesList) {
                    // console.error('âŒ candidatesList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                candidatesList.innerHTML = candidates.map(candidate => {
                    // ë§¤í•‘ ìƒíƒœ í™•ì¸
                    const isAlreadyMapped = candidate.matchReason && candidate.matchReason.includes('ì´ë¯¸ ë§¤í•‘ë¨');
                    const isCompleted = candidate.paymentStatus === 'COMPLETED';
                    const isPending = candidate.paymentStatus === 'PENDING';
                    
                    // ì¹´ë“œ ìŠ¤íƒ€ì¼ ê²°ì •
                    let cardStyle = 'cursor: pointer;';
                    let statusIcon = '';
                    let statusText = '';
                    
                    if (isAlreadyMapped) {
                        cardStyle += ' opacity: 0.7; border: 2px solid #fbbf24; background: #fef3c7;';
                        statusIcon = 'ğŸ”—';
                        statusText = 'ì´ë¯¸ ë§¤í•‘ë¨';
                    } else if (isCompleted) {
                        cardStyle += ' border: 2px solid #10b981; background: #d1fae5;';
                        statusIcon = 'âœ…';
                        statusText = 'ê²°ì œì™„ë£Œ';
                    } else if (isPending) {
                        cardStyle += ' border: 2px solid #3b82f6; background: #dbeafe;';
                        statusIcon = 'â³';
                        statusText = 'ë§¤í•‘ ê°€ëŠ¥';
                    }
                    
                    return `
                    <div class="candidate-card" data-candidate-id="${candidate.returnItemId}" style="${cardStyle}">
                        <div class="candidate-header">
                            <span class="candidate-name">${candidate.customerName}</span>
                            <span class="match-score ${candidate.matchLevel.toLowerCase()}">${candidate.matchScore}%</span>
                        </div>
                        <div class="candidate-details">
                            <div><strong>ì£¼ë¬¸:</strong> ${candidate.orderNumber || ''}</div>
                            <div><strong>ë°°ì†¡ë¹„:</strong> ${candidate.shippingFee ? candidate.shippingFee.toLocaleString() + 'ì›' : candidate.paymentStatus || 'ì…ê¸ˆì˜ˆì •'}</div>
                            <div><strong>ë§¤ì¹­:</strong> ${candidate.matchReason}</div>
                            <div style="color: ${isAlreadyMapped ? '#f59e0b' : isCompleted ? '#059669' : '#3b82f6'}; font-weight: 600;">
                                ${statusIcon} ${statusText}
                            </div>
                            ${candidate.canShipExchange ? '<div style="color: var(--success-color); font-weight: 600;">ğŸšš ì¶œê³ ê°€ëŠ¥</div>' : ''}
                        </div>
                    </div>
                    `;
                }).join('');
            
            // í›„ë³´ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            candidatesList.addEventListener('click', function(e) {
                const card = e.target.closest('.candidate-card');
                if (card && card.dataset.candidateId) {
                    selectCandidate(parseInt(card.dataset.candidateId));
                }
            });
            } catch (error) {
                // console.error('displayCandidates í•¨ìˆ˜ ì˜¤ë¥˜:', error);
            }
        }
        
        // í›„ë³´ ì„ íƒ
        function selectCandidate(candidateId) {
            // console.log('í›„ë³´ ì„ íƒ:', candidateId);
            
            // ì„ íƒëœ ì¹´ë“œ í™•ì¸
            const selectedCard = document.querySelector(`[data-candidate-id="${candidateId}"]`);
            if (!selectedCard) {
                // console.error('ì„ íƒëœ í›„ë³´ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì´ë¯¸ ë§¤í•‘ëœ í›„ë³´ì¸ì§€ í™•ì¸
            const isAlreadyMapped = selectedCard.style.opacity === '0.7' || 
                                   selectedCard.innerHTML.includes('ì´ë¯¸ ë§¤í•‘ë¨');
            
            if (isAlreadyMapped) {
                alert('âš ï¸ ì´ë¯¸ ë‹¤ë¥¸ ì…ê¸ˆ ë‚´ì—­ê³¼ ë§¤í•‘ëœ êµí™˜/ë°˜í’ˆì…ë‹ˆë‹¤.\n\nì°¸ê³ ìš©ìœ¼ë¡œë§Œ í‘œì‹œë˜ë©° ìƒˆë¡œìš´ ë§¤í•‘ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ìƒˆ ì„ íƒ í‘œì‹œ
            selectedCard.classList.add('selected');
            
            selectedCandidateId = candidateId;
            
            // ë§¤í•‘ ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
            document.getElementById('mappingActions').style.display = 'block';
        }
        
        // ë§¤í•‘ ì‹¤í–‰
        async function executeMapping() {
            if (!selectedPaymentId || !selectedCandidateId) {
                alert('ì…ê¸ˆ ë‚´ì—­ê³¼ êµí™˜/ë°˜í’ˆì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const notes = prompt('ë§¤í•‘ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
            
            try {
                const response = await fetch('/shipping-payment/mapping/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: selectedPaymentId,
                        returnItemId: selectedCandidateId,
                        mappedBy: 'ìƒë‹´ì›', // ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´
                        notes: notes || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ' + result.message);
                    
                    // í…Œì´ë¸” í–‰ ì—…ë°ì´íŠ¸
                    updatePaymentRowStatus(selectedPaymentId, 'MAPPED');
                    
                    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                    updateStatsCards();
                    
                    // ì„ íƒ ì´ˆê¸°í™”
                    cancelSelection();
                } else {
                    alert('âŒ ë§¤í•‘ ì‹¤í–‰ ì‹¤íŒ¨: ' + result.message);
                }
                
            } catch (error) {
                // console.error('ë§¤í•‘ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                alert('âŒ ë§¤í•‘ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì„ íƒ ì·¨ì†Œ
        function cancelSelection() {
            selectedPaymentId = null;
            selectedCandidateId = null;
            
            // ëª¨ë“  ì„ íƒ í•´ì œ
            document.querySelectorAll('.payments-table tbody tr, .candidate-card').forEach(element => {
                element.classList.remove('selected');
            });
            
            // í›„ë³´ ì„¹ì…˜ ì´ˆê¸°í™”
            document.getElementById('candidatesEmpty').style.display = 'block';
            document.getElementById('candidatesList').style.display = 'none';
            document.getElementById('mappingActions').style.display = 'none';
            document.getElementById('candidatesSearchContainer').style.display = 'none'; // ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
            document.getElementById('candidatesEmpty').innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">ì…ê¸ˆ ë‚´ì—­ì„ ì„ íƒí•˜ë©´ ë§¤ì¹­ ê°€ëŠ¥í•œ êµí™˜/ë°˜í’ˆ í›„ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
            
            // í›„ë³´ ë°ì´í„° ì´ˆê¸°í™”
            originalCandidates = [];
            currentCandidates = [];
        }
        
        // ìë™ ë§¤í•‘ ì‹¤í–‰ (ë¹„í™œì„±í™”ë¨)
        async function executeAutoMapping() {
            alert('âŒ ìë™ ë§¤í•‘ì€ í˜„ì‹¤ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nì´ìœ :\nâ€¢ í†µì¥ ì…ê¸ˆ ë‚´ì—­ì—ëŠ” ì…ê¸ˆìëª…, ê¸ˆì•¡, ì‹œê°„ë§Œ í‘œì‹œ\nâ€¢ ë™ëª…ì´ì¸ ë¬¸ì œ (ê¹€ë¯¼ìˆ˜ê°€ ì—¬ëŸ¬ ëª…)\nâ€¢ ì…ê¸ˆì â‰  ì£¼ë¬¸ì (ê°€ì¡±ì´ ëŒ€ì‹  ì…ê¸ˆ)\nâ€¢ ì—°ë½ì²˜ ì •ë³´ ì—†ìŒ\nâ€¢ ë™ì¼ ê¸ˆì•¡ ì¤‘ë³µ ë¬¸ì œ\n\nğŸ‘† ìˆ˜ë™ ë§¤í•‘ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        }
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        function refreshData() {
            window.location.reload();
        }
        
        // í†µê³„ ìƒˆë¡œê³ ì¹¨
        async function refreshStats() {
            try {
                const response = await fetch('/shipping-payment/mapping/api/stats');
                const stats = await response.json();
                
                // í†µê³„ ì—…ë°ì´íŠ¸ - ì•ˆì „ì„± ê²€ì‚¬ ì¶”ê°€
                const primaryValue = document.querySelector('.stat-card.primary .value');
                const warningValue = document.querySelector('.stat-card.warning .value');
                const successValue = document.querySelector('.stat-card.success .value');
                const infoValue = document.querySelector('.stat-card.info .value');
                
                if (primaryValue) primaryValue.textContent = stats.totalPayments || 0;
                if (warningValue) warningValue.textContent = stats.pendingPayments || 0;
                if (successValue) successValue.textContent = stats.mappedPayments || 0;
                if (infoValue) infoValue.textContent = stats.todayMapped || 0;
                
            } catch (error) {
                // console.error('í†µê³„ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì´ˆê¸° ë°ì´í„° ìˆ˜ì§‘
        function collectPaymentsData() {
            try {
                const rows = document.querySelectorAll('#paymentsTableBody tr[data-payment-id]');
                allPaymentsData = Array.from(rows).map(row => ({
                    id: row.dataset.paymentId,
                    mappingStatus: row.dataset.mappingStatus,
                    customerName: row.cells[0].textContent.trim(),
                    customerPhone: row.cells[1].textContent.trim(),
                    amount: row.cells[2].textContent.trim(),
                    paymentDate: row.cells[3].textContent.trim(),
                    brand: row.cells[4].querySelector('span') ? row.cells[4].querySelector('span').textContent.trim() : row.cells[4].textContent.trim(),
                    siteName: row.cells[5].textContent.trim(),
                    element: row
                }));
                // console.log('ì´ˆê¸° ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', allPaymentsData.length, 'ê°œ');
            } catch (error) {
                // console.error('ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // í•„í„° ì ìš©
        function applyFilter(filterType) {
            // console.log('í•„í„° ì ìš©:', filterType);
            
            currentFilter = filterType;
            
            // í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = 'var(--text-muted)';
            });
            
            const activeBtn = document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1));
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary-color)';
                activeBtn.style.color = 'white';
            }
            
            // í…Œì´ë¸” í–‰ í•„í„°ë§
            allPaymentsData.forEach(payment => {
                let shouldShow = true;
                
                switch (filterType) {
                    case 'unmapped':
                        shouldShow = payment.mappingStatus === 'PENDING';
                        break;
                    case 'mapped':
                        shouldShow = payment.mappingStatus === 'MAPPED';
                        break;
                    case 'renoma':
                        shouldShow = payment.brand.includes('ë ˆë…¸ë§ˆ');
                        break;
                    case 'coralik':
                        shouldShow = payment.brand.includes('ì½”ë„ë¦¬í¬');
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                payment.element.style.display = shouldShow ? '' : 'none';
            });
        }
        
        // ê²€ìƒ‰ ì‹¤í–‰
        function performSearch() {
            const customerName = document.getElementById('searchCustomerName').value.toLowerCase().trim();
            const searchAmount = parseFloat(document.getElementById('searchAmount').value) || 0;
            const siteName = document.getElementById('searchSiteName').value.toLowerCase().trim();
            
            // console.log('ê²€ìƒ‰ ì‹¤í–‰:', { customerName, searchAmount, siteName });
            
            allPaymentsData.forEach(payment => {
                let shouldShow = true;
                
                // ê³ ê°ëª… ê²€ìƒ‰
                if (customerName && !payment.customerName.toLowerCase().includes(customerName)) {
                    shouldShow = false;
                }
                
                // ì…ê¸ˆê¸ˆì•¡ ê²€ìƒ‰ - ìˆ«ì ë¹„êµë¡œ ìˆ˜ì •
                if (searchAmount && searchAmount.trim() !== '') {
                    // ê²€ìƒ‰ì–´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
                    const searchAmountNum = parseInt(searchAmount.replace(/[,\s]/g, ''));
                    // ì…ê¸ˆê¸ˆì•¡ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (ì˜ˆ: "3,000ì›" â†’ 3000)
                    const paymentAmountNum = parseInt(payment.amount.replace(/[,ì›\s]/g, ''));
                    
                    if (!isNaN(searchAmountNum) && !isNaN(paymentAmountNum)) {
                        // ì •í™•í•œ ê¸ˆì•¡ ì¼ì¹˜ ê²€ìƒ‰
                        if (paymentAmountNum !== searchAmountNum) {
                            shouldShow = false;
                        }
                    } else {
                        // ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ í¬í•¨ ê²€ìƒ‰ìœ¼ë¡œ fallback
                        if (!payment.amount.includes(searchAmount)) {
                            shouldShow = false;
                        }
                    }
                }
                
                // ì‚¬ì´íŠ¸ëª… ê²€ìƒ‰
                if (siteName && !payment.siteName.toLowerCase().includes(siteName)) {
                    shouldShow = false;
                }
                
                payment.element.style.display = shouldShow ? '' : 'none';
            });
        }
        
        // ë§¤í•‘ ì·¨ì†Œ
        async function cancelMapping(paymentId) {
            if (!confirm('ì •ë§ë¡œ ì´ ë§¤í•‘ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // console.log('ë§¤í•‘ ì·¨ì†Œ ìš”ì²­:', paymentId);
            
            try {
                const response = await fetch('/shipping-payment/mapping/api/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: paymentId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ' + result.message);
                    
                    // í…Œì´ë¸” í–‰ ì—…ë°ì´íŠ¸
                    updatePaymentRowStatus(paymentId, 'PENDING');
                    
                    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                    updateStatsCards();
                } else {
                    alert('âŒ ë§¤í•‘ ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message);
                }
                
            } catch (error) {
                // console.error('ë§¤í•‘ ì·¨ì†Œ ì˜¤ë¥˜:', error);
                alert('âŒ ë§¤í•‘ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í…Œì´ë¸” í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePaymentRowStatus(paymentId, newStatus) {
            try {
                const row = document.querySelector(`tr[data-payment-id="${paymentId}"]`);
                if (!row) {
                    // console.error('í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', paymentId);
                    return;
                }
                
                // data-mapping-status ì—…ë°ì´íŠ¸
                row.dataset.mappingStatus = newStatus;
                
                // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                const statusCell = row.cells[6]; // ìƒíƒœ ì»¬ëŸ¼
                const statusSpan = statusCell.querySelector('span');
                if (statusSpan) {
                    if (newStatus === 'MAPPED') {
                        statusSpan.style.backgroundColor = '#d1fae5';
                        statusSpan.style.color = '#065f46';
                        statusSpan.textContent = 'ë§¤í•‘ì™„ë£Œ';
                    } else {
                        statusSpan.style.backgroundColor = '#fef3c7';
                        statusSpan.style.color = '#92400e';
                        statusSpan.textContent = 'ë¯¸ë§¤í•‘';
                    }
                }
                
                // ê´€ë¦¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                const actionCell = row.cells[7]; // ê´€ë¦¬ ì»¬ëŸ¼
                if (newStatus === 'MAPPED') {
                    actionCell.innerHTML = `
                        <button class="btn btn-outline-danger" 
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px;"
                                onclick="cancelMapping(${paymentId}); event.stopPropagation();"
                                title="ë§¤í•‘ ì·¨ì†Œ">
                            ğŸ—‘ï¸ ì·¨ì†Œ
                        </button>
                    `;
                } else {
                    actionCell.innerHTML = `
                        <button class="btn btn-success" 
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #10b981; border: none; color: white; border-radius: 4px;"
                                onclick="selectPayment(${paymentId}); event.stopPropagation();"
                                title="ë§¤í•‘ ì‹¤í–‰">
                            âœ… ë§¤í•‘
                        </button>
                    `;
                }
                
                // ë°ì´í„° ë°°ì—´ë„ ì—…ë°ì´íŠ¸
                const paymentData = allPaymentsData.find(p => p.id == paymentId);
                if (paymentData) {
                    paymentData.mappingStatus = newStatus;
                }
                
                // console.log('âœ… í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', paymentId, 'â†’', newStatus);
                
            } catch (error) {
                // console.error('í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        async function updateStatsCards() {
            // console.log('ğŸ“Š í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘...');
            
            fetch('/shipping-payment/mapping/api/stats')
                .then(response => response.json())
                .then(stats => {
                    // console.log('ğŸ“Š ìƒˆë¡œìš´ í†µê³„ ë°ì´í„°:', stats);
                    
                    // ê° í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                    const totalPaymentsElement = document.querySelector('.stat-card.primary .value');
                    if (totalPaymentsElement) {
                        totalPaymentsElement.textContent = stats.totalPayments || 0;
                        // console.log('ğŸ“Š ì´ ì…ê¸ˆ ë‚´ì—­ ì—…ë°ì´íŠ¸:', stats.totalPayments);
                    }
                    
                    const pendingPaymentsElement = document.querySelector('.stat-card.warning .value');
                    if (pendingPaymentsElement) {
                        pendingPaymentsElement.textContent = stats.pendingPayments || 0;
                        // console.log('ğŸ“Š ë¯¸ë§¤í•‘ ê±´ìˆ˜ ì—…ë°ì´íŠ¸:', stats.pendingPayments);
                    }
                    
                    const mappedPaymentsElement = document.querySelector('.stat-card.success .value');
                    if (mappedPaymentsElement) {
                        mappedPaymentsElement.textContent = stats.mappedPayments || 0;
                        // console.log('ğŸ“Š ë§¤í•‘ ì™„ë£Œ ì—…ë°ì´íŠ¸:', stats.mappedPayments);
                    }
                    
                    const todayMappedElement = document.querySelector('.stat-card.info .value');
                    if (todayMappedElement) {
                        todayMappedElement.textContent = stats.todayMapped || 0;
                        // console.log('ğŸ“Š ì˜¤ëŠ˜ ë§¤í•‘ ì—…ë°ì´íŠ¸:', stats.todayMapped);
                    }
                    
                    // console.log('âœ… í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                })
                .catch(error => {
                    // console.error('âŒ í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                });
        }
        
        // í›„ë³´ ê²€ìƒ‰ ì‹¤í–‰
        function performCandidateSearch() {
            try {
                const nameKeyword = document.getElementById('candidateSearchName').value.trim();
                const orderKeyword = document.getElementById('candidateSearchOrder').value.trim();
                
                // console.log('í›„ë³´ ê²€ìƒ‰ ì‹¤í–‰:', { nameKeyword, orderKeyword });
                
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ
                if (!nameKeyword && !orderKeyword) {
                    currentCandidates = [...originalCandidates];
                } else {
                    // ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í›„ë³´ í•„í„°ë§
                    currentCandidates = originalCandidates.filter(candidate => {
                        let matches = true;
                        
                        // ê³ ê°ëª… ê²€ìƒ‰
                        if (nameKeyword) {
                            const customerName = (candidate.customerName || '').toLowerCase();
                            matches = matches && customerName.includes(nameKeyword);
                        }
                        
                        // ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰
                        if (orderKeyword) {
                            const orderNumber = (candidate.orderNumber || '').toLowerCase();
                            matches = matches && orderNumber.includes(orderKeyword);
                        }
                        
                        return matches;
                    });
                }
                
                // console.log(`ê²€ìƒ‰ ê²°ê³¼: ${currentCandidates.length}ê°œ (ì „ì²´ ${originalCandidates.length}ê°œ ì¤‘)`);
                
                // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                const candidatesEmpty = document.getElementById('candidatesEmpty');
                const candidatesList = document.getElementById('candidatesList');
                
                if (currentCandidates.length === 0) {
                    candidatesEmpty.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
                            <p>ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="font-size: 0.8rem; margin-top: 1rem;">
                                ê²€ìƒ‰ì–´: ${nameKeyword ? `ê³ ê°ëª… "${nameKeyword}"` : ''}${nameKeyword && orderKeyword ? ', ' : ''}${orderKeyword ? `ì£¼ë¬¸ë²ˆí˜¸ "${orderKeyword}"` : ''}<br/>
                                ì „ì²´ í›„ë³´: ${originalCandidates.length}ê°œ
                            </p>
                            <button onclick="clearCandidateSearch()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ”„ ê²€ìƒ‰ ì´ˆê¸°í™”
                            </button>
                        </div>
                    `;
                    candidatesEmpty.style.display = 'block';
                    candidatesList.style.display = 'none';
                } else {
                    displayCandidates(currentCandidates);
                    candidatesEmpty.style.display = 'none';
                    candidatesList.style.display = 'block';
                }
                
            } catch (error) {
                // console.error('í›„ë³´ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í›„ë³´ ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearCandidateSearch() {
            document.getElementById('candidateSearchName').value = '';
            document.getElementById('candidateSearchOrder').value = '';
            searchCandidates(); // ì „ì²´ í›„ë³´ ë‹¤ì‹œ í‘œì‹œ
            
            // console.log('í›„ë³´ ê²€ìƒ‰ ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function getReturnTypeText(code) {
            const types = {
                'FULL_RETURN': 'ì „ì²´ë°˜í’ˆ',
                'PARTIAL_RETURN': 'ë¶€ë¶„ë°˜í’ˆ',
                'FULL_EXCHANGE': 'ì „ì²´êµí™˜',
                'PARTIAL_EXCHANGE': 'ë¶€ë¶„êµí™˜',
                'EXCHANGE': 'ì¼ë°˜êµí™˜'
            };
            return types[code] || code;
        }
    </script>
    </th:block>
</body>
</html> 