<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- ÏõîÎ≥Ñ ÏÑ†ÌÉù ÌîåÎü¨Í∑∏Ïù∏ Ï∂îÍ∞Ä -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <!-- html2canvas for image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô©</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ÌÜµÍ≥Ñ</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô©</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- Ïõî ÏÑ†ÌÉù ÏòÅÏó≠ -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© Ï°∞Ìöå</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-200px" placeholder="Ïõî ÏÑ†ÌÉù" id="monthly_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">Ï°∞Ìöå</button>
                                <button type="button" class="btn btn-success ms-3" id="excelDownloadBtn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1.ÏõîÍ∞Ñ ÏöîÏïΩ ÌÜµÍ≥Ñ -->
                <div class="row g-5 g-xl-8 mb-6">
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">154</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">Ï¥ùÏΩú</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">12% Ï¶ùÍ∞Ä</div>
                                    <div class="fw-bold text-gray-600">Ï†ÑÏõî ÎåÄÎπÑ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">82.5%</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">ÏùëÎåÄÏú®</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-danger flex-grow-1 fw-bold">-2.5% Í∞êÏÜå</div>
                                    <div class="fw-bold text-gray-600">Ï†ÑÏõî ÎåÄÎπÑ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">87</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">ÏÉÅÎã¥ÏôÑÎ£å Í±¥Ïàò</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">5% Ï¶ùÍ∞Ä</div>
                                    <div class="fw-bold text-gray-600">Ï†ÑÏõî ÎåÄÎπÑ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">-</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">ÎØ∏Íµ¨ÌòÑ</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">-</div>
                                    <div class="fw-bold text-gray-600">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_monthly_trend_chart" style="height: 350px;"></div>
                    </div>
                </div>

                <!-- 3.Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ -->
                <div class="card card-flush mb-6" id="weekly-stats-card">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">3.Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ÏùºÏûê</th>
                                    <th>Ï¥ùÏΩú</th>
                                    <th>Ï§ëÎ≥µÏ†úÍ±∞Ìò∏</th>
                                    <th>ÏùëÎåÄÌò∏</th>
                                    <th>Ìè¨Í∏∞Ìò∏</th>
                                    <th>Î∂ÄÏû¨Ìò∏</th>
                                    <th>Ï¥ùÏÉÅÎã¥ÏôÑÎ£åÌò∏</th>
                                    <th>ÏàòÏã†Ìò∏</th>
                                    <th>Î∞úÏã†Ìò∏</th>
                                    <th>ÏùëÎåÄÏú®</th>
                                    <th>ÏôÑÎ£åÏú®</th>
                                    <th>ÏàòÏã†ÎπÑÏú®</th>
                                    <th>Î∞úÏã†ÎπÑÏú®</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <!-- Îç∞Ïù¥ÌÑ∞Îäî JavaScriptÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßëÎãàÎã§ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4.ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù -->
                <div class="row g-5 g-xl-8 mb-6">
                    <!-- ÌååÏù¥ Ï∞®Ìä∏ -->
                    <div class="col-xl-6">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">4.ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù</span>
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="kt_monthly_counseling_types" class="min-h-auto" style="height: 350px"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î -->
                    <div class="col-xl-6">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">ÏÉÅÎã¥Ïú†Ìòï ÏÉÅÏÑ∏ ÎÇ¥Ïó≠</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>ÏÉÅÎã¥Ïú†Ìòï</th>
                                            <th>ÏÉÅÎã¥Ïàò</th>
                                            <th>ÎπÑÏú®</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center">
                                        <!-- Îç∞Ïù¥ÌÑ∞Îäî JavaScriptÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßëÎãàÎã§ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">5.Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_monthly_comparison_chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // Ïõî ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî (ÌòÑÏû¨ ÏõîÎ°ú Í∏∞Î≥∏ ÏÑ§Ï†ï)
        var currentDate = new Date();
        var currentYearMonth = currentDate.getFullYear() + "-" + 
                               String(currentDate.getMonth() + 1).padStart(2, '0');
        
        $("#monthly_datepicker").flatpickr({
            altInput: true,
            altFormat: "F Y",
            dateFormat: "Y-m",
            defaultDate: currentYearMonth,
            plugins: []
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        $(document).ready(function() {
            var initialDate = $("#monthly_datepicker").val();
            if (initialDate) {
                fetchMonthlyOperationData(initialDate);
            }
        });

        // Í≤ÄÏÉâ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('searchBtn').addEventListener('click', function() {
            var yearMonth = document.getElementById('monthly_datepicker').value;
            console.log('Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®: ' + yearMonth);
            
            if (yearMonth) {
                fetchMonthlyOperationData(yearMonth);
            } else {
                alert('ÏõîÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        });
        
        // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('excelDownloadBtn').addEventListener('click', function() {
            var yearMonth = document.getElementById('monthly_datepicker').value;
            if (!yearMonth) {
                alert('ÏõîÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            downloadMonthlyOperationExcel();
        });
        
        // ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ìï®Ïàò
        function fetchMonthlyOperationData(yearMonth) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            $.ajax({
                url: '/stat/monthly/search',
                type: 'POST',
                data: {
                    yearMonth: yearMonth
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    console.log('ÏõîÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏÑ±Í≥µ:', response);
                    
                    // ÎîîÎ≤ÑÍπÖ: Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                    if (response && response.weeklyStatsList) {
                        console.log('Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞:', response.weeklyStatsList);
                    } else {
                        console.error('Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    }
                    
                    if (response) {
                        // 1. ÏõîÍ∞Ñ ÏöîÏïΩ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                        updateMonthlySummary(response.summaryStats, response.yearlyComparisonData);
                        // 2. ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        updateMonthlyTrendChart(response.dailyStatsList);
                        // 3. Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                        updateWeeklyTable(response.weeklyStatsList);
                        // 4. ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏
                        updateCounselingTypeAnalysis(response.counselingTypeStats);
                        // 5. Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        updateMonthlyComparisonChart(response.yearlyComparisonData);
                    } else {
                        console.error('ÏàòÏã†Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                        // Ïò§Î•ò ÏïåÎ¶º
                        alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÏõîÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:', error);
                    console.error('ÏÉÅÌÉú ÏΩîÎìú:', xhr.status);
                    console.error('ÏùëÎãµ ÌÖçÏä§Ìä∏:', xhr.responseText);
                    alert('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            });
        }
        
        // 1. ÏõîÍ∞Ñ ÏöîÏïΩ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateMonthlySummary(summaryStats, comparisonData) {
            if (!summaryStats) return;
            
            // Ï¥ù ÌÜµÌôî Í±¥Ïàò
            $('.col-xl-3:eq(0) .fs-2hx').text(formatNumber(summaryStats.totalCalls || 0));
            
            // ÏùëÎåÄÏú® (ÏôÑÎ£åÏú®) - Í∞íÏù¥ Ï†úÎåÄÎ°ú Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏùÑ Í≤ΩÏö∞ ÏßÅÏ†ë Í≥ÑÏÇ∞
            var answerRate = summaryStats.answerRate;
            if (answerRate === null || answerRate === undefined || answerRate === 0) {
                var totalCalls = summaryStats.totalCalls || 0;
                var answeredCalls = summaryStats.answeredCalls || 0;
                var abandonedCalls = summaryStats.abandonedCalls || 0;
                
                // Î∞±ÏóîÎìú Í≥ÑÏÇ∞ Î°úÏßÅÍ≥º ÏùºÏπò: (ÏùëÎåÄÌò∏ / (Ï¥ùÏΩú - Ìè¨Í∏∞Ìò∏)) * 100
                var totalCallsForRate = totalCalls - abandonedCalls;
                answerRate = (totalCallsForRate > 0) ? ((answeredCalls / totalCallsForRate) * 100) : 0;
                console.log('ÏùëÎåÄÏú® ÏßÅÏ†ë Í≥ÑÏÇ∞:', answerRate.toFixed(1) + '%', 
                           'ÏùëÎãµ ÏΩú:', answeredCalls, 
                           'Ï¥ù ÏΩú:', totalCalls, 
                           'Ìè¨Í∏∞Ìò∏:', abandonedCalls,
                           'Í≥ÑÏÇ∞Ïö© Ï¥ùÏΩú:', totalCallsForRate);
            }
            $('.col-xl-3:eq(1) .fs-2hx').text((answerRate || 0).toFixed(1) + '%');
            
            // ÏÉÅÎã¥ÏôÑÎ£å Í±¥Ïàò (Ï¥ù ÏùëÎãµ Í±¥Ïàò)
            $('.col-xl-3:eq(2) .fs-2hx').text(formatNumber(summaryStats.completedCounselingCalls || 0));
            
            // ÌèâÍ∑† ÌÜµÌôî ÏãúÍ∞Ñ (Ï¥à -> Î∂Ñ:Ï¥à Î≥ÄÌôò) - ÎØ∏Íµ¨ÌòÑ
            $('.col-xl-3:eq(3) .fs-2hx').text('-');
            
            // Ï¶ùÍ∞êÎ•† Í≥ÑÏÇ∞ Î∞è ÌëúÏãú
            if (comparisonData) {
                // Ï¥ù ÌÜµÌôî Ï¶ùÍ∞êÎ•†
                var callRateChange = comparisonData.totalCallsComparisonRate;
                if (callRateChange === null || callRateChange === undefined) {
                    callRateChange = 0;
                }
                var callRateText = (callRateChange >= 0 ? 
                    callRateChange.toFixed(1) + '% Ï¶ùÍ∞Ä' : 
                    Math.abs(callRateChange).toFixed(1) + '% Í∞êÏÜå');
                var callRateClass = callRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(0) .flex-grow-1').text(callRateText).removeClass('text-success text-danger').addClass(callRateClass);
                
                // ÏùëÎåÄÏú® Ï¶ùÍ∞êÎ•†
                var answerRateChange = comparisonData.answerRateComparisonRate;
                if (answerRateChange === null || answerRateChange === undefined) {
                    answerRateChange = 0;
                }
                var answerRateText = (answerRateChange >= 0 ? 
                    answerRateChange.toFixed(1) + '% Ï¶ùÍ∞Ä' : 
                    Math.abs(answerRateChange).toFixed(1) + '% Í∞êÏÜå');
                var answerRateClass = answerRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(1) .flex-grow-1').text(answerRateText).removeClass('text-success text-danger').addClass(answerRateClass);
                
                // ÏÉÅÎã¥ÏôÑÎ£å Í±¥Ïàò Ï¶ùÍ∞êÎ•†
                var completeCallRateChange = comparisonData.completedCounselingCallsComparisonRate;
                if (completeCallRateChange === null || completeCallRateChange === undefined) {
                    completeCallRateChange = 0;
                }
                var completeCallRateText = (completeCallRateChange >= 0 ? 
                    completeCallRateChange.toFixed(1) + '% Ï¶ùÍ∞Ä' : 
                    Math.abs(completeCallRateChange).toFixed(1) + '% Í∞êÏÜå');
                var completeCallRateClass = completeCallRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(2) .flex-grow-1').text(completeCallRateText).removeClass('text-success text-danger').addClass(completeCallRateClass);
            }
        }
        
        // Ï¥àÎ•º MM:SS ÌòïÏãùÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            var minutes = Math.floor(seconds / 60);
            var remainingSeconds = Math.floor(seconds % 60);
            return minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
        }
        
        // Ïà´Ïûê Ìè¨Îß∑ Ìï®Ïàò (Ï≤úÎã®ÏúÑ ÏΩ§Îßà)
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // 2. ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var monthlyTrendChartInstance = null;
        function updateMonthlyTrendChart(dailyStatsList) {
            var monthlyTrendElement = document.getElementById('kt_monthly_trend_chart');
            if (!monthlyTrendElement || !dailyStatsList || dailyStatsList.length === 0) return;
            
            // Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
            var categories = [];
            var callsData = [];
            var answerRateData = [];
            
            dailyStatsList.forEach(function(stat) {
                // ÎÇ†ÏßúÏóêÏÑú ÏùºÏûêÎßå Ï∂îÏ∂ú (MM-DD ÌòïÏãù)
                var dateStr = stat.statDate;
                var shortDate = dateStr.substring(5); // "YYYY-MM-DD" -> "MM-DD"
                
                // Ï£ºÎßê Ï†úÏô∏ (ÌÜ†ÏöîÏùº: 6, ÏùºÏöîÏùº: 0)
                var date = new Date(dateStr);
                var dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    categories.push(shortDate);
                    callsData.push(stat.totalCalls || 0);
                    
                    // ÏùëÎåÄÏú® ÏÇ¨Ïö© (completionRate ÎåÄÏã†)
                    var answerRate = stat.answerRate;
                    // ÏùëÎåÄÏú® Í∞íÏù¥ nullÏù¥Í±∞ÎÇò undefinedÏù∏ Í≤ΩÏö∞ ÏßÅÏ†ë Í≥ÑÏÇ∞
                    if (answerRate === undefined || answerRate === null) {
                        var totalCalls = stat.totalCalls || 0;
                        var answeredCalls = stat.answeredCalls || 0;
                        var abandonedCalls = stat.abandonedCalls || 0;
                        var totalCallsForRate = totalCalls - abandonedCalls;
                        answerRate = (totalCallsForRate > 0) ? ((answeredCalls / totalCallsForRate) * 100) : 0;
                    }
                    answerRateData.push(answerRate || 0);
                }
            });
            
            var monthlyTrendOptions = {
                series: [{
                    name: 'ÌÜµÌôîÍ±¥Ïàò',
                    type: 'column',
                    data: callsData
                }, {
                    name: 'ÏùëÎåÄÏú®',
                    type: 'line',
                    data: answerRateData
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    stacked: false
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    width: [0, 3]
                },
                title: {
                    text: 'ÏõîÍ∞Ñ ÏùºÎ≥Ñ ÌÜµÌôîÍ±¥Ïàò Î∞è ÏùëÎåÄÏú® (ÌèâÏùº Í∏∞Ï§Ä)',
                    align: 'left'
                },
                xaxis: {
                    categories: categories
                },
                yaxis: [{
                    title: {
                        text: 'ÌÜµÌôîÍ±¥Ïàò',
                    },
                    decimalsInFloat: 1
                }, {
                    opposite: true,
                    title: {
                        text: 'ÏùëÎåÄÏú®(%)'
                    },
                    decimalsInFloat: 1
                }],
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (!isFinite(val) || isNaN(val)) return '0';
                            
                            if (opts.seriesIndex === 0) {
                                return Number(val).toFixed(0) + " Í±¥";
                            } else if (opts.seriesIndex === 1) {
                                return Number(val).toFixed(1) + "%";
                            }
                            return val;
                        }
                    }
                },
                fill: {
                    opacity: [0.85, 1],
                    colors: ['#009ef7', '#ff6384']
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -25
                }
            };
            
            if (monthlyTrendChartInstance) {
                monthlyTrendChartInstance.updateOptions(monthlyTrendOptions);
            } else {
                monthlyTrendChartInstance = new ApexCharts(monthlyTrendElement, monthlyTrendOptions);
                monthlyTrendChartInstance.render();
            }
        }
        
        // 3. Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateWeeklyTable(weeklyStatsList) {
            console.log('updateWeeklyTable Ìï®Ïàò Ìò∏Ï∂úÎê®. Îç∞Ïù¥ÌÑ∞:', weeklyStatsList);
            
            if (!weeklyStatsList || weeklyStatsList.length === 0) {
                console.error('Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                $('#weekly-stats-card tbody').html('<tr><td colspan="13" class="text-center">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</td></tr>');
                return;
            }
            
            var tbody = $('#weekly-stats-card tbody');
            tbody.empty();
            
            var totalCalls = 0;
            var totalUniqueInbound = 0;
            var totalAnswered = 0;
            var totalAbandoned = 0;
            var totalBusy = 0;
            var totalCompleted = 0;
            var totalInbound = 0;
            var totalOutbound = 0;
            
            // Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ìñâ Ï∂îÍ∞Ä
            weeklyStatsList.forEach(function(stat, index) {
                console.log('Ï£ºÏ∞® Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë:', index + 1, stat);
                
                // Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                var statTotalCalls = stat.totalCalls || 0;
                var uniqueInbound = stat.uniqueInboundCalls || 0;
                var answered = stat.answeredCalls || 0;
                var abandoned = stat.abandonedCalls || 0;
                var busy = stat.busyCalls || 0;
                var completed = stat.completedCounselingCalls || 0;
                var inbound = stat.inboundCalls || 0;
                var outbound = stat.outboundCalls || 0;
                
                // ÎπÑÏú® Í∞í Í∞ÄÏ†∏Ïò§Í∏∞ (Î∞±ÏóîÎìúÏóêÏÑú Í≥ÑÏÇ∞Îêú Í∞í ÎòêÎäî ÏßÅÏ†ë Í≥ÑÏÇ∞)
                var answerRate = stat.answerRate !== undefined ? stat.answerRate : 
                                (statTotalCalls > 0 ? (answered / statTotalCalls * 100) : 0);
                var completionRate = stat.completionRate !== undefined ? stat.completionRate : 
                                    (answered > 0 ? (completed / answered * 100) : 0);
                var inboundRate = stat.inboundRate !== undefined ? stat.inboundRate : 
                                 (statTotalCalls > 0 ? (inbound / statTotalCalls * 100) : 0);
                var outboundRate = stat.outboundRate !== undefined ? stat.outboundRate : 
                                  (statTotalCalls > 0 ? (outbound / statTotalCalls * 100) : 0);
                
                // Ìï©Í≥Ñ Í≥ÑÏÇ∞
                totalCalls += statTotalCalls;
                totalUniqueInbound += uniqueInbound;
                totalAnswered += answered;
                totalAbandoned += abandoned;
                totalBusy += busy;
                totalCompleted += completed;
                totalInbound += inbound;
                totalOutbound += outbound;
                
                // Ï£ºÏ∞® ÎùºÎ≤® - Î∞±ÏóîÎìú Í∞í Î¨¥ÏãúÌïòÍ≥† Ïù∏Îç±Ïä§+1Î°ú ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÌëúÏãú
                var weekLabel = (index + 1) + 'Ï£ºÏ∞®';
                
                var row = `<tr>
                    <td>${weekLabel}</td>
                    <td>${formatNumber(statTotalCalls)}</td>
                    <td>${formatNumber(uniqueInbound)}</td>
                    <td>${formatNumber(answered)}</td>
                    <td>${formatNumber(abandoned)}</td>
                    <td>${formatNumber(busy)}</td>
                    <td>${formatNumber(completed)}</td>
                    <td>${formatNumber(inbound)}</td>
                    <td>${formatNumber(outbound)}</td>
                    <td>${(answerRate || 0).toFixed(1)}%</td>
                    <td>${(completionRate || 0).toFixed(1)}%</td>
                    <td>${(inboundRate || 0).toFixed(1)}%</td>
                    <td>${(outboundRate || 0).toFixed(1)}%</td>
                </tr>`;
                
                tbody.append(row);
            });
            
            // Ìï©Í≥Ñ Ìñâ Í≥ÑÏÇ∞
            var totalAnswerRate = (totalAnswered > 0 && totalCalls > 0) ? ((totalAnswered / totalCalls) * 100) : 0;
            var totalCompletionRate = (totalCompleted > 0 && totalAnswered > 0) ? ((totalCompleted / totalAnswered) * 100) : 0;
            var totalInboundRate = (totalInbound > 0 && totalCalls > 0) ? ((totalInbound / totalCalls) * 100) : 0;
            var totalOutboundRate = (totalOutbound > 0 && totalCalls > 0) ? ((totalOutbound / totalCalls) * 100) : 0;
            
            // Ìï©Í≥Ñ Ìñâ Ï∂îÍ∞Ä
            var totalRow = `<tr class="fw-bold bg-light-primary">
                <td>Ìï©Í≥Ñ</td>
                <td>${formatNumber(totalCalls)}</td>
                <td>${formatNumber(totalUniqueInbound)}</td>
                <td>${formatNumber(totalAnswered)}</td>
                <td>${formatNumber(totalAbandoned)}</td>
                <td>${formatNumber(totalBusy)}</td>
                <td>${formatNumber(totalCompleted)}</td>
                <td>${formatNumber(totalInbound)}</td>
                <td>${formatNumber(totalOutbound)}</td>
                <td>${(totalAnswerRate || 0).toFixed(1)}%</td>
                <td>${(totalCompletionRate || 0).toFixed(1)}%</td>
                <td>${(totalInboundRate || 0).toFixed(1)}%</td>
                <td>${(totalOutboundRate || 0).toFixed(1)}%</td>
            </tr>`;
            
            tbody.append(totalRow);
            console.log('Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }
        
        // 4. ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var counselingTypesChartInstance = null;
        function updateCounselingTypeAnalysis(counselingTypeStats) {
            if (!counselingTypeStats || counselingTypeStats.length === 0) return;
            
            // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            var chartSeries = [];
            var chartLabels = [];
            
            // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            var tbody = $('.col-xl-6:eq(1) tbody');
            tbody.empty();
            
            counselingTypeStats.forEach(function(stat) {
                // ÌÖåÏù¥Î∏î Ìñâ Ï∂îÍ∞Ä
                var row = `<tr>
                    <td>${stat.counselingTypeName || 'Í∏∞ÌÉÄ'}</td>
                    <td>${stat.count || 0}</td>
                    <td>${(stat.percentage || 0).toFixed(1)}%</td>
                </tr>`;
                
                tbody.append(row);
                
                // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                chartLabels.push(stat.counselingTypeName || 'Í∏∞ÌÉÄ');
                chartSeries.push(stat.count || 0);
            });
            
            // ÌååÏù¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            var counselingTypesElement = document.getElementById('kt_monthly_counseling_types');
            if (!counselingTypesElement) return;
            
            var counselingTypesOptions = {
                series: chartSeries,
                chart: {
                    type: 'pie',
                    height: 350
                },
                labels: chartLabels,
                colors: ['#fe5151', '#5ead60', '#7250e7', '#efc22e', '#487eb3'],
                legend: {
                    position: 'bottom'
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };
            
            if (counselingTypesChartInstance) {
                counselingTypesChartInstance.updateOptions(counselingTypesOptions);
            } else {
                counselingTypesChartInstance = new ApexCharts(counselingTypesElement, counselingTypesOptions);
                counselingTypesChartInstance.render();
            }
        }
        
        // 5. Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var monthlyComparisonChartInstance = null;
        function updateMonthlyComparisonChart(yearlyComparison) {
            if (!yearlyComparison) return;
            
            var monthlyComparisonElement = document.getElementById('kt_monthly_comparison_chart');
            if (!monthlyComparisonElement) return;
            
            // Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            var currentTotalCalls = yearlyComparison.totalCallsCurrentYear || 0;
            var previousTotalCalls = yearlyComparison.totalCallsPreviousYear || 0;
            var currentCompletedCalls = yearlyComparison.cmplCslCurrYr || 0;
            var previousCompletedCalls = yearlyComparison.cmplCslPrevYr || 0;
            
            // ÏùëÎãµÎ•† Í≥ÑÏÇ∞
            var currentCompletionRate = yearlyComparison.currentCompletionRate || 0;
            var previousCompletionRate = yearlyComparison.previousCompletionRate || 0;
            
            var monthlyComparisonOptions = {
                series: [{
                    name: 'Ïù¥Î≤à Îã¨',
                    data: [currentTotalCalls, currentCompletedCalls, currentCompletionRate]
                }, {
                    name: 'Ï†ÑÏõî',
                    data: [previousTotalCalls, previousCompletedCalls, previousCompletionRate]
                }],
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: ['Ï¥ù ÌÜµÌôîÍ±¥Ïàò', 'ÏôÑÎ£åÍ±¥Ïàò', 'ÏùëÎãµÎ•†(%)'],
                },
                yaxis: {
                    title: {
                        text: 'Í±¥Ïàò'
                    },
                    decimalsInFloat: 1
                },
                fill: {
                    opacity: 1,
                    colors: ['#009ef7', '#ff6384']
                },
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (!isFinite(val) || isNaN(val)) return '0';
                            
                            if (opts.dataPointIndex === 2) {
                                return Number(val).toFixed(1) + "%";
                            }
                            return Number(val).toFixed(0) + " Í±¥";
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                }
            };
            
            if (monthlyComparisonChartInstance) {
                monthlyComparisonChartInstance.updateOptions(monthlyComparisonOptions);
            } else {
                monthlyComparisonChartInstance = new ApexCharts(monthlyComparisonElement, monthlyComparisonOptions);
                monthlyComparisonChartInstance.render();
            }
        }
        
        // ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ìï®Ïàò
        async function downloadMonthlyOperationExcel() {
            try {
                console.log('üì• ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï® ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏãúÏûë...');
                showToast('Ï∞®Ìä∏ÏôÄ ÌÖåÏù¥Î∏îÏùÑ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÌôò Ï§ëÏûÖÎãàÎã§...', 'info');
                
                const images = {};
                
                // 1. ÏõîÍ∞Ñ ÏöîÏïΩ ÌÜµÍ≥Ñ Ïπ¥Îìú ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                const summaryCards = document.querySelector('.row.g-5.g-xl-8.mb-6');
                if (summaryCards) {
                    console.log('üìä ÏõîÍ∞Ñ ÏöîÏïΩ ÌÜµÍ≥Ñ Ïπ¥Îìú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    const cardsCanvas = await html2canvas(summaryCards, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // Ï†ÅÏ†àÌïú Ìï¥ÏÉÅÎèÑÎ°ú Ï°∞Ï†ï
                        useCORS: true,
                        allowTaint: true,
                        width: summaryCards.offsetWidth,
                        height: summaryCards.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.summaryCardsImage = cardsCanvas.toDataURL('image/png', 1.0);
                }
                
                // 2. ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (monthlyTrendChartInstance) {
                    console.log('üìà ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.monthlyTrendChartImage = await monthlyTrendChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('ÏõîÍ∞Ñ ÌÜµÍ≥Ñ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                // 3. Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ ÌÖåÏù¥Î∏î Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                const weeklyStatsTable = document.querySelector('#weekly-stats-card');
                if (weeklyStatsTable) {
                    console.log('üìä Ï£ºÏ∞®Î≥Ñ ÌÜµÍ≥Ñ ÌÖåÏù¥Î∏î Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    const weeklyCanvas = await html2canvas(weeklyStatsTable, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // Ï†ÅÏ†àÌïú Ìï¥ÏÉÅÎèÑÎ°ú Ï°∞Ï†ï
                        useCORS: true,
                        allowTaint: true,
                        width: weeklyStatsTable.offsetWidth,
                        height: weeklyStatsTable.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.weeklyStatsTableImage = weeklyCanvas.toDataURL('image/png', 1.0);
                }
                
                // 4. ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                const counselingAnalysisSection = document.querySelector('.row.g-5.g-xl-8.mb-6:last-of-type');
                if (counselingAnalysisSection) {
                    console.log('üìä ÏÉÅÎã¥Ïú†Ìòï Î∂ÑÏÑù ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    const analysisCanvas = await html2canvas(counselingAnalysisSection, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // Ï†ÅÏ†àÌïú Ìï¥ÏÉÅÎèÑÎ°ú Ï°∞Ï†ï
                        useCORS: true,
                        allowTaint: true,
                        width: counselingAnalysisSection.offsetWidth,
                        height: counselingAnalysisSection.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.counselingAnalysisSectionImage = analysisCanvas.toDataURL('image/png', 1.0);
                }
                
                // 5. ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (counselingTypesChartInstance) {
                    console.log('üçï ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.counselingTypesChartImage = await counselingTypesChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                // 6. Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (monthlyComparisonChartInstance) {
                    console.log('üìä Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.monthlyComparisonChartImage = await monthlyComparisonChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('Ï†ÑÏõî ÎåÄÎπÑ Ïã§Ï†Å ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                console.log('‚úÖ Î™®Îì† Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å');
                
                // ÌååÎùºÎØ∏ÌÑ∞ Ï§ÄÎπÑ
                const yearMonth = document.getElementById('monthly_datepicker').value;
                const params = {
                    yearMonth: yearMonth,
                    ...images
                };
                
                // ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ (Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
                await downloadMonthlyExcelWithImages(params);
                
            } catch (error) {
                console.error('‚ùå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                showToast('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Ïù¥ÎØ∏ÏßÄÎ•º Ìè¨Ìï®Ìïú ÏõîÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠
        async function downloadMonthlyExcelWithImages(params) {
            try {
                showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...', 'info');
                
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                
                const response = await fetch('/stat/monthly/excel-with-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    // ÌååÏùº Îã§Ïö¥Î°úÎìú
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ÏõîÍ∞ÑÏö¥ÏòÅÌòÑÌô©_' + params.yearMonth + '.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
                }
                
            } catch (error) {
                console.error('‚ùå ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                showToast('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;
            
            switch (type) {
                case 'success':
                    toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                default:
                    toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }
        
        // Ï¥àÍ∏∞ Ï∞®Ìä∏Îäî Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå
    </script>
    <!--end::Javascript-->
</div>
</html> 