<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- 월별 선택 플러그인 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">월간 운영현황</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">통계</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">월간 운영현황</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 월 선택 영역 -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">월간 운영현황 조회</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-200px" placeholder="월 선택" id="monthly_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">조회</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1.월간 요약 통계 -->
                <div class="row g-5 g-xl-8 mb-6">
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">154</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">총콜</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">12% 증가</div>
                                    <div class="fw-bold text-gray-600">전월 대비</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">82.5%</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">응대율</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-danger flex-grow-1 fw-bold">-2.5% 감소</div>
                                    <div class="fw-bold text-gray-600">전월 대비</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">87</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">상담완료 건수</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">5% 증가</div>
                                    <div class="fw-bold text-gray-600">전월 대비</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3">
                        <div class="card card-flush h-md-100">
                            <div class="card-header pt-5">
                                <div class="card-title d-flex flex-column">
                                    <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">-</span>
                                    <span class="text-gray-600 pt-1 fw-semibold fs-6">미구현</span>
                                </div>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-end pe-0">
                                <div class="d-flex fs-6 fw-semibold align-items-center">
                                    <div class="text-success flex-grow-1 fw-bold">-</div>
                                    <div class="fw-bold text-gray-600">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.월간 통계 추이 -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.월간 통계 추이</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_monthly_trend_chart" style="height: 350px;"></div>
                    </div>
                </div>

                <!-- 3.주차별 통계 -->
                <div class="card card-flush mb-6" id="weekly-stats-card">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">3.주차별 통계</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>일자</th>
                                    <th>총콜</th>
                                    <th>중복제거호</th>
                                    <th>응대호</th>
                                    <th>포기호</th>
                                    <th>부재호</th>
                                    <th>총상담완료호</th>
                                    <th>수신호</th>
                                    <th>발신호</th>
                                    <th>응대율</th>
                                    <th>완료율</th>
                                    <th>수신비율</th>
                                    <th>발신비율</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <!-- 데이터는 JavaScript에서 동적으로 채워집니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4.상담유형 분석 -->
                <div class="row g-5 g-xl-8 mb-6">
                    <!-- 파이 차트 -->
                    <div class="col-xl-6">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">4.상담유형 분석</span>
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="kt_monthly_counseling_types" class="min-h-auto" style="height: 350px"></div>
                            </div>
                        </div>
                    </div>
                    <!-- 데이터 테이블 -->
                    <div class="col-xl-6">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">상담유형 상세 내역</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>상담유형</th>
                                            <th>상담수</th>
                                            <th>비율</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center">
                                        <!-- 데이터는 JavaScript에서 동적으로 채워집니다 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5.전월 대비 실적 비교 -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">5.전월 대비 실적 비교</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_monthly_comparison_chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // 월 선택 초기화 (현재 월로 기본 설정)
        var currentDate = new Date();
        var currentYearMonth = currentDate.getFullYear() + "-" + 
                               String(currentDate.getMonth() + 1).padStart(2, '0');
        
        $("#monthly_datepicker").flatpickr({
            altInput: true,
            altFormat: "F Y",
            dateFormat: "Y-m",
            defaultDate: currentYearMonth,
            plugins: []
        });

        // 페이지 로드 시 초기 데이터 로드
        $(document).ready(function() {
            var initialDate = $("#monthly_datepicker").val();
            if (initialDate) {
                fetchMonthlyOperationData(initialDate);
            }
        });

        // 검색 버튼 이벤트
        document.getElementById('searchBtn').addEventListener('click', function() {
            var yearMonth = document.getElementById('monthly_datepicker').value;
            console.log('검색 버튼 클릭됨: ' + yearMonth);
            
            if (yearMonth) {
                fetchMonthlyOperationData(yearMonth);
            } else {
                alert('월을 선택해주세요.');
            }
        });
        
        // 월간 운영현황 데이터 조회 함수
        function fetchMonthlyOperationData(yearMonth) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            $.ajax({
                url: '/stat/monthly/search',
                type: 'POST',
                data: {
                    yearMonth: yearMonth
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    console.log('월간 데이터 수신 성공:', response);
                    
                    // 디버깅: 주차별 데이터 확인
                    if (response && response.weeklyStatsList) {
                        console.log('주차별 통계 데이터:', response.weeklyStatsList);
                    } else {
                        console.error('주차별 통계 데이터가 없습니다.');
                    }
                    
                    if (response) {
                        // 1. 월간 요약 통계 업데이트
                        updateMonthlySummary(response.summaryStats, response.yearlyComparisonData);
                        // 2. 월간 통계 추이 차트 업데이트
                        updateMonthlyTrendChart(response.dailyStatsList);
                        // 3. 주차별 통계 업데이트
                        updateWeeklyTable(response.weeklyStatsList);
                        // 4. 상담유형 분석 업데이트
                        updateCounselingTypeAnalysis(response.counselingTypeStats);
                        // 5. 전월 대비 실적 비교 차트 업데이트
                        updateMonthlyComparisonChart(response.yearlyComparisonData);
                    } else {
                        console.error('수신된 데이터가 비어있습니다.');
                        // 오류 알림
                        alert('데이터를 불러오는데 실패했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('월간 데이터 조회 실패:', error);
                    console.error('상태 코드:', xhr.status);
                    console.error('응답 텍스트:', xhr.responseText);
                    alert('데이터 조회 중 오류가 발생했습니다.');
                }
            });
        }
        
        // 1. 월간 요약 통계 업데이트 함수
        function updateMonthlySummary(summaryStats, comparisonData) {
            if (!summaryStats) return;
            
            // 총 통화 건수
            $('.col-xl-3:eq(0) .fs-2hx').text(formatNumber(summaryStats.totalCalls || 0));
            
            // 응대율 (완료율) - 값이 제대로 전달되지 않을 경우 직접 계산
            var answerRate = summaryStats.answerRate;
            if (answerRate === null || answerRate === undefined || answerRate === 0) {
                var totalCalls = summaryStats.totalCalls || 0;
                var answeredCalls = summaryStats.answeredCalls || 0;
                var abandonedCalls = summaryStats.abandonedCalls || 0;
                
                // 백엔드 계산 로직과 일치: (응대호 / (총콜 - 포기호)) * 100
                var totalCallsForRate = totalCalls - abandonedCalls;
                answerRate = (totalCallsForRate > 0) ? ((answeredCalls / totalCallsForRate) * 100) : 0;
                console.log('응대율 직접 계산:', answerRate.toFixed(1) + '%', 
                           '응답 콜:', answeredCalls, 
                           '총 콜:', totalCalls, 
                           '포기호:', abandonedCalls,
                           '계산용 총콜:', totalCallsForRate);
            }
            $('.col-xl-3:eq(1) .fs-2hx').text((answerRate || 0).toFixed(1) + '%');
            
            // 상담완료 건수 (총 응답 건수)
            $('.col-xl-3:eq(2) .fs-2hx').text(formatNumber(summaryStats.completedCounselingCalls || 0));
            
            // 평균 통화 시간 (초 -> 분:초 변환) - 미구현
            $('.col-xl-3:eq(3) .fs-2hx').text('-');
            
            // 증감률 계산 및 표시
            if (comparisonData) {
                // 총 통화 증감률
                var callRateChange = comparisonData.totalCallsComparisonRate;
                if (callRateChange === null || callRateChange === undefined) {
                    callRateChange = 0;
                }
                var callRateText = (callRateChange >= 0 ? 
                    callRateChange.toFixed(1) + '% 증가' : 
                    Math.abs(callRateChange).toFixed(1) + '% 감소');
                var callRateClass = callRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(0) .flex-grow-1').text(callRateText).removeClass('text-success text-danger').addClass(callRateClass);
                
                // 응대율 증감률
                var answerRateChange = comparisonData.answerRateComparisonRate;
                if (answerRateChange === null || answerRateChange === undefined) {
                    answerRateChange = 0;
                }
                var answerRateText = (answerRateChange >= 0 ? 
                    answerRateChange.toFixed(1) + '% 증가' : 
                    Math.abs(answerRateChange).toFixed(1) + '% 감소');
                var answerRateClass = answerRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(1) .flex-grow-1').text(answerRateText).removeClass('text-success text-danger').addClass(answerRateClass);
                
                // 상담완료 건수 증감률
                var completeCallRateChange = comparisonData.completedCounselingCallsComparisonRate;
                if (completeCallRateChange === null || completeCallRateChange === undefined) {
                    completeCallRateChange = 0;
                }
                var completeCallRateText = (completeCallRateChange >= 0 ? 
                    completeCallRateChange.toFixed(1) + '% 증가' : 
                    Math.abs(completeCallRateChange).toFixed(1) + '% 감소');
                var completeCallRateClass = completeCallRateChange >= 0 ? 'text-success' : 'text-danger';
                $('.col-xl-3:eq(2) .flex-grow-1').text(completeCallRateText).removeClass('text-success text-danger').addClass(completeCallRateClass);
            }
        }
        
        // 초를 MM:SS 형식으로 변환하는 헬퍼 함수
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            var minutes = Math.floor(seconds / 60);
            var remainingSeconds = Math.floor(seconds % 60);
            return minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
        }
        
        // 숫자 포맷 함수 (천단위 콤마)
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // 2. 월간 통계 추이 차트 업데이트 함수
        var monthlyTrendChartInstance = null;
        function updateMonthlyTrendChart(dailyStatsList) {
            var monthlyTrendElement = document.getElementById('kt_monthly_trend_chart');
            if (!monthlyTrendElement || !dailyStatsList || dailyStatsList.length === 0) return;
            
            // 데이터 추출
            var categories = [];
            var callsData = [];
            var answerRateData = [];
            
            dailyStatsList.forEach(function(stat) {
                // 날짜에서 일자만 추출 (MM-DD 형식)
                var dateStr = stat.statDate;
                var shortDate = dateStr.substring(5); // "YYYY-MM-DD" -> "MM-DD"
                
                // 주말 제외 (토요일: 6, 일요일: 0)
                var date = new Date(dateStr);
                var dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    categories.push(shortDate);
                    callsData.push(stat.totalCalls || 0);
                    
                    // 응대율 사용 (completionRate 대신)
                    var answerRate = stat.answerRate;
                    // 응대율 값이 null이거나 undefined인 경우 직접 계산
                    if (answerRate === undefined || answerRate === null) {
                        var totalCalls = stat.totalCalls || 0;
                        var answeredCalls = stat.answeredCalls || 0;
                        var abandonedCalls = stat.abandonedCalls || 0;
                        var totalCallsForRate = totalCalls - abandonedCalls;
                        answerRate = (totalCallsForRate > 0) ? ((answeredCalls / totalCallsForRate) * 100) : 0;
                    }
                    answerRateData.push(answerRate || 0);
                }
            });
            
            var monthlyTrendOptions = {
                series: [{
                    name: '통화건수',
                    type: 'column',
                    data: callsData
                }, {
                    name: '응대율',
                    type: 'line',
                    data: answerRateData
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    stacked: false
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    width: [0, 3]
                },
                title: {
                    text: '월간 일별 통화건수 및 응대율 (평일 기준)',
                    align: 'left'
                },
                xaxis: {
                    categories: categories
                },
                yaxis: [{
                    title: {
                        text: '통화건수',
                    },
                    decimalsInFloat: 1
                }, {
                    opposite: true,
                    title: {
                        text: '응대율(%)'
                    },
                    decimalsInFloat: 1
                }],
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (opts.seriesIndex === 0) {
                                return val + " 건";
                            } else if (opts.seriesIndex === 1) {
                                return val.toFixed(1) + "%";
                            }
                            return val;
                        }
                    }
                },
                fill: {
                    opacity: [0.85, 1],
                    colors: ['#009ef7', '#ff6384']
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -25
                }
            };
            
            if (monthlyTrendChartInstance) {
                monthlyTrendChartInstance.updateOptions(monthlyTrendOptions);
            } else {
                monthlyTrendChartInstance = new ApexCharts(monthlyTrendElement, monthlyTrendOptions);
                monthlyTrendChartInstance.render();
            }
        }
        
        // 3. 주차별 통계 테이블 업데이트 함수
        function updateWeeklyTable(weeklyStatsList) {
            console.log('updateWeeklyTable 함수 호출됨. 데이터:', weeklyStatsList);
            
            if (!weeklyStatsList || weeklyStatsList.length === 0) {
                console.error('주차별 통계 데이터가 없거나 비어있습니다.');
                $('#weekly-stats-card tbody').html('<tr><td colspan="13" class="text-center">데이터가 없습니다</td></tr>');
                return;
            }
            
            var tbody = $('#weekly-stats-card tbody');
            tbody.empty();
            
            var totalCalls = 0;
            var totalUniqueInbound = 0;
            var totalAnswered = 0;
            var totalAbandoned = 0;
            var totalBusy = 0;
            var totalCompleted = 0;
            var totalInbound = 0;
            var totalOutbound = 0;
            
            // 주차별 데이터 행 추가
            weeklyStatsList.forEach(function(stat, index) {
                console.log('주차 데이터 처리 중:', index + 1, stat);
                
                // 값 가져오기
                var statTotalCalls = stat.totalCalls || 0;
                var uniqueInbound = stat.uniqueInboundCalls || 0;
                var answered = stat.answeredCalls || 0;
                var abandoned = stat.abandonedCalls || 0;
                var busy = stat.busyCalls || 0;
                var completed = stat.completedCounselingCalls || 0;
                var inbound = stat.inboundCalls || 0;
                var outbound = stat.outboundCalls || 0;
                
                // 비율 값 가져오기 (백엔드에서 계산된 값 또는 직접 계산)
                var answerRate = stat.answerRate !== undefined ? stat.answerRate : 
                                (statTotalCalls > 0 ? (answered / statTotalCalls * 100) : 0);
                var completionRate = stat.completionRate !== undefined ? stat.completionRate : 
                                    (answered > 0 ? (completed / answered * 100) : 0);
                var inboundRate = stat.inboundRate !== undefined ? stat.inboundRate : 
                                 (statTotalCalls > 0 ? (inbound / statTotalCalls * 100) : 0);
                var outboundRate = stat.outboundRate !== undefined ? stat.outboundRate : 
                                  (statTotalCalls > 0 ? (outbound / statTotalCalls * 100) : 0);
                
                // 합계 계산
                totalCalls += statTotalCalls;
                totalUniqueInbound += uniqueInbound;
                totalAnswered += answered;
                totalAbandoned += abandoned;
                totalBusy += busy;
                totalCompleted += completed;
                totalInbound += inbound;
                totalOutbound += outbound;
                
                // 주차 라벨 - 백엔드 값 무시하고 인덱스+1로 순차적으로 표시
                var weekLabel = (index + 1) + '주차';
                
                var row = `<tr>
                    <td>${weekLabel}</td>
                    <td>${formatNumber(statTotalCalls)}</td>
                    <td>${formatNumber(uniqueInbound)}</td>
                    <td>${formatNumber(answered)}</td>
                    <td>${formatNumber(abandoned)}</td>
                    <td>${formatNumber(busy)}</td>
                    <td>${formatNumber(completed)}</td>
                    <td>${formatNumber(inbound)}</td>
                    <td>${formatNumber(outbound)}</td>
                    <td>${(answerRate || 0).toFixed(1)}%</td>
                    <td>${(completionRate || 0).toFixed(1)}%</td>
                    <td>${(inboundRate || 0).toFixed(1)}%</td>
                    <td>${(outboundRate || 0).toFixed(1)}%</td>
                </tr>`;
                
                tbody.append(row);
            });
            
            // 합계 행 계산
            var totalAnswerRate = (totalAnswered > 0 && totalCalls > 0) ? ((totalAnswered / totalCalls) * 100) : 0;
            var totalCompletionRate = (totalCompleted > 0 && totalAnswered > 0) ? ((totalCompleted / totalAnswered) * 100) : 0;
            var totalInboundRate = (totalInbound > 0 && totalCalls > 0) ? ((totalInbound / totalCalls) * 100) : 0;
            var totalOutboundRate = (totalOutbound > 0 && totalCalls > 0) ? ((totalOutbound / totalCalls) * 100) : 0;
            
            // 합계 행 추가
            var totalRow = `<tr class="fw-bold bg-light-primary">
                <td>합계</td>
                <td>${formatNumber(totalCalls)}</td>
                <td>${formatNumber(totalUniqueInbound)}</td>
                <td>${formatNumber(totalAnswered)}</td>
                <td>${formatNumber(totalAbandoned)}</td>
                <td>${formatNumber(totalBusy)}</td>
                <td>${formatNumber(totalCompleted)}</td>
                <td>${formatNumber(totalInbound)}</td>
                <td>${formatNumber(totalOutbound)}</td>
                <td>${(totalAnswerRate || 0).toFixed(1)}%</td>
                <td>${(totalCompletionRate || 0).toFixed(1)}%</td>
                <td>${(totalInboundRate || 0).toFixed(1)}%</td>
                <td>${(totalOutboundRate || 0).toFixed(1)}%</td>
            </tr>`;
            
            tbody.append(totalRow);
            console.log('주차별 통계 테이블 업데이트 완료');
        }
        
        // 4. 상담유형 분석 업데이트 함수
        var counselingTypesChartInstance = null;
        function updateCounselingTypeAnalysis(counselingTypeStats) {
            if (!counselingTypeStats || counselingTypeStats.length === 0) return;
            
            // 차트 데이터 준비
            var chartSeries = [];
            var chartLabels = [];
            
            // 테이블 업데이트
            var tbody = $('.col-xl-6:eq(1) tbody');
            tbody.empty();
            
            counselingTypeStats.forEach(function(stat) {
                // 테이블 행 추가
                var row = `<tr>
                    <td>${stat.counselingTypeName || '기타'}</td>
                    <td>${stat.count || 0}</td>
                    <td>${(stat.percentage || 0).toFixed(1)}%</td>
                </tr>`;
                
                tbody.append(row);
                
                // 차트 데이터 추가
                chartLabels.push(stat.counselingTypeName || '기타');
                chartSeries.push(stat.count || 0);
            });
            
            // 파이 차트 업데이트
            var counselingTypesElement = document.getElementById('kt_monthly_counseling_types');
            if (!counselingTypesElement) return;
            
            var counselingTypesOptions = {
                series: chartSeries,
                chart: {
                    type: 'pie',
                    height: 350
                },
                labels: chartLabels,
                colors: ['#fe5151', '#5ead60', '#7250e7', '#efc22e', '#487eb3'],
                legend: {
                    position: 'bottom'
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };
            
            if (counselingTypesChartInstance) {
                counselingTypesChartInstance.updateOptions(counselingTypesOptions);
            } else {
                counselingTypesChartInstance = new ApexCharts(counselingTypesElement, counselingTypesOptions);
                counselingTypesChartInstance.render();
            }
        }
        
        // 5. 전월 대비 실적 비교 차트 업데이트 함수
        var monthlyComparisonChartInstance = null;
        function updateMonthlyComparisonChart(yearlyComparison) {
            if (!yearlyComparison) return;
            
            var monthlyComparisonElement = document.getElementById('kt_monthly_comparison_chart');
            if (!monthlyComparisonElement) return;
            
            // 데이터 가져오기
            var currentTotalCalls = yearlyComparison.totalCallsCurrentYear || 0;
            var previousTotalCalls = yearlyComparison.totalCallsPreviousYear || 0;
            var currentCompletedCalls = yearlyComparison.cmplCslCurrYr || 0;
            var previousCompletedCalls = yearlyComparison.cmplCslPrevYr || 0;
            
            // 응답률 계산
            var currentCompletionRate = yearlyComparison.currentCompletionRate || 0;
            var previousCompletionRate = yearlyComparison.previousCompletionRate || 0;
            
            var monthlyComparisonOptions = {
                series: [{
                    name: '이번 달',
                    data: [currentTotalCalls, currentCompletedCalls, currentCompletionRate]
                }, {
                    name: '전월',
                    data: [previousTotalCalls, previousCompletedCalls, previousCompletionRate]
                }],
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: ['총 통화건수', '완료건수', '응답률(%)'],
                },
                yaxis: {
                    title: {
                        text: '건수'
                    },
                    decimalsInFloat: 1
                },
                fill: {
                    opacity: 1,
                    colors: ['#009ef7', '#ff6384']
                },
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (opts.dataPointIndex === 2) {
                                return val.toFixed(1) + "%";
                            }
                            return val + " 건";
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                }
            };
            
            if (monthlyComparisonChartInstance) {
                monthlyComparisonChartInstance.updateOptions(monthlyComparisonOptions);
            } else {
                monthlyComparisonChartInstance = new ApexCharts(monthlyComparisonElement, monthlyComparisonOptions);
                monthlyComparisonChartInstance.render();
            }
        }
        
        // 초기 차트는 데이터 로드 후 업데이트되므로 여기서는 생성하지 않음
    </script>
    <!--end::Javascript-->
</div>
</html> 