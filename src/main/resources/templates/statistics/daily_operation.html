<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">ì¼ì¼ ìš´ì˜í˜„í™©</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">í†µê³„</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ì¼ì¼ ìš´ì˜í˜„í™©</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 1.í†µê³„ í˜„í™© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">1.í†µê³„ í˜„í™©</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-250px" placeholder="ë‚ ì§œ ì„ íƒ" id="daily_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">ì¡°íšŒ</button>
                                <button type="button" class="btn btn-success ms-3" id="excelDownloadBtn">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ì¼ì</th>
                                    <th>ì´ì½œ</th>
                                    <th>ì¤‘ë³µì œê±°í˜¸</th>
                                    <th>ì‘ëŒ€í˜¸</th>
                                    <th>í¬ê¸°í˜¸</th>
                                    <th>ë¶€ì¬í˜¸</th>
                                    <th>ì´ìƒë‹´ì™„ë£Œí˜¸</th>
                                    <th>ìˆ˜ì‹ í˜¸</th>
                                    <th>ë°œì‹ í˜¸</th>
                                    <th>ì‘ëŒ€ìœ¨</th>
                                    <th>ì™„ë£Œìœ¨</th>
                                    <th>ìˆ˜ì‹ ë¹„ìœ¨</th>
                                    <th>ë°œì‹ ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="summaryStatsBody">
                                <tr>
                                    <td id="statDate">-</td>
                                    <td id="totalCalls">-</td>
                                    <td id="uniqueInboundCalls">-</td>
                                    <td id="answeredCalls">-</td>
                                    <td id="abandonedCalls">-</td>
                                    <td id="busyCalls">-</td>
                                    <td id="completedCounselingCalls">-</td>
                                    <td id="inboundCalls">-</td>
                                    <td id="outboundCalls">-</td>
                                    <td id="answerRate">-</td>
                                    <td id="completionRate">-</td>
                                    <td id="inboundRate">-</td>
                                    <td id="outboundRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2.í†µí™” ì‹œê°„ í˜„í™© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.í†µí™” ì‹œê°„ í˜„í™© (ì˜¤ëŠ˜ vs ì–´ì œ)(ë¯¸êµ¬í˜„)</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>êµ¬ë¶„</th>
                                    <th>ì˜¤ëŠ˜</th>
                                    <th>ì–´ì œ</th>
                                    <th>ì¦ê°ë¥ </th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="comparisonStatsBody">
                                <tr>
                                    <td>ì´í†µí™”ì‹œê°„(ì´ˆ)</td>
                                    <td id="todayTotalCallDuration">-</td>
                                    <td id="yesterdayTotalCallDuration">-</td>
                                    <td id="callDurationChangeRate">-</td>
                                </tr>
                                <tr>
                                    <td>í‰ê· í†µí™”ì‹œê°„(ì´ˆ)</td>
                                    <td id="todayAvgCallDuration">-</td>
                                    <td id="yesterdayAvgCallDuration">-</td>
                                    <td id="avgCallDurationChangeRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3.ìƒë‹´ìœ í˜• ìƒë‹´í˜„í™© -->
                <div class="row g-5 g-xl-8">
                    <div class="col-xl-5">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">3.ìƒë‹´ìœ í˜• ìƒë‹´í˜„í™©</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>ìƒë‹´ìœ í˜•ëª…</th>
                                            <th>ìƒë‹´ìˆ˜</th>
                                            <th>ë¹„ìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="counselingTypeStatsTableBody">
                                        <tr><td colspan="3">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card card-flush h-xl-100">
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div id="kt_chart_counseling_types" class="min-h-auto" style="height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.ì¡°íšŒì¼ì ì‹œê°„ëŒ€ë³„ ê·¸ë˜í”„ -->
                <div class="card card-flush mt-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">4.ì¡°íšŒì¼ì ì‹œê°„ëŒ€ë³„ ê·¸ë˜í”„ (9ì‹œ~19ì‹œ)</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-12">
                                <div id="kt_chart_hourly_calls" class="min-h-auto" style="height: 350px"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // ë‚ ì§œ ì„ íƒ ì´ˆê¸°í™”
        $("#daily_datepicker").flatpickr({
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                // ë‚ ì§œ ì„ íƒ ì‹œ ì½˜ì†”ì— ì„ íƒëœ ë‚ ì§œ í˜•ì‹ ë¡œê¹…
                console.log("ì„ íƒëœ ë‚ ì§œ:", dateStr);
                console.log("Date ê°ì²´:", selectedDates[0]);
            }
        });

        // CSRF í† í°
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        
        // ì–´ì œ ë‚ ì§œ ê³„ì‚° (í‰ì¼ ê¸°ì¤€: ì–´ì œê°€ ì¼ìš”ì¼ì´ë©´ ê¸ˆìš”ì¼, í† ìš”ì¼ì´ë©´ ê¸ˆìš”ì¼)
        function getYesterdayBusinessDate(date) {
            try {
                // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
                let today;
                
                // dateê°€ ì—†ëŠ” ê²½ìš° í˜„ì¬ ë‚ ì§œ ì‚¬ìš©
                if (!date) {
                    today = new Date();
                }
                // dateê°€ ë¬¸ìì—´ì¸ ê²½ìš° (YYYYMMDD í˜•ì‹)
                else if (typeof date === 'string' && date.match(/^\d{8}$/)) {
                    const year = parseInt(date.substring(0, 4));
                    const month = parseInt(date.substring(4, 6)) - 1; // JavaScriptëŠ” ì›”ì´ 0ë¶€í„° ì‹œì‘
                    const day = parseInt(date.substring(6, 8));
                    today = new Date(year, month, day);
                }
                // dateê°€ ë¬¸ìì—´ì¸ ê²½ìš° (ê¸°íƒ€ í˜•ì‹)
                else if (typeof date === 'string') {
                    today = new Date(date);
                }
                // dateê°€ Date ê°ì²´ì¸ ê²½ìš°
                else if (date instanceof Date) {
                    today = new Date(date);
                }
                // ê¸°íƒ€ íƒ€ì…ì¸ ê²½ìš°
                else {
                    console.warn("ì•Œ ìˆ˜ ì—†ëŠ” ë‚ ì§œ í˜•ì‹:", date);
                    today = new Date();
                }
                
                // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
                if (isNaN(today.getTime())) {
                    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:", date);
                    return new Date(); // ì˜¤ë¥˜ ì‹œ í˜„ì¬ ë‚ ì§œ ë°˜í™˜
                }
                
                let yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // ì–´ì œê°€ ì¼ìš”ì¼(0)ì¸ ê²½ìš° -> ê¸ˆìš”ì¼(-2)ë¡œ ì„¤ì •
                if (yesterday.getDay() === 0) {
                    yesterday.setDate(yesterday.getDate() - 2);
                } 
                // ì–´ì œê°€ í† ìš”ì¼(6)ì¸ ê²½ìš° -> ê¸ˆìš”ì¼(-1)ë¡œ ì„¤ì •
                else if (yesterday.getDay() === 6) {
                    yesterday.setDate(yesterday.getDate() - 1);
                }
                
                return yesterday;
            } catch (error) {
                console.error("ë‚ ì§œ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                return new Date(); // ì˜¤ë¥˜ ì‹œ í˜„ì¬ ë‚ ì§œ ë°˜í™˜
            }
        }

        // ë‚ ì§œ í¬ë§· ë³€ê²½ í•¨ìˆ˜ (YYYYMMDD í˜•ì‹ìœ¼ë¡œ)
        function formatDateToYYYYMMDD(dateString) {
            try {
                // dateStringì´ ì—†ëŠ” ê²½ìš°
                if (!dateString) {
                    console.error("ë‚ ì§œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                    return formatCurrentDate();
                }
                
                // Date ê°ì²´ê°€ ì „ë‹¬ëœ ê²½ìš° ì§ì ‘ ì²˜ë¦¬
                if (dateString instanceof Date) {
                    const year = dateString.getFullYear();
                    const month = ('0' + (dateString.getMonth() + 1)).slice(-2);
                    const day = ('0' + dateString.getDate()).slice(-2);
                    return `${year}${month}${day}`;
                }
                
                // ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜ ì‹œë„
                if (typeof dateString !== 'string') {
                    console.warn("ë¬¸ìì—´ì´ ì•„ë‹Œ ê°’ì´ ì „ë‹¬ë¨:", dateString);
                    // ìˆ«ìì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜ (YYYYMMDD í˜•ì‹ì´ë©´)
                    if (typeof dateString === 'number' && String(dateString).length === 8) {
                        return String(dateString);
                    }
                    
                    // ë‹¤ë¥¸ íƒ€ì…ì€ ë¬¸ìì—´ë¡œ ë³€í™˜ ì‹œë„
                    dateString = String(dateString);
                }
                
                // ë¬¸ìì—´ì´ ì´ë¯¸ YYYYMMDD í˜•ì‹ì¸ì§€ í™•ì¸
                if (dateString.match(/^\d{8}$/)) {
                    return dateString;
                }
                
                const date = new Date(dateString);
                
                // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
                if (isNaN(date.getTime())) {
                    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:", dateString);
                    return formatCurrentDate();
                }
                
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                return `${year}${month}${day}`;
            } catch (error) {
                console.error("ë‚ ì§œ í¬ë§· ë³€í™˜ ì¤‘ ì˜¤ë¥˜:", error);
                return formatCurrentDate();
            }
        }
        
        // í˜„ì¬ ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function formatCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = ('0' + (today.getMonth() + 1)).slice(-2);
            const day = ('0' + today.getDate()).slice(-2);
            return `${year}${month}${day}`;
        }
        
        // ìˆ«ì í¬ë§· í•¨ìˆ˜ (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");
        }
        
        // ì¦ê°ë¥  ê³„ì‚° í•¨ìˆ˜
        function calculateChangeRate(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100).toFixed(1);
        }

        // í†µê³„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateSummaryStatsTable(summaryStats) {
            console.log("updateSummaryStatsTable_S ì‹œì‘, ì „ë‹¬ëœ summaryStats:", JSON.stringify(summaryStats, null, 2)); // í•¨ìˆ˜ ì‹œì‘ ì‹œ ê°ì²´ ì „ì²´ ë¡œê¹…

            if (!summaryStats) {
                console.log("updateSummaryStatsTable: summaryStatsê°€ ì—†ìŒ. ê¸°ë³¸ê°’('-')ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.");
                $('#statDate').text('-');
                $('#totalCalls').text('-');
                $('#answeredCalls').text('-');
                $('#abandonedCalls').text('-');
                $('#uniqueInboundCalls').text('-');
                $('#busyCalls').text('-');
                $('#completedCounselingCalls').text('-');
                $('#inboundCalls').text('-');
                $('#outboundCalls').text('-');
                $('#answerRate').text('-');
                $('#completionRate').text('-');
                $('#inboundRate').text('-');
                $('#outboundRate').text('-');
                return;
            }

            let displayDate = summaryStats.statDate;
            if (summaryStats.statDate && summaryStats.statDate.length === 8) {
                displayDate = `${summaryStats.statDate.substring(0,4)}-${summaryStats.statDate.substring(4,6)}-${summaryStats.statDate.substring(6,8)}`;
            }
            console.log("ì„¤ì •ê°’ statDate:", displayDate);
            $('#statDate').text(displayDate);

            console.log("ì„¤ì •ê°’ totalCalls:", formatNumber(summaryStats.totalCalls));
            $('#totalCalls').text(formatNumber(summaryStats.totalCalls));

            console.log("ì„¤ì •ê°’ answeredCalls:", formatNumber(summaryStats.answeredCalls));
            $('#answeredCalls').text(formatNumber(summaryStats.answeredCalls));

            console.log("ì„¤ì •ê°’ abandonedCalls:", formatNumber(summaryStats.abandonedCalls));
            $('#abandonedCalls').text(formatNumber(summaryStats.abandonedCalls));

            console.log("ì„¤ì •ê°’ uniqueInboundCalls:", formatNumber(summaryStats.uniqueInboundCalls));
            $('#uniqueInboundCalls').text(formatNumber(summaryStats.uniqueInboundCalls));

            console.log("ì„¤ì •ê°’ busyCalls:", formatNumber(summaryStats.busyCalls));
            $('#busyCalls').text(formatNumber(summaryStats.busyCalls));

            console.log("ì„¤ì •ê°’ completedCounselingCalls:", formatNumber(summaryStats.completedCounselingCalls));
            $('#completedCounselingCalls').text(formatNumber(summaryStats.completedCounselingCalls));
            
            console.log("ì„¤ì •ê°’ inboundCalls:", formatNumber(summaryStats.inboundCalls));
            $('#inboundCalls').text(formatNumber(summaryStats.inboundCalls));
            
            console.log("ì„¤ì •ê°’ outboundCalls:", formatNumber(summaryStats.outboundCalls));
            $('#outboundCalls').text(formatNumber(summaryStats.outboundCalls));

            const answerRateText = summaryStats.answerRate !== null ? summaryStats.answerRate.toFixed(1) + '%' : '-';
            console.log("ì„¤ì •ê°’ answerRate:", answerRateText);
            $('#answerRate').text(answerRateText);

            const completionRateText = summaryStats.completionRate !== null ? summaryStats.completionRate.toFixed(1) + '%' : '-';
            console.log("ì„¤ì •ê°’ completionRate:", completionRateText);
            $('#completionRate').text(completionRateText);
            
            const inboundRateText = summaryStats.inboundRate !== null ? summaryStats.inboundRate.toFixed(1) + '%' : '-';
            console.log("ì„¤ì •ê°’ inboundRate:", inboundRateText);
            $('#inboundRate').text(inboundRateText);
            
            const outboundRateText = summaryStats.outboundRate !== null ? summaryStats.outboundRate.toFixed(1) + '%' : '-';
            console.log("ì„¤ì •ê°’ outboundRate:", outboundRateText);
            $('#outboundRate').text(outboundRateText);
            
            console.log("updateSummaryStatsTable_E ì¢…ë£Œ");
        }

        // í†µí™” ì‹œê°„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCallTimeComparisonTable(todayStats, yesterdayStats) {
            const $tbody = $('#comparisonStatsBody');
            $tbody.empty(); // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

            // ì˜¤ëŠ˜ ë°ì´í„°
            const todayTotal = todayStats && todayStats.totalCallDurationSeconds ? todayStats.totalCallDurationSeconds : 0;
            const todayAvg = todayStats && todayStats.averageCallDurationSeconds ? todayStats.averageCallDurationSeconds : 0;
            
            // ì–´ì œ ë°ì´í„°
            const yesterdayTotal = yesterdayStats && yesterdayStats.totalCallDurationSeconds ? yesterdayStats.totalCallDurationSeconds : 0;
            const yesterdayAvg = yesterdayStats && yesterdayStats.averageCallDurationSeconds ? yesterdayStats.averageCallDurationSeconds : 0;
            
            // ì¦ê°ë¥  ê³„ì‚°
            const totalChangeRate = calculateChangeRate(todayTotal, yesterdayTotal);
            const avgChangeRate = calculateChangeRate(todayAvg, yesterdayAvg);
            
            // ì´í†µí™”ì‹œê°„ í–‰
            const totalRow = `<tr>
                              <td>ì´í†µí™”ì‹œê°„(ì´ˆ)</td>
                              <td id="todayTotalCallDuration">${formatNumber(todayTotal)}</td>
                              <td id="yesterdayTotalCallDuration">${formatNumber(yesterdayTotal)}</td>
                              <td id="callDurationChangeRate" class="${totalChangeRate > 0 ? 'text-success' : (totalChangeRate < 0 ? 'text-danger' : '')}">${totalChangeRate}%</td>
                           </tr>`;
            $tbody.append(totalRow);
            
            // í‰ê· í†µí™”ì‹œê°„ í–‰
            const avgRow = `<tr>
                            <td>í‰ê· í†µí™”ì‹œê°„(ì´ˆ)</td>
                            <td id="todayAvgCallDuration">${todayAvg.toFixed(1)}</td>
                            <td id="yesterdayAvgCallDuration">${yesterdayAvg.toFixed(1)}</td>
                            <td id="avgCallDurationChangeRate" class="${avgChangeRate > 0 ? 'text-success' : (avgChangeRate < 0 ? 'text-danger' : '')}">${avgChangeRate}%</td>
                          </tr>`;
            $tbody.append(avgRow);
        }

        // ìƒë‹´ ìœ í˜• í˜„í™© í…Œì´ë¸” ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCounselingTypeStats(counselingTypeStatsList) {
            const $tbody = $('#counselingTypeStatsTableBody');
            $tbody.empty(); 

            if (!counselingTypeStatsList || counselingTypeStatsList.length === 0) {
                $tbody.append('<tr><td colspan="3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                // TODO: ì°¨íŠ¸ë„ ë¹„ìš°ê±°ë‚˜ ìˆ¨ê¹€ ì²˜ë¦¬ (ApexCharts ì‚¬ìš© ì‹œ)
                // ì˜ˆ: if (counselingTypeChart) counselingTypeChart.updateSeries([{ data: [] }]);
                return;
            }

            let chartSeriesData = [];
            let chartLabels = [];

            counselingTypeStatsList.forEach(stat => {
                const row = `<tr>
                                <td>${stat.counselingTypeName || stat.counselingType}</td>
                                <td>${formatNumber(stat.count)}</td>
                                <td>${stat.percentage !== null ? stat.percentage.toFixed(1) + '%' : '-'}</td>
                            </tr>`;
                $tbody.append(row);
                chartLabels.push(stat.counselingTypeName || stat.counselingType);
                chartSeriesData.push(stat.count);
            });

            // ApexCharts ì—…ë°ì´íŠ¸
            if (typeof ApexCharts !== 'undefined' && counselingTypeChart) {
                counselingTypeChart.updateOptions({
                    series: chartSeriesData,
                    labels: chartLabels
                });
            } else {
                console.warn("ApexCharts ë˜ëŠ” counselingTypeChart ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        }
        
        var counselingTypeChart; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹´ì„ ë³€ìˆ˜

        // 4.ì¡°íšŒì¼ì ì‹œê°„ëŒ€ë³„ ê·¸ë˜í”„ -->
        var hourlyCallsChart; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹´ì„ ë³€ìˆ˜

        function updateHourlyCallsChart(hourlyData) {
            if (!hourlyData) {
                console.warn("Hourly data is not available.");
                if (hourlyCallsChart) hourlyCallsChart.updateSeries([{data:[]}, {data:[]}]);
                return;
            }

            // ì‹œê°„ëŒ€ë³„ ê·¸ë˜í”„ ë°ì´í„° ì—…ë°ì´íŠ¸
            if (hourlyCallsChart) {
                hourlyCallsChart.updateOptions({
                    series: [
                        { name: 'ì˜¤ëŠ˜ í†µí™”ëŸ‰', data: hourlyData.totalCalls },
                        { name: 'ì–´ì œ í†µí™”ëŸ‰', data: hourlyData.totalCallsYesterday }
                    ],
                    xaxis: {
                        categories: hourlyData.hours,
                        title: {
                            text: 'ì‹œê°„ëŒ€ (9ì‹œ~19ì‹œ)'
                        }
                    },
                    title: {
                        text: 'ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ë¹„êµ (9ì‹œ~19ì‹œ)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    }
                });
            }
        }

        // ì¼ì¼ ìš´ì˜í˜„í™© ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜
        function fetchDailyOperationData(date) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            // ë‚ ì§œ ê°ì²´ê°€ ì „ë‹¬ëœ ê²½ìš°
            if (date instanceof Date) {
                date = formatDateToYYYYMMDD(date);
            }
            
            // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
            if (!date) {
                console.error("ë‚ ì§œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ë‚ ì§œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                date = formatCurrentDate();
            }
            
            // ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYYYMMDD í˜•ì‹ì¸ì§€)
            if (typeof date !== 'string' || !date.match(/^\d{8}$/)) {
                console.error("ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹:", date);
                date = formatCurrentDate();
            }
            
            console.log('ì‚¬ìš©í•  ë‚ ì§œ:', date);
            
            // ì–´ì œ ë‚ ì§œ ê³„ì‚° (í‰ì¼ ê¸°ì¤€)
            const yesterdayDate = getYesterdayBusinessDate(date);
            const formattedYesterdayDate = formatDateToYYYYMMDD(yesterdayDate);
            
            console.log('ì˜¤ëŠ˜ ë‚ ì§œ:', date);
            console.log('ì–´ì œ ë‚ ì§œ(í‰ì¼ ê¸°ì¤€):', formattedYesterdayDate);
            
            // ë‘ ê°œì˜ AJAX ìš”ì²­ì„ ë³‘ë ¬ë¡œ ìˆ˜í–‰
            $.when(
                // ì˜¤ëŠ˜ ë°ì´í„° ìš”ì²­
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: date },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                }),
                // ì–´ì œ ë°ì´í„° ìš”ì²­
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: formattedYesterdayDate },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                })
            ).done(function(todayResponse, yesterdayResponse) {
                console.log('ì˜¤ëŠ˜ ë°ì´í„°:', todayResponse[0]);
                console.log('ì–´ì œ ë°ì´í„°:', yesterdayResponse[0]);
                
                const todayData = todayResponse[0];
                const yesterdayData = yesterdayResponse[0];
                
                if (todayData) {
                    // 1. í†µê³„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    updateSummaryStatsTable(todayData.summaryStats);
                    
                    // 2. í†µí™” ì‹œê°„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ vs ì–´ì œ)
                    updateCallTimeComparisonTable(
                        todayData.callTimeStats, 
                        yesterdayData ? yesterdayData.callTimeStats : null
                    );
                    
                    // 3. ìƒë‹´ ìœ í˜• í˜„í™© í…Œì´ë¸” ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                    updateCounselingTypeStats(todayData.counselingTypeStats);
                    
                    // 4.ì¡°íšŒì¼ì ì‹œê°„ëŒ€ë³„ ê·¸ë˜í”„ -->
                    updateHourlyCallsChart(todayData.hourlyCallsData);
                } else {
                    console.error('ì˜¤ëŠ˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }).fail(function(xhr, status, error) {
                console.error('ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë˜ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        function loadInitialDailyData() {
            try {
                const initialDate = $('#daily_datepicker').val();
                console.log("ì´ˆê¸° datepicker ê°’:", initialDate);
                
                if (initialDate) {
                    const formattedDate = formatDateToYYYYMMDD(initialDate);
                    console.log("ë³€í™˜ëœ ë‚ ì§œ í˜•ì‹:", formattedDate);
                    fetchDailyOperationData(formattedDate);
                } else {
                    // ë‚ ì§œê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° í˜„ì¬ ë‚ ì§œ ì‚¬ìš©
                    console.log("ë‚ ì§œê°€ ì„ íƒë˜ì§€ ì•Šì•„ í˜„ì¬ ë‚ ì§œ ì‚¬ìš©");
                    fetchDailyOperationData(formatCurrentDate());
                }
            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                fetchDailyOperationData(formatCurrentDate());
            }
        }

        $(document).ready(function() {
            // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            $('#searchBtn').on('click', function() {
                try {
                    const selectedDate = $('#daily_datepicker').val();
                    console.log("ì¡°íšŒ ë²„íŠ¼ í´ë¦­ - ì„ íƒëœ ë‚ ì§œ:", selectedDate);
                    
                    if (!selectedDate) {
                        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const formattedSearchDate = formatDateToYYYYMMDD(selectedDate);
                    console.log("ë³€í™˜ëœ ê²€ìƒ‰ ë‚ ì§œ:", formattedSearchDate);
                    fetchDailyOperationData(formattedSearchDate);
                } catch (error) {
                    console.error("ë‚ ì§œ ë³€í™˜ ì¤‘ ì˜¤ë¥˜:", error);
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            });

            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#excelDownloadBtn').on('click', function() {
                try {
                    const selectedDate = $('#daily_datepicker').val();
                    if (!selectedDate) {
                        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    downloadDailyOperationExcel();
                } catch (error) {
                    console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });

            // ApexCharts ì´ˆê¸°í™” - kt_chart_counseling_types
            var chartElement = document.querySelector("#kt_chart_counseling_types");
            if (chartElement && typeof ApexCharts !== 'undefined') {
                var options = {
                    series: [], 
                    chart: { width: '100%', height: 400, type: 'donut' },
                    labels: [], 
                    legend: { position: 'bottom' },
                    responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
                };
               counselingTypeChart = new ApexCharts(chartElement, options);
               counselingTypeChart.render();
            } else {
                console.error("ApexChartsë¥¼ ìœ„í•œ DOM ìš”ì†Œ(#kt_chart_counseling_types)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ApexCharts ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            // ApexCharts ì´ˆê¸°í™” - kt_chart_hourly_calls
            var hourlyChartElement = document.querySelector("#kt_chart_hourly_calls");
            if (hourlyChartElement && typeof ApexCharts !== 'undefined') {
                var hourlyOptions = {
                    series: [],
                    chart: { 
                        type: 'line', 
                        height: 350,
                        toolbar: {
                            show: true
                        },
                        zoom: {
                            enabled: true
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    colors: ['#3E97FF', '#50CD89'],
                    markers: {
                        size: 4,
                        colors: ['#3E97FF', '#50CD89'],
                        strokeColors: '#ffffff',
                        strokeWidth: 2,
                        hover: {
                            size: 7
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        row: {
                            colors: ['#f3f3f3', 'transparent'],
                            opacity: 0.5
                        }
                    },
                    xaxis: {
                        categories: [],
                        title: {
                            text: 'ì‹œê°„ëŒ€ (9ì‹œ~19ì‹œ)'
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'í†µí™”ëŸ‰ (ê±´)'
                        },
                        min: 0
                    },
                    title: {
                        text: 'ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ë¹„êµ (9ì‹œ~19ì‹œ)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right'
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(0) + " ê±´" : "0 ê±´";
                            }
                        }
                    }
                };
                hourlyCallsChart = new ApexCharts(hourlyChartElement, hourlyOptions);
                hourlyCallsChart.render();
            }

            loadInitialDailyData();
            
            // ì¼ì¼ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
            async function downloadDailyOperationExcel() {
                try {
                    console.log('ğŸ“¥ ì¼ì¼ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘...');
                    
                    // ë°ì´í„° ë¡œë”© ìƒíƒœ í™•ì¸
                    const totalCallsValue = document.getElementById('totalCalls')?.textContent?.trim();
                    if (!totalCallsValue || totalCallsValue === '-') {
                        showToast('ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”!', 'warning');
                        return;
                    }
                    
                    showToast('ì°¨íŠ¸ ì´ë¯¸ì§€ì™€ í…Œì´ë¸” ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...', 'info');
                    
                    const images = {};
                    const tableData = {};
                    
                    // ì‹¤ì œ í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘ (ì´ë¯¸ì§€ ëŒ€ì‹ )
                    console.log('ğŸ“Š í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
                    
                    // 1. í†µê³„ í˜„í™© í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘ (ID ê¸°ë°˜ìœ¼ë¡œ ê°€ë¡œí˜• ë°ì´í„°ë¥¼ ì„¸ë¡œí˜•ìœ¼ë¡œ ë³€í™˜)
                    const summaryData = [
                        { label: 'ì¼ì', value: document.getElementById('statDate')?.textContent?.trim() || '-' },
                        { label: 'ì´ì½œ', value: document.getElementById('totalCalls')?.textContent?.trim() || '-' },
                        { label: 'ì¤‘ë³µì œê±°í˜¸', value: document.getElementById('uniqueInboundCalls')?.textContent?.trim() || '-' },
                        { label: 'ì‘ëŒ€í˜¸', value: document.getElementById('answeredCalls')?.textContent?.trim() || '-' },
                        { label: 'í¬ê¸°í˜¸', value: document.getElementById('abandonedCalls')?.textContent?.trim() || '-' },
                        { label: 'ë¶€ì¬í˜¸', value: document.getElementById('busyCalls')?.textContent?.trim() || '-' },
                        { label: 'ì´ìƒë‹´ì™„ë£Œí˜¸', value: document.getElementById('completedCounselingCalls')?.textContent?.trim() || '-' },
                        { label: 'ìˆ˜ì‹ í˜¸', value: document.getElementById('inboundCalls')?.textContent?.trim() || '-' },
                        { label: 'ë°œì‹ í˜¸', value: document.getElementById('outboundCalls')?.textContent?.trim() || '-' },
                        { label: 'ì‘ëŒ€ìœ¨', value: document.getElementById('answerRate')?.textContent?.trim() || '-' },
                        { label: 'ì™„ë£Œìœ¨', value: document.getElementById('completionRate')?.textContent?.trim() || '-' },
                        { label: 'ìˆ˜ì‹ ë¹„ìœ¨', value: document.getElementById('inboundRate')?.textContent?.trim() || '-' },
                        { label: 'ë°œì‹ ë¹„ìœ¨', value: document.getElementById('outboundRate')?.textContent?.trim() || '-' }
                    ];
                    tableData.summaryTableData = summaryData;
                    console.log('âœ… í†µê³„ í˜„í™© í…Œì´ë¸” ë°ì´í„°:', summaryData);
                    
                    // 2. í†µí™” ì‹œê°„ í˜„í™© í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘ (ID ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ)
                    const comparisonData = [
                        {
                            time: 'ì´í†µí™”ì‹œê°„(ì´ˆ)',
                            today: document.getElementById('todayTotalCallDuration')?.textContent?.trim() || '-',
                            yesterday: document.getElementById('yesterdayTotalCallDuration')?.textContent?.trim() || '-',
                            change: document.getElementById('callDurationChangeRate')?.textContent?.trim() || '-'
                        },
                        {
                            time: 'í‰ê· í†µí™”ì‹œê°„(ì´ˆ)',
                            today: document.getElementById('todayAvgCallDuration')?.textContent?.trim() || '-',
                            yesterday: document.getElementById('yesterdayAvgCallDuration')?.textContent?.trim() || '-',
                            change: document.getElementById('avgCallDurationChangeRate')?.textContent?.trim() || '-'
                        }
                    ];
                    tableData.comparisonTableData = comparisonData;
                    console.log('âœ… í†µí™” ì‹œê°„ í˜„í™© í…Œì´ë¸” ë°ì´í„°:', comparisonData);
                    
                    // 3. ìƒë‹´ìœ í˜• í˜„í™© í…Œì´ë¸” ë°ì´í„° ìˆ˜ì§‘ (ì •í™•í•œ ì„ íƒì ì‚¬ìš©)
                    const counselingTableRows = document.querySelectorAll('#counselingTypeStatsTableBody tr');
                    const counselingData = [];
                    counselingTableRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3 && !cells[0].textContent.includes('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘') && !cells[0].textContent.includes('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')) {
                            counselingData.push({
                                type: cells[0].textContent.trim(),
                                count: cells[1].textContent.trim(),
                                percentage: cells[2].textContent.trim()
                            });
                        }
                    });
                    tableData.counselingTableData = counselingData;
                    console.log('âœ… ìƒë‹´ìœ í˜• í˜„í™© í…Œì´ë¸” ë°ì´í„°:', counselingData);
                    
                    // ìˆ˜ì§‘ëœ í…Œì´ë¸” ë°ì´í„° ì „ì²´ ê²€ì¦
                    console.log('ğŸ” ìˆ˜ì§‘ëœ ëª¨ë“  í…Œì´ë¸” ë°ì´í„° í™•ì¸:');
                    console.log('- í†µê³„ í˜„í™©:', tableData.summaryTableData?.length || 0, 'ê°œ í•­ëª©');
                    console.log('- í†µí™” ì‹œê°„:', tableData.comparisonTableData?.length || 0, 'ê°œ í•­ëª©');
                    console.log('- ìƒë‹´ìœ í˜•:', tableData.counselingTableData?.length || 0, 'ê°œ í•­ëª©');
                    
                    // ë¹ˆ ë°ì´í„° ì²´í¬
                    if ((tableData.summaryTableData?.length || 0) === 0) {
                        console.warn('âš ï¸ í†µê³„ í˜„í™© ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    }
                    if ((tableData.comparisonTableData?.length || 0) === 0) {
                        console.warn('âš ï¸ í†µí™” ì‹œê°„ í˜„í™© ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    }
                    if ((tableData.counselingTableData?.length || 0) === 0) {
                        console.warn('âš ï¸ ìƒë‹´ìœ í˜• í˜„í™© ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // 4. ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (ApexCharts)
                    if (counselingTypeChart) {
                        console.log('ğŸ• ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                        console.log('ğŸ• ì°¨íŠ¸ ê°ì²´ ì •ë³´:', {
                            type: typeof counselingTypeChart,
                            hasDataURI: typeof counselingTypeChart.dataURI === 'function'
                        });
                        
                        try {
                            const chartResult = await counselingTypeChart.dataURI({
                                type: 'png',
                                scale: 3,
                                width: 500,
                                height: 400
                            });
                            
                            console.log('ğŸ• ì°¨íŠ¸ ì´ë¯¸ì§€ ê²°ê³¼ íƒ€ì…:', typeof chartResult);
                            console.log('ğŸ• ì°¨íŠ¸ ì´ë¯¸ì§€ ê²°ê³¼ ìƒ˜í”Œ:', chartResult);
                            
                            // ApexCharts dataURI ê²°ê³¼ê°€ ê°ì²´ì¸ ê²½ìš° ì²˜ë¦¬
                            if (typeof chartResult === 'object' && chartResult !== null) {
                                if (chartResult.imgURI && typeof chartResult.imgURI === 'string') {
                                    images.counselingTypeChartImage = chartResult.imgURI;
                                    console.log('âœ… ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ (ê°ì²´ì—ì„œ ì¶”ì¶œ)');
                                } else {
                                    console.error('âŒ ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ í˜•ì‹ì´ ì˜ëª»ë¨:', chartResult);
                                }
                            } else if (typeof chartResult === 'string' && chartResult.startsWith('data:image/')) {
                                images.counselingTypeChartImage = chartResult;
                                console.log('âœ… ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ (ë¬¸ìì—´)');
                            } else {
                                console.error('âŒ ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ í˜•ì‹ì´ ì˜ëª»ë¨:', chartResult);
                            }
                        } catch (error) {
                            console.warn('âŒ ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                        }
                    }
                    
                    // 5. ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (ApexCharts)
                    if (hourlyCallsChart) {
                        console.log('ğŸ“Š ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                        console.log('ğŸ“Š ì°¨íŠ¸ ê°ì²´ ì •ë³´:', {
                            type: typeof hourlyCallsChart,
                            hasDataURI: typeof hourlyCallsChart.dataURI === 'function'
                        });
                        
                        try {
                            const chartResult = await hourlyCallsChart.dataURI({
                                type: 'png',
                                scale: 3,
                                width: 800,
                                height: 350
                            });
                            
                            console.log('ğŸ“Š ì°¨íŠ¸ ì´ë¯¸ì§€ ê²°ê³¼ íƒ€ì…:', typeof chartResult);
                            console.log('ğŸ“Š ì°¨íŠ¸ ì´ë¯¸ì§€ ê²°ê³¼ ìƒ˜í”Œ:', chartResult);
                            
                            // ApexCharts dataURI ê²°ê³¼ê°€ ê°ì²´ì¸ ê²½ìš° ì²˜ë¦¬
                            if (typeof chartResult === 'object' && chartResult !== null) {
                                if (chartResult.imgURI && typeof chartResult.imgURI === 'string') {
                                    images.hourlyCallsChartImage = chartResult.imgURI;
                                    console.log('âœ… ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ (ê°ì²´ì—ì„œ ì¶”ì¶œ)');
                                } else {
                                    console.error('âŒ ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ í˜•ì‹ì´ ì˜ëª»ë¨:', chartResult);
                                }
                            } else if (typeof chartResult === 'string' && chartResult.startsWith('data:image/')) {
                                images.hourlyCallsChartImage = chartResult;
                                console.log('âœ… ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ (ë¬¸ìì—´)');
                            } else {
                                console.error('âŒ ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ í˜•ì‹ì´ ì˜ëª»ë¨:', chartResult);
                            }
                        } catch (error) {
                            console.warn('âŒ ì‹œê°„ëŒ€ë³„ í†µí™”ëŸ‰ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                        }
                    }
                    
                    console.log('âœ… ëª¨ë“  ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ');
                    console.log('ğŸ“Š ìƒì„±ëœ ì´ë¯¸ì§€ ì •ë³´:', {
                        counselingTypeChartImage: !!images.counselingTypeChartImage,
                        hourlyCallsChartImage: !!images.hourlyCallsChartImage
                    });
                    
                    // ìµœì¢… ì´ë¯¸ì§€ ë°ì´í„° ê²€ì¦
                    console.log('ğŸ” ìµœì¢… ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼ í™•ì¸:');
                    Object.keys(images).forEach(key => {
                        const image = images[key];
                        if (image && typeof image === 'string' && image.startsWith('data:image/')) {
                            console.log(`âœ… ${key}: í¬ê¸° ${image.length}, ì‹œì‘ ë¶€ë¶„: ${image.substring(0, 50)}...`);
                        } else {
                            console.log(`âŒ ${key}: ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ë°ì´í„°`);
                        }
                    });
                    
                    // íŒŒë¼ë¯¸í„° ì¤€ë¹„
                    const selectedDate = $('#daily_datepicker').val();
                    const params = {
                        date: formatDateToYYYYMMDD(selectedDate),
                        ...images,
                        ...tableData
                    };
                    
                    // ì„œë²„ë¡œ POST ìš”ì²­ (ì´ë¯¸ì§€ì™€ í…Œì´ë¸” ë°ì´í„° í¬í•¨)
                    await downloadDailyExcelWithTableData(params);
                    
                } catch (error) {
                    console.error('âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                    showToast('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // í…Œì´ë¸” ë°ì´í„°ì™€ ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ì¼ì¼ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­
            async function downloadDailyExcelWithTableData(params) {
                try {
                    showToast('í…Œì´ë¸” ë°ì´í„°ì™€ ì°¨íŠ¸ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                    
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    
                    const response = await fetch('/stat/daily/excel-with-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(params)
                    });
                    
                    if (response.ok) {
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ì¼ì¼ìš´ì˜í˜„í™©_' + params.date + '.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showToast('ì¼ì¼ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                    }
                    
                } catch (error) {
                    console.error('âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                    showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ì¼ì¼ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­ (ê¸°ì¡´ - í˜¸í™˜ì„± ìœ ì§€)
            async function downloadDailyExcelWithImages(params) {
                try {
                    showToast('ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                    
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    
                    const response = await fetch('/stat/daily/excel-with-images', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(params)
                    });
                    
                    if (response.ok) {
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ì¼ì¼ìš´ì˜í˜„í™©_' + params.date + '.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showToast('ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                    }
                    
                } catch (error) {
                    console.error('âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                    showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showToast(message, type = 'info') {
                const existingToast = document.querySelector('.toast-message');
                if (existingToast) {
                    existingToast.remove();
                }
                
                const toast = document.createElement('div');
                toast.className = `toast-message toast-${type}`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 400px;
                    animation: slideInRight 0.3s ease;
                `;
                
                switch (type) {
                    case 'success':
                        toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        break;
                    case 'error':
                        toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        break;
                    case 'warning':
                        toast.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        break;
                    default:
                        toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                }
                
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 5000);
            }
        });
    </script>
    <!--end::Javascript-->
</div>
</html> 