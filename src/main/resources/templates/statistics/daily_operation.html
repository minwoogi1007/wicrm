<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">일일 운영현황</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">통계</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">일일 운영현황</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 1.통계 현황 -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">1.통계 현황</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-250px" placeholder="날짜 선택" id="daily_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">조회</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>일자</th>
                                    <th>총콜</th>
                                    <th>중복제거호</th>
                                    <th>응대호</th>
                                    <th>포기호</th>
                                    <th>부재호</th>
                                    <th>총상담완료호</th>
                                    <th>수신호</th>
                                    <th>발신호</th>
                                    <th>응대율</th>
                                    <th>완료율</th>
                                    <th>수신비율</th>
                                    <th>발신비율</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="summaryStatsBody">
                                <tr>
                                    <td id="statDate">-</td>
                                    <td id="totalCalls">-</td>
                                    <td id="uniqueInboundCalls">-</td>
                                    <td id="answeredCalls">-</td>
                                    <td id="abandonedCalls">-</td>
                                    <td id="busyCalls">-</td>
                                    <td id="completedCounselingCalls">-</td>
                                    <td id="inboundCalls">-</td>
                                    <td id="outboundCalls">-</td>
                                    <td id="answerRate">-</td>
                                    <td id="completionRate">-</td>
                                    <td id="inboundRate">-</td>
                                    <td id="outboundRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2.통화 시간 현황 -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.통화 시간 현황 (오늘 vs 어제)(미구현)</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>구분</th>
                                    <th>오늘</th>
                                    <th>어제</th>
                                    <th>증감률</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="comparisonStatsBody">
                                <tr>
                                    <td>총통화시간(초)</td>
                                    <td id="todayTotalCallDuration">-</td>
                                    <td id="yesterdayTotalCallDuration">-</td>
                                    <td id="callDurationChangeRate">-</td>
                                </tr>
                                <tr>
                                    <td>평균통화시간(초)</td>
                                    <td id="todayAvgCallDuration">-</td>
                                    <td id="yesterdayAvgCallDuration">-</td>
                                    <td id="avgCallDurationChangeRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3.상담유형 상담현황 -->
                <div class="row g-5 g-xl-8">
                    <div class="col-xl-5">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">3.상담유형 상담현황</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>상담유형명</th>
                                            <th>상담수</th>
                                            <th>비율</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="counselingTypeStatsTableBody">
                                        <tr><td colspan="3">데이터를 불러오는 중입니다...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card card-flush h-xl-100">
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div id="kt_chart_counseling_types" class="min-h-auto" style="height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.조회일자 시간대별 그래프 -->
                <div class="card card-flush mt-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">4.조회일자 시간대별 그래프 (9시~19시)</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-12">
                                <div id="kt_chart_hourly_calls" class="min-h-auto" style="height: 350px"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // 날짜 선택 초기화
        $("#daily_datepicker").flatpickr({
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                // 날짜 선택 시 콘솔에 선택된 날짜 형식 로깅
                console.log("선택된 날짜:", dateStr);
                console.log("Date 객체:", selectedDates[0]);
            }
        });

        // CSRF 토큰
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        
        // 어제 날짜 계산 (평일 기준: 어제가 일요일이면 금요일, 토요일이면 금요일)
        function getYesterdayBusinessDate(date) {
            try {
                // 유효한 날짜인지 확인
                let today;
                
                // date가 없는 경우 현재 날짜 사용
                if (!date) {
                    today = new Date();
                }
                // date가 문자열인 경우 (YYYYMMDD 형식)
                else if (typeof date === 'string' && date.match(/^\d{8}$/)) {
                    const year = parseInt(date.substring(0, 4));
                    const month = parseInt(date.substring(4, 6)) - 1; // JavaScript는 월이 0부터 시작
                    const day = parseInt(date.substring(6, 8));
                    today = new Date(year, month, day);
                }
                // date가 문자열인 경우 (기타 형식)
                else if (typeof date === 'string') {
                    today = new Date(date);
                }
                // date가 Date 객체인 경우
                else if (date instanceof Date) {
                    today = new Date(date);
                }
                // 기타 타입인 경우
                else {
                    console.warn("알 수 없는 날짜 형식:", date);
                    today = new Date();
                }
                
                // 날짜 유효성 검사
                if (isNaN(today.getTime())) {
                    console.error("유효하지 않은 날짜:", date);
                    return new Date(); // 오류 시 현재 날짜 반환
                }
                
                let yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // 어제가 일요일(0)인 경우 -> 금요일(-2)로 설정
                if (yesterday.getDay() === 0) {
                    yesterday.setDate(yesterday.getDate() - 2);
                } 
                // 어제가 토요일(6)인 경우 -> 금요일(-1)로 설정
                else if (yesterday.getDay() === 6) {
                    yesterday.setDate(yesterday.getDate() - 1);
                }
                
                return yesterday;
            } catch (error) {
                console.error("날짜 계산 중 오류 발생:", error);
                return new Date(); // 오류 시 현재 날짜 반환
            }
        }

        // 날짜 포맷 변경 함수 (YYYYMMDD 형식으로)
        function formatDateToYYYYMMDD(dateString) {
            try {
                // dateString이 없는 경우
                if (!dateString) {
                    console.error("날짜가 비어있습니다.");
                    return formatCurrentDate();
                }
                
                // Date 객체가 전달된 경우 직접 처리
                if (dateString instanceof Date) {
                    const year = dateString.getFullYear();
                    const month = ('0' + (dateString.getMonth() + 1)).slice(-2);
                    const day = ('0' + dateString.getDate()).slice(-2);
                    return `${year}${month}${day}`;
                }
                
                // 문자열이 아닌 경우 문자열로 변환 시도
                if (typeof dateString !== 'string') {
                    console.warn("문자열이 아닌 값이 전달됨:", dateString);
                    // 숫자인 경우 그대로 반환 (YYYYMMDD 형식이면)
                    if (typeof dateString === 'number' && String(dateString).length === 8) {
                        return String(dateString);
                    }
                    
                    // 다른 타입은 문자열로 변환 시도
                    dateString = String(dateString);
                }
                
                // 문자열이 이미 YYYYMMDD 형식인지 확인
                if (dateString.match(/^\d{8}$/)) {
                    return dateString;
                }
                
                const date = new Date(dateString);
                
                // 유효한 날짜인지 확인
                if (isNaN(date.getTime())) {
                    console.error("유효하지 않은 날짜:", dateString);
                    return formatCurrentDate();
                }
                
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                return `${year}${month}${day}`;
            } catch (error) {
                console.error("날짜 포맷 변환 중 오류:", error);
                return formatCurrentDate();
            }
        }
        
        // 현재 날짜를 YYYYMMDD 형식으로 반환하는 헬퍼 함수
        function formatCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = ('0' + (today.getMonth() + 1)).slice(-2);
            const day = ('0' + today.getDate()).slice(-2);
            return `${year}${month}${day}`;
        }
        
        // 숫자 포맷 함수 (천단위 콤마)
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");
        }
        
        // 증감률 계산 함수
        function calculateChangeRate(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100).toFixed(1);
        }

        // 통계 현황 테이블 업데이트 함수
        function updateSummaryStatsTable(summaryStats) {
            console.log("updateSummaryStatsTable_S 시작, 전달된 summaryStats:", JSON.stringify(summaryStats, null, 2)); // 함수 시작 시 객체 전체 로깅

            if (!summaryStats) {
                console.log("updateSummaryStatsTable: summaryStats가 없음. 기본값('-')으로 설정합니다.");
                $('#statDate').text('-');
                $('#totalCalls').text('-');
                $('#answeredCalls').text('-');
                $('#abandonedCalls').text('-');
                $('#uniqueInboundCalls').text('-');
                $('#busyCalls').text('-');
                $('#completedCounselingCalls').text('-');
                $('#inboundCalls').text('-');
                $('#outboundCalls').text('-');
                $('#answerRate').text('-');
                $('#completionRate').text('-');
                $('#inboundRate').text('-');
                $('#outboundRate').text('-');
                return;
            }

            let displayDate = summaryStats.statDate;
            if (summaryStats.statDate && summaryStats.statDate.length === 8) {
                displayDate = `${summaryStats.statDate.substring(0,4)}-${summaryStats.statDate.substring(4,6)}-${summaryStats.statDate.substring(6,8)}`;
            }
            console.log("설정값 statDate:", displayDate);
            $('#statDate').text(displayDate);

            console.log("설정값 totalCalls:", formatNumber(summaryStats.totalCalls));
            $('#totalCalls').text(formatNumber(summaryStats.totalCalls));

            console.log("설정값 answeredCalls:", formatNumber(summaryStats.answeredCalls));
            $('#answeredCalls').text(formatNumber(summaryStats.answeredCalls));

            console.log("설정값 abandonedCalls:", formatNumber(summaryStats.abandonedCalls));
            $('#abandonedCalls').text(formatNumber(summaryStats.abandonedCalls));

            console.log("설정값 uniqueInboundCalls:", formatNumber(summaryStats.uniqueInboundCalls));
            $('#uniqueInboundCalls').text(formatNumber(summaryStats.uniqueInboundCalls));

            console.log("설정값 busyCalls:", formatNumber(summaryStats.busyCalls));
            $('#busyCalls').text(formatNumber(summaryStats.busyCalls));

            console.log("설정값 completedCounselingCalls:", formatNumber(summaryStats.completedCounselingCalls));
            $('#completedCounselingCalls').text(formatNumber(summaryStats.completedCounselingCalls));
            
            console.log("설정값 inboundCalls:", formatNumber(summaryStats.inboundCalls));
            $('#inboundCalls').text(formatNumber(summaryStats.inboundCalls));
            
            console.log("설정값 outboundCalls:", formatNumber(summaryStats.outboundCalls));
            $('#outboundCalls').text(formatNumber(summaryStats.outboundCalls));

            const answerRateText = summaryStats.answerRate !== null ? summaryStats.answerRate.toFixed(1) + '%' : '-';
            console.log("설정값 answerRate:", answerRateText);
            $('#answerRate').text(answerRateText);

            const completionRateText = summaryStats.completionRate !== null ? summaryStats.completionRate.toFixed(1) + '%' : '-';
            console.log("설정값 completionRate:", completionRateText);
            $('#completionRate').text(completionRateText);
            
            const inboundRateText = summaryStats.inboundRate !== null ? summaryStats.inboundRate.toFixed(1) + '%' : '-';
            console.log("설정값 inboundRate:", inboundRateText);
            $('#inboundRate').text(inboundRateText);
            
            const outboundRateText = summaryStats.outboundRate !== null ? summaryStats.outboundRate.toFixed(1) + '%' : '-';
            console.log("설정값 outboundRate:", outboundRateText);
            $('#outboundRate').text(outboundRateText);
            
            console.log("updateSummaryStatsTable_E 종료");
        }

        // 통화 시간 현황 테이블 업데이트 함수
        function updateCallTimeComparisonTable(todayStats, yesterdayStats) {
            const $tbody = $('#comparisonStatsBody');
            $tbody.empty(); // 기존 내용 비우기

            // 오늘 데이터
            const todayTotal = todayStats && todayStats.totalCallDurationSeconds ? todayStats.totalCallDurationSeconds : 0;
            const todayAvg = todayStats && todayStats.averageCallDurationSeconds ? todayStats.averageCallDurationSeconds : 0;
            
            // 어제 데이터
            const yesterdayTotal = yesterdayStats && yesterdayStats.totalCallDurationSeconds ? yesterdayStats.totalCallDurationSeconds : 0;
            const yesterdayAvg = yesterdayStats && yesterdayStats.averageCallDurationSeconds ? yesterdayStats.averageCallDurationSeconds : 0;
            
            // 증감률 계산
            const totalChangeRate = calculateChangeRate(todayTotal, yesterdayTotal);
            const avgChangeRate = calculateChangeRate(todayAvg, yesterdayAvg);
            
            // 총통화시간 행
            const totalRow = `<tr>
                              <td>총통화시간(초)</td>
                              <td id="todayTotalCallDuration">${formatNumber(todayTotal)}</td>
                              <td id="yesterdayTotalCallDuration">${formatNumber(yesterdayTotal)}</td>
                              <td id="callDurationChangeRate" class="${totalChangeRate > 0 ? 'text-success' : (totalChangeRate < 0 ? 'text-danger' : '')}">${totalChangeRate}%</td>
                           </tr>`;
            $tbody.append(totalRow);
            
            // 평균통화시간 행
            const avgRow = `<tr>
                            <td>평균통화시간(초)</td>
                            <td id="todayAvgCallDuration">${todayAvg.toFixed(1)}</td>
                            <td id="yesterdayAvgCallDuration">${yesterdayAvg.toFixed(1)}</td>
                            <td id="avgCallDurationChangeRate" class="${avgChangeRate > 0 ? 'text-success' : (avgChangeRate < 0 ? 'text-danger' : '')}">${avgChangeRate}%</td>
                          </tr>`;
            $tbody.append(avgRow);
        }

        // 상담 유형 현황 테이블 및 차트 업데이트 함수
        function updateCounselingTypeStats(counselingTypeStatsList) {
            const $tbody = $('#counselingTypeStatsTableBody');
            $tbody.empty(); 

            if (!counselingTypeStatsList || counselingTypeStatsList.length === 0) {
                $tbody.append('<tr><td colspan="3">데이터가 없습니다.</td></tr>');
                // TODO: 차트도 비우거나 숨김 처리 (ApexCharts 사용 시)
                // 예: if (counselingTypeChart) counselingTypeChart.updateSeries([{ data: [] }]);
                return;
            }

            let chartSeriesData = [];
            let chartLabels = [];

            counselingTypeStatsList.forEach(stat => {
                const row = `<tr>
                                <td>${stat.counselingTypeName || stat.counselingType}</td>
                                <td>${formatNumber(stat.count)}</td>
                                <td>${stat.percentage !== null ? stat.percentage.toFixed(1) + '%' : '-'}</td>
                            </tr>`;
                $tbody.append(row);
                chartLabels.push(stat.counselingTypeName || stat.counselingType);
                chartSeriesData.push(stat.count);
            });

            // ApexCharts 업데이트
            if (typeof ApexCharts !== 'undefined' && counselingTypeChart) {
                counselingTypeChart.updateOptions({
                    series: chartSeriesData,
                    labels: chartLabels
                });
            } else {
                console.warn("ApexCharts 또는 counselingTypeChart 인스턴스가 준비되지 않았습니다.");
            }
        }
        
        var counselingTypeChart; // 차트 인스턴스를 담을 변수

        // 4.조회일자 시간대별 그래프 -->
        var hourlyCallsChart; // 차트 인스턴스를 담을 변수

        function updateHourlyCallsChart(hourlyData) {
            if (!hourlyData) {
                console.warn("Hourly data is not available.");
                if (hourlyCallsChart) hourlyCallsChart.updateSeries([{data:[]}, {data:[]}]);
                return;
            }

            // 시간대별 그래프 데이터 업데이트
            if (hourlyCallsChart) {
                hourlyCallsChart.updateOptions({
                    series: [
                        { name: '오늘 통화량', data: hourlyData.totalCalls },
                        { name: '어제 통화량', data: hourlyData.totalCallsYesterday }
                    ],
                    xaxis: {
                        categories: hourlyData.hours,
                        title: {
                            text: '시간대 (9시~19시)'
                        }
                    },
                    title: {
                        text: '시간대별 통화량 비교 (9시~19시)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    }
                });
            }
        }

        // 일일 운영현황 데이터 조회 함수
        function fetchDailyOperationData(date) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            // 날짜 객체가 전달된 경우
            if (date instanceof Date) {
                date = formatDateToYYYYMMDD(date);
            }
            
            // 날짜 유효성 검사
            if (!date) {
                console.error("날짜가 비어있습니다. 현재 날짜를 사용합니다.");
                date = formatCurrentDate();
            }
            
            // 날짜 형식 검증 (YYYYMMDD 형식인지)
            if (typeof date !== 'string' || !date.match(/^\d{8}$/)) {
                console.error("잘못된 날짜 형식:", date);
                date = formatCurrentDate();
            }
            
            console.log('사용할 날짜:', date);
            
            // 어제 날짜 계산 (평일 기준)
            const yesterdayDate = getYesterdayBusinessDate(date);
            const formattedYesterdayDate = formatDateToYYYYMMDD(yesterdayDate);
            
            console.log('오늘 날짜:', date);
            console.log('어제 날짜(평일 기준):', formattedYesterdayDate);
            
            // 두 개의 AJAX 요청을 병렬로 수행
            $.when(
                // 오늘 데이터 요청
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: date },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                }),
                // 어제 데이터 요청
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: formattedYesterdayDate },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                })
            ).done(function(todayResponse, yesterdayResponse) {
                console.log('오늘 데이터:', todayResponse[0]);
                console.log('어제 데이터:', yesterdayResponse[0]);
                
                const todayData = todayResponse[0];
                const yesterdayData = yesterdayResponse[0];
                
                if (todayData) {
                    // 1. 통계 현황 테이블 업데이트
                    updateSummaryStatsTable(todayData.summaryStats);
                    
                    // 2. 통화 시간 현황 테이블 업데이트 (오늘 vs 어제)
                    updateCallTimeComparisonTable(
                        todayData.callTimeStats, 
                        yesterdayData ? yesterdayData.callTimeStats : null
                    );
                    
                    // 3. 상담 유형 현황 테이블 및 차트 업데이트
                    updateCounselingTypeStats(todayData.counselingTypeStats);
                    
                    // 4.조회일자 시간대별 그래프 -->
                    updateHourlyCallsChart(todayData.hourlyCallsData);
                } else {
                    console.error('오늘 데이터가 비어있습니다.');
                    alert('데이터를 불러오는데 실패했습니다.');
                }
            }).fail(function(xhr, status, error) {
                console.error('데이터 조회 실패:', error);
                alert('데이터 조회 중 오류가 발생했습니다.');
            });
        }

        // 페이지 로드 시 또는 특정 이벤트 발생 시 초기 데이터 로드 함수
        function loadInitialDailyData() {
            try {
                const initialDate = $('#daily_datepicker').val();
                console.log("초기 datepicker 값:", initialDate);
                
                if (initialDate) {
                    const formattedDate = formatDateToYYYYMMDD(initialDate);
                    console.log("변환된 날짜 형식:", formattedDate);
                    fetchDailyOperationData(formattedDate);
                } else {
                    // 날짜가 선택되지 않은 경우 현재 날짜 사용
                    console.log("날짜가 선택되지 않아 현재 날짜 사용");
                    fetchDailyOperationData(formatCurrentDate());
                }
            } catch (error) {
                console.error("초기 데이터 로드 중 오류:", error);
                fetchDailyOperationData(formatCurrentDate());
            }
        }

        $(document).ready(function() {
            // 조회 버튼 클릭 이벤트
            $('#searchBtn').on('click', function() {
                try {
                    const selectedDate = $('#daily_datepicker').val();
                    console.log("조회 버튼 클릭 - 선택된 날짜:", selectedDate);
                    
                    if (!selectedDate) {
                        alert('날짜를 선택해주세요.');
                        return;
                    }
                    
                    const formattedSearchDate = formatDateToYYYYMMDD(selectedDate);
                    console.log("변환된 검색 날짜:", formattedSearchDate);
                    fetchDailyOperationData(formattedSearchDate);
                } catch (error) {
                    console.error("날짜 변환 중 오류:", error);
                    alert('유효하지 않은 날짜입니다. 다시 선택해주세요.');
                }
            });

            // ApexCharts 초기화 - kt_chart_counseling_types
            var chartElement = document.querySelector("#kt_chart_counseling_types");
            if (chartElement && typeof ApexCharts !== 'undefined') {
                var options = {
                    series: [], 
                    chart: { width: '100%', height: 400, type: 'donut' },
                    labels: [], 
                    legend: { position: 'bottom' },
                    responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
                };
               counselingTypeChart = new ApexCharts(chartElement, options);
               counselingTypeChart.render();
            } else {
                console.error("ApexCharts를 위한 DOM 요소(#kt_chart_counseling_types)를 찾을 수 없거나 ApexCharts 라이브러리가 로드되지 않았습니다.");
            }

            // ApexCharts 초기화 - kt_chart_hourly_calls
            var hourlyChartElement = document.querySelector("#kt_chart_hourly_calls");
            if (hourlyChartElement && typeof ApexCharts !== 'undefined') {
                var hourlyOptions = {
                    series: [],
                    chart: { 
                        type: 'line', 
                        height: 350,
                        toolbar: {
                            show: true
                        },
                        zoom: {
                            enabled: true
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    colors: ['#3E97FF', '#50CD89'],
                    markers: {
                        size: 4,
                        colors: ['#3E97FF', '#50CD89'],
                        strokeColors: '#ffffff',
                        strokeWidth: 2,
                        hover: {
                            size: 7
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        row: {
                            colors: ['#f3f3f3', 'transparent'],
                            opacity: 0.5
                        }
                    },
                    xaxis: {
                        categories: [],
                        title: {
                            text: '시간대 (9시~19시)'
                        }
                    },
                    yaxis: {
                        title: {
                            text: '통화량 (건)'
                        },
                        min: 0
                    },
                    title: {
                        text: '시간대별 통화량 비교 (9시~19시)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right'
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return val + " 건";
                            }
                        }
                    }
                };
                hourlyCallsChart = new ApexCharts(hourlyChartElement, hourlyOptions);
                hourlyCallsChart.render();
            }

            loadInitialDailyData();
        });
    </script>
    <!--end::Javascript-->
</div>
</html> 