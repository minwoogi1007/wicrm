<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">ÏùºÏùº Ïö¥ÏòÅÌòÑÌô©</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ÌÜµÍ≥Ñ</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ÏùºÏùº Ïö¥ÏòÅÌòÑÌô©</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 1.ÌÜµÍ≥Ñ ÌòÑÌô© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">1.ÌÜµÍ≥Ñ ÌòÑÌô©</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-250px" placeholder="ÎÇ†Ïßú ÏÑ†ÌÉù" id="daily_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">Ï°∞Ìöå</button>
                                <button type="button" class="btn btn-success ms-3" id="excelDownloadBtn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ÏùºÏûê</th>
                                    <th>Ï¥ùÏΩú</th>
                                    <th>Ï§ëÎ≥µÏ†úÍ±∞Ìò∏</th>
                                    <th>ÏùëÎåÄÌò∏</th>
                                    <th>Ìè¨Í∏∞Ìò∏</th>
                                    <th>Î∂ÄÏû¨Ìò∏</th>
                                    <th>Ï¥ùÏÉÅÎã¥ÏôÑÎ£åÌò∏</th>
                                    <th>ÏàòÏã†Ìò∏</th>
                                    <th>Î∞úÏã†Ìò∏</th>
                                    <th>ÏùëÎåÄÏú®</th>
                                    <th>ÏôÑÎ£åÏú®</th>
                                    <th>ÏàòÏã†ÎπÑÏú®</th>
                                    <th>Î∞úÏã†ÎπÑÏú®</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="summaryStatsBody">
                                <tr>
                                    <td id="statDate">-</td>
                                    <td id="totalCalls">-</td>
                                    <td id="uniqueInboundCalls">-</td>
                                    <td id="answeredCalls">-</td>
                                    <td id="abandonedCalls">-</td>
                                    <td id="busyCalls">-</td>
                                    <td id="completedCounselingCalls">-</td>
                                    <td id="inboundCalls">-</td>
                                    <td id="outboundCalls">-</td>
                                    <td id="answerRate">-</td>
                                    <td id="completionRate">-</td>
                                    <td id="inboundRate">-</td>
                                    <td id="outboundRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2.ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© (Ïò§Îäò vs Ïñ¥Ï†ú)(ÎØ∏Íµ¨ÌòÑ)</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>Íµ¨Î∂Ñ</th>
                                    <th>Ïò§Îäò</th>
                                    <th>Ïñ¥Ï†ú</th>
                                    <th>Ï¶ùÍ∞êÎ•†</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="comparisonStatsBody">
                                <tr>
                                    <td>Ï¥ùÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)</td>
                                    <td id="todayTotalCallDuration">-</td>
                                    <td id="yesterdayTotalCallDuration">-</td>
                                    <td id="callDurationChangeRate">-</td>
                                </tr>
                                <tr>
                                    <td>ÌèâÍ∑†ÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)</td>
                                    <td id="todayAvgCallDuration">-</td>
                                    <td id="yesterdayAvgCallDuration">-</td>
                                    <td id="avgCallDurationChangeRate">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3.ÏÉÅÎã¥Ïú†Ìòï ÏÉÅÎã¥ÌòÑÌô© -->
                <div class="row g-5 g-xl-8">
                    <div class="col-xl-5">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">3.ÏÉÅÎã¥Ïú†Ìòï ÏÉÅÎã¥ÌòÑÌô©</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>ÏÉÅÎã¥Ïú†ÌòïÎ™Ö</th>
                                            <th>ÏÉÅÎã¥Ïàò</th>
                                            <th>ÎπÑÏú®</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="counselingTypeStatsTableBody">
                                        <tr><td colspan="3">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card card-flush h-xl-100">
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div id="kt_chart_counseling_types" class="min-h-auto" style="height: 400px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.Ï°∞ÌöåÏùºÏûê ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∑∏ÎûòÌîÑ -->
                <div class="card card-flush mt-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">4.Ï°∞ÌöåÏùºÏûê ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∑∏ÎûòÌîÑ (9Ïãú~19Ïãú)</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-12">
                                <div id="kt_chart_hourly_calls" class="min-h-auto" style="height: 350px"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // ÎÇ†Ïßú ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        $("#daily_datepicker").flatpickr({
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                // ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú ÏΩòÏÜîÏóê ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÌòïÏãù Î°úÍπÖ
                console.log("ÏÑ†ÌÉùÎêú ÎÇ†Ïßú:", dateStr);
                console.log("Date Í∞ùÏ≤¥:", selectedDates[0]);
            }
        });

        // CSRF ÌÜ†ÌÅ∞
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        
        // Ïñ¥Ï†ú ÎÇ†Ïßú Í≥ÑÏÇ∞ (ÌèâÏùº Í∏∞Ï§Ä: Ïñ¥Ï†úÍ∞Ä ÏùºÏöîÏùºÏù¥Î©¥ Í∏àÏöîÏùº, ÌÜ†ÏöîÏùºÏù¥Î©¥ Í∏àÏöîÏùº)
        function getYesterdayBusinessDate(date) {
            try {
                // Ïú†Ìö®Ìïú ÎÇ†ÏßúÏù∏ÏßÄ ÌôïÏù∏
                let today;
                
                // dateÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÌòÑÏû¨ ÎÇ†Ïßú ÏÇ¨Ïö©
                if (!date) {
                    today = new Date();
                }
                // dateÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ (YYYYMMDD ÌòïÏãù)
                else if (typeof date === 'string' && date.match(/^\d{8}$/)) {
                    const year = parseInt(date.substring(0, 4));
                    const month = parseInt(date.substring(4, 6)) - 1; // JavaScriptÎäî ÏõîÏù¥ 0Î∂ÄÌÑ∞ ÏãúÏûë
                    const day = parseInt(date.substring(6, 8));
                    today = new Date(year, month, day);
                }
                // dateÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ (Í∏∞ÌÉÄ ÌòïÏãù)
                else if (typeof date === 'string') {
                    today = new Date(date);
                }
                // dateÍ∞Ä Date Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞
                else if (date instanceof Date) {
                    today = new Date(date);
                }
                // Í∏∞ÌÉÄ ÌÉÄÏûÖÏù∏ Í≤ΩÏö∞
                else {
                    console.warn("Ïïå Ïàò ÏóÜÎäî ÎÇ†Ïßú ÌòïÏãù:", date);
                    today = new Date();
                }
                
                // ÎÇ†Ïßú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (isNaN(today.getTime())) {
                    console.error("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎÇ†Ïßú:", date);
                    return new Date(); // Ïò§Î•ò Ïãú ÌòÑÏû¨ ÎÇ†Ïßú Î∞òÌôò
                }
                
                let yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // Ïñ¥Ï†úÍ∞Ä ÏùºÏöîÏùº(0)Ïù∏ Í≤ΩÏö∞ -> Í∏àÏöîÏùº(-2)Î°ú ÏÑ§Ï†ï
                if (yesterday.getDay() === 0) {
                    yesterday.setDate(yesterday.getDate() - 2);
                } 
                // Ïñ¥Ï†úÍ∞Ä ÌÜ†ÏöîÏùº(6)Ïù∏ Í≤ΩÏö∞ -> Í∏àÏöîÏùº(-1)Î°ú ÏÑ§Ï†ï
                else if (yesterday.getDay() === 6) {
                    yesterday.setDate(yesterday.getDate() - 1);
                }
                
                return yesterday;
            } catch (error) {
                console.error("ÎÇ†Ïßú Í≥ÑÏÇ∞ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
                return new Date(); // Ïò§Î•ò Ïãú ÌòÑÏû¨ ÎÇ†Ïßú Î∞òÌôò
            }
        }

        // ÎÇ†Ïßú Ìè¨Îß∑ Î≥ÄÍ≤Ω Ìï®Ïàò (YYYYMMDD ÌòïÏãùÏúºÎ°ú)
        function formatDateToYYYYMMDD(dateString) {
            try {
                // dateStringÏù¥ ÏóÜÎäî Í≤ΩÏö∞
                if (!dateString) {
                    console.error("ÎÇ†ÏßúÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");
                    return formatCurrentDate();
                }
                
                // Date Í∞ùÏ≤¥Í∞Ä Ï†ÑÎã¨Îêú Í≤ΩÏö∞ ÏßÅÏ†ë Ï≤òÎ¶¨
                if (dateString instanceof Date) {
                    const year = dateString.getFullYear();
                    const month = ('0' + (dateString.getMonth() + 1)).slice(-2);
                    const day = ('0' + dateString.getDate()).slice(-2);
                    return `${year}${month}${day}`;
                }
                
                // Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò ÏãúÎèÑ
                if (typeof dateString !== 'string') {
                    console.warn("Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í∞íÏù¥ Ï†ÑÎã¨Îê®:", dateString);
                    // Ïà´ÏûêÏù∏ Í≤ΩÏö∞ Í∑∏ÎåÄÎ°ú Î∞òÌôò (YYYYMMDD ÌòïÏãùÏù¥Î©¥)
                    if (typeof dateString === 'number' && String(dateString).length === 8) {
                        return String(dateString);
                    }
                    
                    // Îã§Î•∏ ÌÉÄÏûÖÏùÄ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò ÏãúÎèÑ
                    dateString = String(dateString);
                }
                
                // Î¨∏ÏûêÏó¥Ïù¥ Ïù¥ÎØ∏ YYYYMMDD ÌòïÏãùÏù∏ÏßÄ ÌôïÏù∏
                if (dateString.match(/^\d{8}$/)) {
                    return dateString;
                }
                
                const date = new Date(dateString);
                
                // Ïú†Ìö®Ìïú ÎÇ†ÏßúÏù∏ÏßÄ ÌôïÏù∏
                if (isNaN(date.getTime())) {
                    console.error("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎÇ†Ïßú:", dateString);
                    return formatCurrentDate();
                }
                
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                return `${year}${month}${day}`;
            } catch (error) {
                console.error("ÎÇ†Ïßú Ìè¨Îß∑ Î≥ÄÌôò Ï§ë Ïò§Î•ò:", error);
                return formatCurrentDate();
            }
        }
        
        // ÌòÑÏû¨ ÎÇ†ÏßúÎ•º YYYYMMDD ÌòïÏãùÏúºÎ°ú Î∞òÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
        function formatCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = ('0' + (today.getMonth() + 1)).slice(-2);
            const day = ('0' + today.getDate()).slice(-2);
            return `${year}${month}${day}`;
        }
        
        // Ïà´Ïûê Ìè¨Îß∑ Ìï®Ïàò (Ï≤úÎã®ÏúÑ ÏΩ§Îßà)
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");
        }
        
        // Ï¶ùÍ∞êÎ•† Í≥ÑÏÇ∞ Ìï®Ïàò
        function calculateChangeRate(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100).toFixed(1);
        }

        // ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateSummaryStatsTable(summaryStats) {
            console.log("updateSummaryStatsTable_S ÏãúÏûë, Ï†ÑÎã¨Îêú summaryStats:", JSON.stringify(summaryStats, null, 2)); // Ìï®Ïàò ÏãúÏûë Ïãú Í∞ùÏ≤¥ Ï†ÑÏ≤¥ Î°úÍπÖ

            if (!summaryStats) {
                console.log("updateSummaryStatsTable: summaryStatsÍ∞Ä ÏóÜÏùå. Í∏∞Î≥∏Í∞í('-')ÏúºÎ°ú ÏÑ§Ï†ïÌï©ÎãàÎã§.");
                $('#statDate').text('-');
                $('#totalCalls').text('-');
                $('#answeredCalls').text('-');
                $('#abandonedCalls').text('-');
                $('#uniqueInboundCalls').text('-');
                $('#busyCalls').text('-');
                $('#completedCounselingCalls').text('-');
                $('#inboundCalls').text('-');
                $('#outboundCalls').text('-');
                $('#answerRate').text('-');
                $('#completionRate').text('-');
                $('#inboundRate').text('-');
                $('#outboundRate').text('-');
                return;
            }

            let displayDate = summaryStats.statDate;
            if (summaryStats.statDate && summaryStats.statDate.length === 8) {
                displayDate = `${summaryStats.statDate.substring(0,4)}-${summaryStats.statDate.substring(4,6)}-${summaryStats.statDate.substring(6,8)}`;
            }
            console.log("ÏÑ§Ï†ïÍ∞í statDate:", displayDate);
            $('#statDate').text(displayDate);

            console.log("ÏÑ§Ï†ïÍ∞í totalCalls:", formatNumber(summaryStats.totalCalls));
            $('#totalCalls').text(formatNumber(summaryStats.totalCalls));

            console.log("ÏÑ§Ï†ïÍ∞í answeredCalls:", formatNumber(summaryStats.answeredCalls));
            $('#answeredCalls').text(formatNumber(summaryStats.answeredCalls));

            console.log("ÏÑ§Ï†ïÍ∞í abandonedCalls:", formatNumber(summaryStats.abandonedCalls));
            $('#abandonedCalls').text(formatNumber(summaryStats.abandonedCalls));

            console.log("ÏÑ§Ï†ïÍ∞í uniqueInboundCalls:", formatNumber(summaryStats.uniqueInboundCalls));
            $('#uniqueInboundCalls').text(formatNumber(summaryStats.uniqueInboundCalls));

            console.log("ÏÑ§Ï†ïÍ∞í busyCalls:", formatNumber(summaryStats.busyCalls));
            $('#busyCalls').text(formatNumber(summaryStats.busyCalls));

            console.log("ÏÑ§Ï†ïÍ∞í completedCounselingCalls:", formatNumber(summaryStats.completedCounselingCalls));
            $('#completedCounselingCalls').text(formatNumber(summaryStats.completedCounselingCalls));
            
            console.log("ÏÑ§Ï†ïÍ∞í inboundCalls:", formatNumber(summaryStats.inboundCalls));
            $('#inboundCalls').text(formatNumber(summaryStats.inboundCalls));
            
            console.log("ÏÑ§Ï†ïÍ∞í outboundCalls:", formatNumber(summaryStats.outboundCalls));
            $('#outboundCalls').text(formatNumber(summaryStats.outboundCalls));

            const answerRateText = summaryStats.answerRate !== null ? summaryStats.answerRate.toFixed(1) + '%' : '-';
            console.log("ÏÑ§Ï†ïÍ∞í answerRate:", answerRateText);
            $('#answerRate').text(answerRateText);

            const completionRateText = summaryStats.completionRate !== null ? summaryStats.completionRate.toFixed(1) + '%' : '-';
            console.log("ÏÑ§Ï†ïÍ∞í completionRate:", completionRateText);
            $('#completionRate').text(completionRateText);
            
            const inboundRateText = summaryStats.inboundRate !== null ? summaryStats.inboundRate.toFixed(1) + '%' : '-';
            console.log("ÏÑ§Ï†ïÍ∞í inboundRate:", inboundRateText);
            $('#inboundRate').text(inboundRateText);
            
            const outboundRateText = summaryStats.outboundRate !== null ? summaryStats.outboundRate.toFixed(1) + '%' : '-';
            console.log("ÏÑ§Ï†ïÍ∞í outboundRate:", outboundRateText);
            $('#outboundRate').text(outboundRateText);
            
            console.log("updateSummaryStatsTable_E Ï¢ÖÎ£å");
        }

        // ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCallTimeComparisonTable(todayStats, yesterdayStats) {
            const $tbody = $('#comparisonStatsBody');
            $tbody.empty(); // Í∏∞Ï°¥ ÎÇ¥Ïö© ÎπÑÏö∞Í∏∞

            // Ïò§Îäò Îç∞Ïù¥ÌÑ∞
            const todayTotal = todayStats && todayStats.totalCallDurationSeconds ? todayStats.totalCallDurationSeconds : 0;
            const todayAvg = todayStats && todayStats.averageCallDurationSeconds ? todayStats.averageCallDurationSeconds : 0;
            
            // Ïñ¥Ï†ú Îç∞Ïù¥ÌÑ∞
            const yesterdayTotal = yesterdayStats && yesterdayStats.totalCallDurationSeconds ? yesterdayStats.totalCallDurationSeconds : 0;
            const yesterdayAvg = yesterdayStats && yesterdayStats.averageCallDurationSeconds ? yesterdayStats.averageCallDurationSeconds : 0;
            
            // Ï¶ùÍ∞êÎ•† Í≥ÑÏÇ∞
            const totalChangeRate = calculateChangeRate(todayTotal, yesterdayTotal);
            const avgChangeRate = calculateChangeRate(todayAvg, yesterdayAvg);
            
            // Ï¥ùÌÜµÌôîÏãúÍ∞Ñ Ìñâ
            const totalRow = `<tr>
                              <td>Ï¥ùÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)</td>
                              <td id="todayTotalCallDuration">${formatNumber(todayTotal)}</td>
                              <td id="yesterdayTotalCallDuration">${formatNumber(yesterdayTotal)}</td>
                              <td id="callDurationChangeRate" class="${totalChangeRate > 0 ? 'text-success' : (totalChangeRate < 0 ? 'text-danger' : '')}">${totalChangeRate}%</td>
                           </tr>`;
            $tbody.append(totalRow);
            
            // ÌèâÍ∑†ÌÜµÌôîÏãúÍ∞Ñ Ìñâ
            const avgRow = `<tr>
                            <td>ÌèâÍ∑†ÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)</td>
                            <td id="todayAvgCallDuration">${todayAvg.toFixed(1)}</td>
                            <td id="yesterdayAvgCallDuration">${yesterdayAvg.toFixed(1)}</td>
                            <td id="avgCallDurationChangeRate" class="${avgChangeRate > 0 ? 'text-success' : (avgChangeRate < 0 ? 'text-danger' : '')}">${avgChangeRate}%</td>
                          </tr>`;
            $tbody.append(avgRow);
        }

        // ÏÉÅÎã¥ Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Î∞è Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCounselingTypeStats(counselingTypeStatsList) {
            const $tbody = $('#counselingTypeStatsTableBody');
            $tbody.empty(); 

            if (!counselingTypeStatsList || counselingTypeStatsList.length === 0) {
                $tbody.append('<tr><td colspan="3">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>');
                // TODO: Ï∞®Ìä∏ÎèÑ ÎπÑÏö∞Í±∞ÎÇò Ïà®ÍπÄ Ï≤òÎ¶¨ (ApexCharts ÏÇ¨Ïö© Ïãú)
                // Ïòà: if (counselingTypeChart) counselingTypeChart.updateSeries([{ data: [] }]);
                return;
            }

            let chartSeriesData = [];
            let chartLabels = [];

            counselingTypeStatsList.forEach(stat => {
                const row = `<tr>
                                <td>${stat.counselingTypeName || stat.counselingType}</td>
                                <td>${formatNumber(stat.count)}</td>
                                <td>${stat.percentage !== null ? stat.percentage.toFixed(1) + '%' : '-'}</td>
                            </tr>`;
                $tbody.append(row);
                chartLabels.push(stat.counselingTypeName || stat.counselingType);
                chartSeriesData.push(stat.count);
            });

            // ApexCharts ÏóÖÎç∞Ïù¥Ìä∏
            if (typeof ApexCharts !== 'undefined' && counselingTypeChart) {
                counselingTypeChart.updateOptions({
                    series: chartSeriesData,
                    labels: chartLabels
                });
            } else {
                console.warn("ApexCharts ÎòêÎäî counselingTypeChart Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            }
        }
        
        var counselingTypeChart; // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§Î•º Îã¥ÏùÑ Î≥ÄÏàò

        // 4.Ï°∞ÌöåÏùºÏûê ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∑∏ÎûòÌîÑ -->
        var hourlyCallsChart; // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§Î•º Îã¥ÏùÑ Î≥ÄÏàò

        function updateHourlyCallsChart(hourlyData) {
            if (!hourlyData) {
                console.warn("Hourly data is not available.");
                if (hourlyCallsChart) hourlyCallsChart.updateSeries([{data:[]}, {data:[]}]);
                return;
            }

            // ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (hourlyCallsChart) {
                hourlyCallsChart.updateOptions({
                    series: [
                        { name: 'Ïò§Îäò ÌÜµÌôîÎüâ', data: hourlyData.totalCalls },
                        { name: 'Ïñ¥Ï†ú ÌÜµÌôîÎüâ', data: hourlyData.totalCallsYesterday }
                    ],
                    xaxis: {
                        categories: hourlyData.hours,
                        title: {
                            text: 'ÏãúÍ∞ÑÎåÄ (9Ïãú~19Ïãú)'
                        }
                    },
                    title: {
                        text: 'ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ ÎπÑÍµê (9Ïãú~19Ïãú)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    }
                });
            }
        }

        // ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ìï®Ïàò
        function fetchDailyOperationData(date) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            // ÎÇ†Ïßú Í∞ùÏ≤¥Í∞Ä Ï†ÑÎã¨Îêú Í≤ΩÏö∞
            if (date instanceof Date) {
                date = formatDateToYYYYMMDD(date);
            }
            
            // ÎÇ†Ïßú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!date) {
                console.error("ÎÇ†ÏßúÍ∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. ÌòÑÏû¨ ÎÇ†ÏßúÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.");
                date = formatCurrentDate();
            }
            
            // ÎÇ†Ïßú ÌòïÏãù Í≤ÄÏ¶ù (YYYYMMDD ÌòïÏãùÏù∏ÏßÄ)
            if (typeof date !== 'string' || !date.match(/^\d{8}$/)) {
                console.error("ÏûòÎ™ªÎêú ÎÇ†Ïßú ÌòïÏãù:", date);
                date = formatCurrentDate();
            }
            
            console.log('ÏÇ¨Ïö©Ìï† ÎÇ†Ïßú:', date);
            
            // Ïñ¥Ï†ú ÎÇ†Ïßú Í≥ÑÏÇ∞ (ÌèâÏùº Í∏∞Ï§Ä)
            const yesterdayDate = getYesterdayBusinessDate(date);
            const formattedYesterdayDate = formatDateToYYYYMMDD(yesterdayDate);
            
            console.log('Ïò§Îäò ÎÇ†Ïßú:', date);
            console.log('Ïñ¥Ï†ú ÎÇ†Ïßú(ÌèâÏùº Í∏∞Ï§Ä):', formattedYesterdayDate);
            
            // Îëê Í∞úÏùò AJAX ÏöîÏ≤≠ÏùÑ Î≥ëÎ†¨Î°ú ÏàòÌñâ
            $.when(
                // Ïò§Îäò Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: date },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                }),
                // Ïñ¥Ï†ú Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
                $.ajax({
                    url: '/stat/daily/search',
                    type: 'POST',
                    data: { date: formattedYesterdayDate },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                })
            ).done(function(todayResponse, yesterdayResponse) {
                console.log('Ïò§Îäò Îç∞Ïù¥ÌÑ∞:', todayResponse[0]);
                console.log('Ïñ¥Ï†ú Îç∞Ïù¥ÌÑ∞:', yesterdayResponse[0]);
                
                const todayData = todayResponse[0];
                const yesterdayData = yesterdayResponse[0];
                
                if (todayData) {
                    // 1. ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
                    updateSummaryStatsTable(todayData.summaryStats);
                    
                    // 2. ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ (Ïò§Îäò vs Ïñ¥Ï†ú)
                    updateCallTimeComparisonTable(
                        todayData.callTimeStats, 
                        yesterdayData ? yesterdayData.callTimeStats : null
                    );
                    
                    // 3. ÏÉÅÎã¥ Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Î∞è Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    updateCounselingTypeStats(todayData.counselingTypeStats);
                    
                    // 4.Ï°∞ÌöåÏùºÏûê ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∑∏ÎûòÌîÑ -->
                    updateHourlyCallsChart(todayData.hourlyCallsData);
                } else {
                    console.error('Ïò§Îäò Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                    alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            }).fail(function(xhr, status, error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:', error);
                alert('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎòêÎäî ÌäπÏ†ï Ïù¥Î≤§Ìä∏ Î∞úÏÉù Ïãú Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò
        function loadInitialDailyData() {
            try {
                const initialDate = $('#daily_datepicker').val();
                console.log("Ï¥àÍ∏∞ datepicker Í∞í:", initialDate);
                
                if (initialDate) {
                    const formattedDate = formatDateToYYYYMMDD(initialDate);
                    console.log("Î≥ÄÌôòÎêú ÎÇ†Ïßú ÌòïÏãù:", formattedDate);
                    fetchDailyOperationData(formattedDate);
                } else {
                    // ÎÇ†ÏßúÍ∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÌòÑÏû¨ ÎÇ†Ïßú ÏÇ¨Ïö©
                    console.log("ÎÇ†ÏßúÍ∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïÑ ÌòÑÏû¨ ÎÇ†Ïßú ÏÇ¨Ïö©");
                    fetchDailyOperationData(formatCurrentDate());
                }
            } catch (error) {
                console.error("Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò:", error);
                fetchDailyOperationData(formatCurrentDate());
            }
        }

        $(document).ready(function() {
            // Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $('#searchBtn').on('click', function() {
                try {
                    const selectedDate = $('#daily_datepicker').val();
                    console.log("Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠ - ÏÑ†ÌÉùÎêú ÎÇ†Ïßú:", selectedDate);
                    
                    if (!selectedDate) {
                        alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    
                    const formattedSearchDate = formatDateToYYYYMMDD(selectedDate);
                    console.log("Î≥ÄÌôòÎêú Í≤ÄÏÉâ ÎÇ†Ïßú:", formattedSearchDate);
                    fetchDailyOperationData(formattedSearchDate);
                } catch (error) {
                    console.error("ÎÇ†Ïßú Î≥ÄÌôò Ï§ë Ïò§Î•ò:", error);
                    alert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎÇ†ÏßúÏûÖÎãàÎã§. Îã§Ïãú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }
            });

            // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            $('#excelDownloadBtn').on('click', function() {
                try {
                    const selectedDate = $('#daily_datepicker').val();
                    if (!selectedDate) {
                        alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    downloadDailyOperationExcel();
                } catch (error) {
                    console.error('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïò§Î•ò:', error);
                    alert('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            });

            // ApexCharts Ï¥àÍ∏∞Ìôî - kt_chart_counseling_types
            var chartElement = document.querySelector("#kt_chart_counseling_types");
            if (chartElement && typeof ApexCharts !== 'undefined') {
                var options = {
                    series: [], 
                    chart: { width: '100%', height: 400, type: 'donut' },
                    labels: [], 
                    legend: { position: 'bottom' },
                    responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
                };
               counselingTypeChart = new ApexCharts(chartElement, options);
               counselingTypeChart.render();
            } else {
                console.error("ApexChartsÎ•º ÏúÑÌïú DOM ÏöîÏÜå(#kt_chart_counseling_types)Î•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ApexCharts ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            }

            // ApexCharts Ï¥àÍ∏∞Ìôî - kt_chart_hourly_calls
            var hourlyChartElement = document.querySelector("#kt_chart_hourly_calls");
            if (hourlyChartElement && typeof ApexCharts !== 'undefined') {
                var hourlyOptions = {
                    series: [],
                    chart: { 
                        type: 'line', 
                        height: 350,
                        toolbar: {
                            show: true
                        },
                        zoom: {
                            enabled: true
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    colors: ['#3E97FF', '#50CD89'],
                    markers: {
                        size: 4,
                        colors: ['#3E97FF', '#50CD89'],
                        strokeColors: '#ffffff',
                        strokeWidth: 2,
                        hover: {
                            size: 7
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        row: {
                            colors: ['#f3f3f3', 'transparent'],
                            opacity: 0.5
                        }
                    },
                    xaxis: {
                        categories: [],
                        title: {
                            text: 'ÏãúÍ∞ÑÎåÄ (9Ïãú~19Ïãú)'
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'ÌÜµÌôîÎüâ (Í±¥)'
                        },
                        min: 0
                    },
                    title: {
                        text: 'ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ ÎπÑÍµê (9Ïãú~19Ïãú)',
                        align: 'left',
                        style: {
                            fontSize: '16px',
                            fontWeight: 'bold'
                        }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right'
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(0) + " Í±¥" : "0 Í±¥";
                            }
                        }
                    }
                };
                hourlyCallsChart = new ApexCharts(hourlyChartElement, hourlyOptions);
                hourlyCallsChart.render();
            }

            loadInitialDailyData();
            
            // ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ìï®Ïàò
            async function downloadDailyOperationExcel() {
                try {
                    console.log('üì• ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏãúÏûë...');
                    
                    // Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏÉÅÌÉú ÌôïÏù∏
                    const totalCallsValue = document.getElementById('totalCalls')?.textContent?.trim();
                    if (!totalCallsValue || totalCallsValue === '-') {
                        showToast('Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞Î•º Ï°∞ÌöåÌï¥Ï£ºÏÑ∏Ïöî!', 'warning');
                        return;
                    }
                    
                    showToast('Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞Î•º Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§...', 'info');
                    
                    const images = {};
                    const tableData = {};
                    
                    // Ïã§Ï†ú ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (Ïù¥ÎØ∏ÏßÄ ÎåÄÏã†)
                    console.log('üìä ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...');
                    
                    // 1. ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (ID Í∏∞Î∞òÏúºÎ°ú Í∞ÄÎ°úÌòï Îç∞Ïù¥ÌÑ∞Î•º ÏÑ∏Î°úÌòïÏúºÎ°ú Î≥ÄÌôò)
                    const summaryData = [
                        { label: 'ÏùºÏûê', value: document.getElementById('statDate')?.textContent?.trim() || '-' },
                        { label: 'Ï¥ùÏΩú', value: document.getElementById('totalCalls')?.textContent?.trim() || '-' },
                        { label: 'Ï§ëÎ≥µÏ†úÍ±∞Ìò∏', value: document.getElementById('uniqueInboundCalls')?.textContent?.trim() || '-' },
                        { label: 'ÏùëÎåÄÌò∏', value: document.getElementById('answeredCalls')?.textContent?.trim() || '-' },
                        { label: 'Ìè¨Í∏∞Ìò∏', value: document.getElementById('abandonedCalls')?.textContent?.trim() || '-' },
                        { label: 'Î∂ÄÏû¨Ìò∏', value: document.getElementById('busyCalls')?.textContent?.trim() || '-' },
                        { label: 'Ï¥ùÏÉÅÎã¥ÏôÑÎ£åÌò∏', value: document.getElementById('completedCounselingCalls')?.textContent?.trim() || '-' },
                        { label: 'ÏàòÏã†Ìò∏', value: document.getElementById('inboundCalls')?.textContent?.trim() || '-' },
                        { label: 'Î∞úÏã†Ìò∏', value: document.getElementById('outboundCalls')?.textContent?.trim() || '-' },
                        { label: 'ÏùëÎåÄÏú®', value: document.getElementById('answerRate')?.textContent?.trim() || '-' },
                        { label: 'ÏôÑÎ£åÏú®', value: document.getElementById('completionRate')?.textContent?.trim() || '-' },
                        { label: 'ÏàòÏã†ÎπÑÏú®', value: document.getElementById('inboundRate')?.textContent?.trim() || '-' },
                        { label: 'Î∞úÏã†ÎπÑÏú®', value: document.getElementById('outboundRate')?.textContent?.trim() || '-' }
                    ];
                    tableData.summaryTableData = summaryData;
                    console.log('‚úÖ ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞:', summaryData);
                    
                    // 2. ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (ID Í∏∞Î∞òÏúºÎ°ú Ï†ïÌôïÌïòÍ≤å)
                    const comparisonData = [
                        {
                            time: 'Ï¥ùÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)',
                            today: document.getElementById('todayTotalCallDuration')?.textContent?.trim() || '-',
                            yesterday: document.getElementById('yesterdayTotalCallDuration')?.textContent?.trim() || '-',
                            change: document.getElementById('callDurationChangeRate')?.textContent?.trim() || '-'
                        },
                        {
                            time: 'ÌèâÍ∑†ÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)',
                            today: document.getElementById('todayAvgCallDuration')?.textContent?.trim() || '-',
                            yesterday: document.getElementById('yesterdayAvgCallDuration')?.textContent?.trim() || '-',
                            change: document.getElementById('avgCallDurationChangeRate')?.textContent?.trim() || '-'
                        }
                    ];
                    tableData.comparisonTableData = comparisonData;
                    console.log('‚úÖ ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞:', comparisonData);
                    
                    // 3. ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (Ï†ïÌôïÌïú ÏÑ†ÌÉùÏûê ÏÇ¨Ïö©)
                    const counselingTableRows = document.querySelectorAll('#counselingTypeStatsTableBody tr');
                    const counselingData = [];
                    counselingTableRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3 && !cells[0].textContent.includes('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë') && !cells[0].textContent.includes('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§')) {
                            counselingData.push({
                                type: cells[0].textContent.trim(),
                                count: cells[1].textContent.trim(),
                                percentage: cells[2].textContent.trim()
                            });
                        }
                    });
                    tableData.counselingTableData = counselingData;
                    console.log('‚úÖ ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞:', counselingData);
                    
                    // ÏàòÏßëÎêú ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤¥ Í≤ÄÏ¶ù
                    console.log('üîç ÏàòÏßëÎêú Î™®Îì† ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:');
                    console.log('- ÌÜµÍ≥Ñ ÌòÑÌô©:', tableData.summaryTableData?.length || 0, 'Í∞ú Ìï≠Î™©');
                    console.log('- ÌÜµÌôî ÏãúÍ∞Ñ:', tableData.comparisonTableData?.length || 0, 'Í∞ú Ìï≠Î™©');
                    console.log('- ÏÉÅÎã¥Ïú†Ìòï:', tableData.counselingTableData?.length || 0, 'Í∞ú Ìï≠Î™©');
                    
                    // Îπà Îç∞Ïù¥ÌÑ∞ Ï≤¥ÌÅ¨
                    if ((tableData.summaryTableData?.length || 0) === 0) {
                        console.warn('‚ö†Ô∏è ÌÜµÍ≥Ñ ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                    }
                    if ((tableData.comparisonTableData?.length || 0) === 0) {
                        console.warn('‚ö†Ô∏è ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                    }
                    if ((tableData.counselingTableData?.length || 0) === 0) {
                        console.warn('‚ö†Ô∏è ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                    }
                    
                    // 4. ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts)
                    if (counselingTypeChart) {
                        console.log('üçï ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                        console.log('üçï Ï∞®Ìä∏ Í∞ùÏ≤¥ Ï†ïÎ≥¥:', {
                            type: typeof counselingTypeChart,
                            hasDataURI: typeof counselingTypeChart.dataURI === 'function'
                        });
                        
                        try {
                            const chartResult = await counselingTypeChart.dataURI({
                                type: 'png',
                                scale: 3,
                                width: 500,
                                height: 400
                            });
                            
                            console.log('üçï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤∞Í≥º ÌÉÄÏûÖ:', typeof chartResult);
                            console.log('üçï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤∞Í≥º ÏÉòÌîå:', chartResult);
                            
                            // ApexCharts dataURI Í≤∞Í≥ºÍ∞Ä Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Ï≤òÎ¶¨
                            if (typeof chartResult === 'object' && chartResult !== null) {
                                if (chartResult.imgURI && typeof chartResult.imgURI === 'string') {
                                    images.counselingTypeChartImage = chartResult.imgURI;
                                    console.log('‚úÖ ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏÑ±Í≥µ (Í∞ùÏ≤¥ÏóêÏÑú Ï∂îÏ∂ú)');
                                } else {
                                    console.error('‚ùå ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÌòïÏãùÏù¥ ÏûòÎ™ªÎê®:', chartResult);
                                }
                            } else if (typeof chartResult === 'string' && chartResult.startsWith('data:image/')) {
                                images.counselingTypeChartImage = chartResult;
                                console.log('‚úÖ ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏÑ±Í≥µ (Î¨∏ÏûêÏó¥)');
                            } else {
                                console.error('‚ùå ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÌòïÏãùÏù¥ ÏûòÎ™ªÎê®:', chartResult);
                            }
                        } catch (error) {
                            console.warn('‚ùå ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                        }
                    }
                    
                    // 5. ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts)
                    if (hourlyCallsChart) {
                        console.log('üìä ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                        console.log('üìä Ï∞®Ìä∏ Í∞ùÏ≤¥ Ï†ïÎ≥¥:', {
                            type: typeof hourlyCallsChart,
                            hasDataURI: typeof hourlyCallsChart.dataURI === 'function'
                        });
                        
                        try {
                            const chartResult = await hourlyCallsChart.dataURI({
                                type: 'png',
                                scale: 3,
                                width: 800,
                                height: 350
                            });
                            
                            console.log('üìä Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤∞Í≥º ÌÉÄÏûÖ:', typeof chartResult);
                            console.log('üìä Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤∞Í≥º ÏÉòÌîå:', chartResult);
                            
                            // ApexCharts dataURI Í≤∞Í≥ºÍ∞Ä Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Ï≤òÎ¶¨
                            if (typeof chartResult === 'object' && chartResult !== null) {
                                if (chartResult.imgURI && typeof chartResult.imgURI === 'string') {
                                    images.hourlyCallsChartImage = chartResult.imgURI;
                                    console.log('‚úÖ ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏÑ±Í≥µ (Í∞ùÏ≤¥ÏóêÏÑú Ï∂îÏ∂ú)');
                                } else {
                                    console.error('‚ùå ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÌòïÏãùÏù¥ ÏûòÎ™ªÎê®:', chartResult);
                                }
                            } else if (typeof chartResult === 'string' && chartResult.startsWith('data:image/')) {
                                images.hourlyCallsChartImage = chartResult;
                                console.log('‚úÖ ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏÑ±Í≥µ (Î¨∏ÏûêÏó¥)');
                            } else {
                                console.error('‚ùå ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÌòïÏãùÏù¥ ÏûòÎ™ªÎê®:', chartResult);
                            }
                        } catch (error) {
                            console.warn('‚ùå ÏãúÍ∞ÑÎåÄÎ≥Ñ ÌÜµÌôîÎüâ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                        }
                    }
                    
                    console.log('‚úÖ Î™®Îì† Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å');
                    console.log('üìä ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥:', {
                        counselingTypeChartImage: !!images.counselingTypeChartImage,
                        hourlyCallsChartImage: !!images.hourlyCallsChartImage
                    });
                    
                    // ÏµúÏ¢Ö Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
                    console.log('üîç ÏµúÏ¢Ö Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Í≤∞Í≥º ÌôïÏù∏:');
                    Object.keys(images).forEach(key => {
                        const image = images[key];
                        if (image && typeof image === 'string' && image.startsWith('data:image/')) {
                            console.log(`‚úÖ ${key}: ÌÅ¨Í∏∞ ${image.length}, ÏãúÏûë Î∂ÄÎ∂Ñ: ${image.substring(0, 50)}...`);
                        } else {
                            console.log(`‚ùå ${key}: Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞`);
                        }
                    });
                    
                    // ÌååÎùºÎØ∏ÌÑ∞ Ï§ÄÎπÑ
                    const selectedDate = $('#daily_datepicker').val();
                    const params = {
                        date: formatDateToYYYYMMDD(selectedDate),
                        ...images,
                        ...tableData
                    };
                    
                    // ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ (Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®)
                    await downloadDailyExcelWithTableData(params);
                    
                } catch (error) {
                    console.error('‚ùå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    showToast('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            // ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ÏôÄ Ïù¥ÎØ∏ÏßÄÎ•º Ìè¨Ìï®Ìïú ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠
            async function downloadDailyExcelWithTableData(params) {
                try {
                    showToast('ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ÏôÄ Ï∞®Ìä∏Í∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...', 'info');
                    
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    
                    const response = await fetch('/stat/daily/excel-with-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(params)
                    });
                    
                    if (response.ok) {
                        // ÌååÏùº Îã§Ïö¥Î°úÎìú
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ÏùºÏùºÏö¥ÏòÅÌòÑÌô©_' + params.date + '.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showToast('ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                    } else {
                        throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
                    }
                    
                } catch (error) {
                    console.error('‚ùå ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                    showToast('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            // Ïù¥ÎØ∏ÏßÄÎ•º Ìè¨Ìï®Ìïú ÏùºÏùº Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠ (Í∏∞Ï°¥ - Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
            async function downloadDailyExcelWithImages(params) {
                try {
                    showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...', 'info');
                    
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    
                    const response = await fetch('/stat/daily/excel-with-images', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(params)
                    });
                    
                    if (response.ok) {
                        // ÌååÏùº Îã§Ïö¥Î°úÎìú
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ÏùºÏùºÏö¥ÏòÅÌòÑÌô©_' + params.date + '.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                    } else {
                        throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
                    }
                    
                } catch (error) {
                    console.error('‚ùå ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                    showToast('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
            function showToast(message, type = 'info') {
                const existingToast = document.querySelector('.toast-message');
                if (existingToast) {
                    existingToast.remove();
                }
                
                const toast = document.createElement('div');
                toast.className = `toast-message toast-${type}`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 400px;
                    animation: slideInRight 0.3s ease;
                `;
                
                switch (type) {
                    case 'success':
                        toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        break;
                    case 'error':
                        toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                        break;
                    case 'warning':
                        toast.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        break;
                    default:
                        toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                }
                
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 5000);
            }
        });
    </script>
    <!--end::Javascript-->
</div>
</html> 