<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">ì£¼ê°„ ìš´ì˜í˜„í™©</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">í†µê³„</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ì£¼ê°„ ìš´ì˜í˜„í™©</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 1.ì£¼ê°„ í†µê³„ í˜„í™© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">1.ì£¼ê°„ í†µê³„ í˜„í™©</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-250px" placeholder="ë‚ ì§œ ë²”ìœ„ ì„ íƒ" id="weekly_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">ì¡°íšŒ</button>
                                <button type="button" class="btn btn-success ms-3" id="excelDownloadBtn">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ì¼ì</th>
                                    <th>ì´ì½œ</th>
                                    <th>ì¤‘ë³µì œê±°í˜¸</th>
                                    <th>ì‘ëŒ€í˜¸</th>
                                    <th>í¬ê¸°í˜¸</th>
                                    <th>ë¶€ì¬í˜¸(BUSY)</th>
                                    <th>ì´ìƒë‹´ì™„ë£Œí˜¸</th>
                                    <th>ìˆ˜ì‹ í˜¸</th>
                                    <th>ë°œì‹ í˜¸</th>
                                    <th>ì‘ëŒ€ìœ¨</th>
                                    <th>ì™„ë£Œìœ¨</th>
                                    <th>ìˆ˜ì‹ ë¹„ìœ¨</th>
                                    <th>ë°œì‹ ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <tr>
                                    <td>2024-02-02</td>
                                    <td>23</td>
                                    <td>15</td>
                                    <td>6</td>
                                    <td>17</td>
                                    <td>16</td>
                                    <td>1</td>
                                    <td>18</td>
                                    <td>5</td>
                                    <td>94.1%</td>
                                    <td>94.1%</td>
                                    <td>78.3%</td>
                                    <td>21.7%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-05</td>
                                    <td>21</td>
                                    <td>8</td>
                                    <td>9</td>
                                    <td>12</td>
                                    <td>11</td>
                                    <td>1</td>
                                    <td>12</td>
                                    <td>9</td>
                                    <td>91.7%</td>
                                    <td>91.7%</td>
                                    <td>52.4%</td>
                                    <td>47.6%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-06</td>
                                    <td>18</td>
                                    <td>11</td>
                                    <td>5</td>
                                    <td>13</td>
                                    <td>8</td>
                                    <td>5</td>
                                    <td>10</td>
                                    <td>8</td>
                                    <td>61.5%</td>
                                    <td>61.5%</td>
                                    <td>55.6%</td>
                                    <td>44.4%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-07</td>
                                    <td>10</td>
                                    <td>7</td>
                                    <td>3</td>
                                    <td>7</td>
                                    <td>5</td>
                                    <td>2</td>
                                    <td>5</td>
                                    <td>5</td>
                                    <td>71.4%</td>
                                    <td>71.4%</td>
                                    <td>50.0%</td>
                                    <td>50.0%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-08</td>
                                    <td>6</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>0</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì˜ì—­ -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">ì£¼ê°„ ìš´ì˜ ì¶”ì´</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_weekly_trend_chart" style="height: 350px;"></div>
                    </div>
                </div>

                <!-- 2.ì£¼ê°„ í†µí™” ì‹œê°„ í˜„í™©
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.ì£¼ê°„ í†µí™” ì‹œê°„ í˜„í™©</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ì¼ì</th>
                                    <th>í†µí™”ì¸ì›</th>
                                    <th>ì´í†µí™”ì‹œê°„(ì´ˆ)</th>
                                    <th>ì¡°íšŒí˜¸</th>
                                    <th>CBê±´ìˆ˜</th>
                                    <th>ê°œì‹œê±´</th>
                                    <th>í‰ê· </th>
                                    <th>ì´í†µí™”ì‹œê°„</th>
                                    <th>IN í†µí™”ì‹œê°„</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <tr>
                                    <td>2024-02-02</td>
                                    <td>2</td>
                                    <td>15</td>
                                    <td>16</td>
                                    <td>2</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>29</td>
                                    <td>1:08:17</td>
                                </tr>
                                <tr>
                                    <td>2024-02-03</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0:00:00</td>
                                </tr>
                                <tr>
                                    <td>2024-02-04</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0:00:00</td>
                                </tr>
                                <tr>
                                    <td>2024-02-05</td>
                                    <td>2</td>
                                    <td>8</td>
                                    <td>11</td>
                                    <td>3</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>25</td>
                                    <td>0:35:40</td>
                                </tr>
                                <tr>
                                    <td>2024-02-06</td>
                                    <td>2</td>
                                    <td>11</td>
                                    <td>8</td>
                                    <td>5</td>
                                    <td>7</td>
                                    <td>0</td>
                                    <td>20</td>
                                    <td>0:34:55</td>
                                </tr>
                                <tr>
                                    <td>2024-02-07</td>
                                    <td>2</td>
                                    <td>7</td>
                                    <td>5</td>
                                    <td>0</td>
                                    <td>9</td>
                                    <td>0</td>
                                    <td>14</td>
                                    <td>0:16:39</td>
                                </tr>
                                <tr>
                                    <td>2024-02-08</td>
                                    <td>2</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>0</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>14</td>
                                    <td>0:07:05</td>
                                </tr>
                                <tr class="fw-bold bg-light-primary">
                                    <td>í•©ê³„</td>
                                    <td>10</td>
                                    <td>44</td>
                                    <td>43</td>
                                    <td>10</td>
                                    <td>49</td>
                                    <td>0</td>
                                    <td>102</td>
                                    <td>1:08:17</td>
                                </tr>
                                <tr class="fw-bold bg-light-secondary">
                                    <td>í‰ê· </td>
                                    <td>2</td>
                                    <td>8.8</td>
                                    <td>8.6</td>
                                    <td>2</td>
                                    <td>9.8</td>
                                    <td>0</td>
                                    <td>20.4</td>
                                    <td>1:08:17</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
 -->
                <!-- 3.ìƒë‹´ìœ í˜• ìƒë‹´í˜„í™© -->
                <div class="row g-5 g-xl-8">
                    <div class="col-xl-5">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">2.ìƒë‹´ìœ í˜• ìƒë‹´í˜„í™©</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>ìƒë‹´ìœ í˜•</th>
                                            <th>ìƒë‹´ìˆ˜</th>
                                            <th>ë¹„ìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center">
                                        <tr>
                                            <td rowspan="2">ì§ì›</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td>ì ê·¹ê¶Œìœ /ì¶”ì²œ</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td rowspan="3">ìƒí’ˆ</td>
                                            <td>1</td>
                                            <td>3.2%</td>
                                        </tr>
                                        <tr>
                                            <td>ì¼ë°˜ë¬¸ì˜</td>
                                            <td>3</td>
                                            <td>9.7%</td>
                                        </tr>
                                        <tr>
                                            <td>ìë°œì ë¬¸ì˜</td>
                                            <td>1</td>
                                            <td>3.2%</td>
                                        </tr>
                                        <tr>
                                            <td>ê²°ì œ</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td>ê¸°íƒ€</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card card-flush h-xl-100">
                            <div class="card-body p-0">
                                <div id="kt_weekly_counseling_types" class="min-h-auto" style="height: 400px"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ -->
                <div class="card card-flush mt-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">3.ì£¼ê°„ í˜„í™© ë¹„êµ (ê¸ˆì£¼ vs ì „ì£¼)</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">ì „ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ í†µê³„ ë¹„êµ</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_weekly_comparison_chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // í‰ì¼ ê¸°ì¤€ìœ¼ë¡œ ì´ì „ 5 ì˜ì—…ì¼(ì£¼ë§ ì œì™¸)ì˜ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
        function getLastFiveBusinessDays() {
            const today = new Date();
            let endDate = new Date(today);
            
            // ì˜¤ëŠ˜ì´ ì£¼ë§ì¸ ê²½ìš° ê¸ˆìš”ì¼ë¡œ ì¡°ì •
            const dayOfWeek = today.getDay(); // 0: ì¼ìš”ì¼, 6: í† ìš”ì¼
            if (dayOfWeek === 0) { // ì¼ìš”ì¼ì¸ ê²½ìš°
                endDate = new Date(today);
                endDate.setDate(today.getDate() - 2); // ê¸ˆìš”ì¼ë¡œ ì„¤ì •
            } else if (dayOfWeek === 6) { // í† ìš”ì¼ì¸ ê²½ìš°
                endDate = new Date(today);
                endDate.setDate(today.getDate() - 1); // ê¸ˆìš”ì¼ë¡œ ì„¤ì •
            }
            
            // ì‹œì‘ì¼ ê³„ì‚° (í‰ì¼ 5ì¼ ì „ìœ¼ë¡œ, ì£¼ë§ ì œì™¸)
            let startDate = new Date(endDate);
            let businessDays = 0;
            while (businessDays < 4) { // ì‹œì‘ì¼ í¬í•¨ 5ì¼ì´ë¯€ë¡œ 4ì¼ ì „ìœ¼ë¡œ ì„¤ì •
                startDate.setDate(startDate.getDate() - 1);
                const dayOfWeek = startDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // ì£¼ë§ì´ ì•„ë‹Œ ê²½ìš°
                    businessDays++;
                }
            }
            
            return [startDate, endDate];
        }
        
        // ë‚ ì§œ ë²”ìœ„ ì„ íƒ ì´ˆê¸°í™”
        const defaultDateRange = getLastFiveBusinessDays();
        var datepicker = $("#weekly_datepicker").flatpickr({
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: defaultDateRange,
            locale: "ko",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    // ë‚ ì§œ ì„ íƒ ì‹œ ë°”ë¡œ ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ
                    fetchWeeklyOperationData(selectedDates[0], selectedDates[1]);
                }
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë‚ ì§œë¡œ ë°ì´í„° ì¡°íšŒ
        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Infinity')) {
                console.warn('ì°¨íŠ¸ ë°ì´í„°ì— Infinity ê°’ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.');
                return true; // ì˜¤ë¥˜ë¥¼ "ì²˜ë¦¬ë¨"ìœ¼ë¡œ í‘œì‹œ
            }
        });

        $(document).ready(function() {
            const initialDates = datepicker.selectedDates;
            if (initialDates.length === 2) {
                fetchWeeklyOperationData(initialDates[0], initialDates[1]);
            }
        });

        // ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('searchBtn').addEventListener('click', function() {
            const selectedDates = datepicker.selectedDates;
            if (selectedDates.length === 2) {
                fetchWeeklyOperationData(selectedDates[0], selectedDates[1]);
            }
        });

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('excelDownloadBtn').addEventListener('click', function() {
            const selectedDates = datepicker.selectedDates;
            if (selectedDates.length !== 2) {
                alert('ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            downloadWeeklyOperationExcel();
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function fetchWeeklyOperationData(startDate, endDate) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            // Date ê°ì²´ë¥¼ YYYY-MM-DD í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë³€í™˜
            const formattedStartDate = startDate instanceof Date ? formatDate(startDate) : startDate;
            const formattedEndDate = endDate instanceof Date ? formatDate(endDate) : endDate;
            
            $.ajax({
                url: '/stat/weekly/search',
                type: 'POST',
                data: {
                    startDate: formattedStartDate,
                    endDate: formattedEndDate
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    console.log('ì£¼ê°„ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ:', response);
                    if (response) {
                        // 1. ì£¼ê°„ í†µê³„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸
                        updateSummaryTable(response.summaryStatsList);
                        // 2. ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        updateWeeklyTrendChart(response.summaryStatsList);
                        // 3. ìƒë‹´ìœ í˜• í˜„í™© í…Œì´ë¸” ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        updateCounselingTypeTableAndChart(response.counselingTypeStats);
                        // 4. ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        updateWeeklyComparisonChart(response.yearlyComparison);
                    } else {
                        console.error('ìˆ˜ì‹ ëœ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                        // í…Œì´ë¸” ë° ì°¨íŠ¸ ì´ˆê¸°í™” ë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ ì¶”ê°€
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ì£¼ê°„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                    alert('ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // 1. ì£¼ê°„ í†µê³„ í˜„í™© í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (tbody ë‚´ìš© êµì²´)
        function updateSummaryTable(summaryStatsList) {
            const tbody = $('#kt_app_content_container .card:eq(0) tbody'); // ì²«ë²ˆì§¸ ì¹´ë“œì˜ tbody
            tbody.empty(); // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ

            console.log('ì£¼ê°„ í†µê³„ í˜„í™© ë°ì´í„°:', summaryStatsList);

            if (summaryStatsList && summaryStatsList.length > 0) { // ë°ì´í„°ê°€ ë°°ì—´ í˜•íƒœë¼ê³  ê°€ì •
                summaryStatsList.forEach(stat => {
                    // í•„ë“œ ë§¤í•‘:
                    // statDate: ì¼ì
                    // totalCalls: ì´ì½œ
                    // uniqueInboundCalls: ì¤‘ë³µì œê±°í˜¸
                    // answeredCalls: ì‘ëŒ€í˜¸
                    // abandonedCalls: í¬ê¸°í˜¸
                    // busyCalls: ë¶€ì¬í˜¸(BUSY)
                    // completedCounselingCalls: ì´ìƒë‹´ì™„ë£Œí˜¸
                    // inboundCalls: ìˆ˜ì‹ í˜¸
                    // outboundCalls: ë°œì‹ í˜¸
                    // answerRate: ì‘ëŒ€ìœ¨
                    // completionRate: ì™„ë£Œìœ¨
                    // inboundRate: ìˆ˜ì‹ ë¹„ìœ¨
                    // outboundRate: ë°œì‹ ë¹„ìœ¨
                    const row = `<tr>
                                    <td>${stat.statDate || 'N/A'}</td> 
                                    <td>${stat.totalCalls || 0}</td>
                                    <td>${stat.uniqueInboundCalls || 0}</td>
                                    <td>${stat.answeredCalls || 0}</td>
                                    <td>${stat.abandonedCalls || 0}</td>
                                    <td>${stat.busyCalls || 0}</td>
                                    <td>${stat.completedCounselingCalls || 0}</td>
                                    <td>${stat.inboundCalls || 0}</td>
                                    <td>${stat.outboundCalls || 0}</td>
                                    <td>${(stat.answerRate !== undefined ? stat.answerRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.completionRate !== undefined ? stat.completionRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.inboundRate !== undefined ? stat.inboundRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.outboundRate !== undefined ? stat.outboundRate.toFixed(1) : '0.0')}%</td>
                               </tr>`;
                    tbody.append(row);
                });
            } else if (summaryStatsList) { // ë‹¨ì¼ ê°ì²´ ë°ì´í„°ì¸ ê²½ìš° (ì˜ˆ: í•©ê³„)
                const row = `<tr>
                                    <td>ì „ì²´ê¸°ê°„</td> 
                                    <td>${summaryStatsList.totalCalls || 0}</td>
                                    <td>${summaryStatsList.uniqueInboundCalls || 0}</td>
                                    <td>${summaryStatsList.answeredCalls || 0}</td>
                                    <td>${summaryStatsList.abandonedCalls || 0}</td>
                                    <td>${summaryStatsList.busyCalls || 0}</td>
                                    <td>${summaryStatsList.completedCounselingCalls || 0}</td>
                                    <td>${summaryStatsList.inboundCalls || 0}</td>
                                    <td>${summaryStatsList.outboundCalls || 0}</td>
                                    <td>${(summaryStatsList.answerRate !== undefined ? summaryStatsList.answerRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.completionRate !== undefined ? summaryStatsList.completionRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.inboundRate !== undefined ? summaryStatsList.inboundRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.outboundRate !== undefined ? summaryStatsList.outboundRate.toFixed(1) : '0.0')}%</td>
                           </tr>`;
                tbody.append(row);
            } else {
                tbody.append('<tr><td colspan="13">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            }
        }

        // 2. ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        var weeklyTrendChartInstance = null; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš©
        function updateWeeklyTrendChart(summaryStatsList) {
            var weeklyTrendElement = document.getElementById('kt_weekly_trend_chart');
            if (!weeklyTrendElement) return;

            console.log('ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ë°ì´í„°:', summaryStatsList);

            // ë°ì´í„° ì•ˆì „ì„± ê²€ì¦ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, ë¹ˆ ë¬¸ìì—´ ëª¨ë‘ ì²´í¬
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // ë³€í™˜ í›„ì—ë„ í•œë²ˆ ë” ì²´í¬
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }

            // summaryStatsListë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì°¨íŠ¸ ì‹œë¦¬ì¦ˆì™€ xì¶•ì„ ë™ì ìœ¼ë¡œ ìƒì„±
            let categories = [];
            let totalCallsData = [];
            let uniqueCallsData = [];
            let completionRateData = [];

            if (summaryStatsList && summaryStatsList.length > 0) {
                // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (í•„ìš”í•œ ê²½ìš°)
                summaryStatsList.sort((a, b) => {
                    return new Date(a.statDate) - new Date(b.statDate);
                });
                
                summaryStatsList.forEach(data => {
                    console.log('ì›ë³¸ ë°ì´í„°:', {
                        date: data.statDate,
                        totalCalls: data.totalCalls,
                        uniqueInboundCalls: data.uniqueInboundCalls,
                        completionRate: data.completionRate
                    });
                    
                    categories.push(data.statDate || 'ë‚ ì§œ ì—†ìŒ');
                    totalCallsData.push(safeNumber(data.totalCalls));
                    uniqueCallsData.push(safeNumber(data.uniqueInboundCalls));
                    completionRateData.push(safeNumber(data.completionRate));
                });
                
                console.log('ì²˜ë¦¬ëœ ì°¨íŠ¸ ë°ì´í„°:', {
                    categories,
                    totalCallsData,
                    uniqueCallsData,
                    completionRateData
                });
            }

            // ì°¨íŠ¸ ë°ì´í„°ê°€ ìœ íš¨í•œì§€ í™•ì¸
            const hasValidData = totalCallsData.some(val => val > 0) || 
                                uniqueCallsData.some(val => val > 0) || 
                                completionRateData.some(val => val > 0);

            if (!hasValidData) {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
                weeklyTrendElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #999; font-size: 16px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            var weeklyTrendOptions = {
                series: [{
                    name: 'ì´ì½œ',
                    type: 'column',
                    data: totalCallsData
                }, {
                    name: 'ì¤‘ë³µì œê±°í˜¸',
                    type: 'column',
                    data: uniqueCallsData
                }, {
                    name: 'ì™„ë£Œìœ¨',
                    type: 'line',
                    data: completionRateData
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    stacked: false
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    width: [0, 0, 3]
                },
                title: {
                    text: 'ì£¼ê°„ í†µí™”ê±´ìˆ˜ ë° ì™„ë£Œìœ¨',
                    align: 'left'
                },
                xaxis: {
                    categories: categories
                },
                yaxis: [{
                    title: {
                        text: 'í†µí™”ê±´ìˆ˜(ê±´)',
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(0) : '0'; 
                        } 
                    }
                }, {
                    opposite: true,
                    title: {
                        text: 'ì™„ë£Œìœ¨(%)'
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(1) + '%' : '0.0%'; 
                        } 
                    }
                }],
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (!isFinite(val) || isNaN(val)) return '0';
                            
                            if (opts.seriesIndex === 0 || opts.seriesIndex === 1) {
                                return Number(val).toFixed(0) + " ê±´";
                            } else if (opts.seriesIndex === 2) {
                                return Number(val).toFixed(1) + "%";
                            }
                            return val;
                        }
                    }
                },
                fill: {
                    opacity: [0.85, 0.85, 1],
                    colors: ['#009ef7', '#50cd89', '#ff6384']
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -25
                }
            };

            // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            try {
                if (weeklyTrendChartInstance) {
                    weeklyTrendChartInstance.destroy();
                    weeklyTrendChartInstance = null;
                }
                weeklyTrendChartInstance = new ApexCharts(weeklyTrendElement, weeklyTrendOptions);
                weeklyTrendChartInstance.render();
            } catch (error) {
                console.error('ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                weeklyTrendElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #f44336; font-size: 16px;">ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // 3. ìƒë‹´ìœ í˜• í˜„í™© í…Œì´ë¸” ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        var counselingTypesChartInstance = null;
        function updateCounselingTypeTableAndChart(counselingTypeStats) {
            const tableBody = $('#kt_app_content_container .row.g-5.g-xl-8 .card:eq(0) tbody'); // ìƒë‹´ìœ í˜• í…Œì´ë¸”ì˜ tbody
            tableBody.empty();

            // ë°ì´í„° ì•ˆì „ì„± ê²€ì¦ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, ë¹ˆ ë¬¸ìì—´ ëª¨ë‘ ì²´í¬
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // ë³€í™˜ í›„ì—ë„ í•œë²ˆ ë” ì²´í¬
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }

            let chartSeries = [];
            let chartLabels = [];

            if (counselingTypeStats && counselingTypeStats.length > 0) {
                let groupedStats = {};
                // ë°ì´í„° êµ¬ì¡°ê°€ { counselingType: "ìœ í˜•ëª…", count: 10, percentage: 20.0 } í˜•íƒœì˜ ë°°ì—´ë¡œ ê°€ì •
                // ë§Œì•½ ìœ í˜•ë³„ë¡œ ì—¬ëŸ¬ í•­ëª©(ì˜ˆ: ìƒë‹´ê²½ë¡œ)ì´ ìˆë‹¤ë©´, ì„œë²„ì—ì„œ ì£¼ ìœ í˜•ë³„ë¡œ ì§‘ê³„í•´ì„œ ë‚´ë ¤ì£¼ê±°ë‚˜ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¶”ê°€ ì²˜ë¦¬ í•„ìš”
                // í˜„ì¬ëŠ” counselingTypeì´ ì£¼ ìœ í˜•ì´ë¼ê³  ê°€ì •í•˜ê³  ì§„í–‰
                counselingTypeStats.forEach(stat => {
                    const safeCount = safeNumber(stat.count);
                    const safePercentage = safeNumber(stat.percentage);
                    const row = `<tr>
                                    <td>${stat.counselingTypeName || 'N/A'}</td>
                                    <td>${safeCount}</td>
                                    <td>${safePercentage.toFixed(1)}%</td>
                                 </tr>`;
                    tableBody.append(row);
                    chartLabels.push(stat.counselingTypeName || 'N/A');
                    chartSeries.push(safeCount); // íŒŒì´ì°¨íŠ¸ seriesëŠ” ê°’ì˜ ë°°ì—´
                });
            } else {
                tableBody.append('<tr><td colspan="4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            }

            var counselingTypesElement = document.getElementById('kt_weekly_counseling_types');
            if (!counselingTypesElement) return;

            // ì°¨íŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ëª¨ë“  ê°’ì´ 0ì¸ ê²½ìš° ì²´í¬
            const hasValidData = chartSeries.length > 0 && chartSeries.some(val => val > 0);
            
            if (!hasValidData) {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
                counselingTypesElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #999; font-size: 16px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            var counselingTypesOptions = {
                series: chartSeries, // ì˜ˆì‹œ: [44, 55, 13, 43, 22]
                chart: {
                    type: 'pie',
                    height: 400
                },
                labels: chartLabels, // ì˜ˆì‹œ: ['ìƒí’ˆ', 'ì§ì›', 'ê²°ì œ', 'ìš´ì˜', 'ê¸°íƒ€']
                colors: ['#fe5151', '#5ead60', '#7250e7', '#efc22e', '#487eb3', '#009ef7', '#78c091', '#9d69dd', '#ff9900', '#50cd89'],
                legend: {
                    position: 'right',
                    offsetY: 50
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };

            // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            try {
                if (counselingTypesChartInstance) {
                    counselingTypesChartInstance.destroy();
                    counselingTypesChartInstance = null;
                }
                counselingTypesChartInstance = new ApexCharts(counselingTypesElement, counselingTypesOptions);
                counselingTypesChartInstance.render();
            } catch (error) {
                console.error('ìƒë‹´ìœ í˜• ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                counselingTypesElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #f44336; font-size: 16px;">ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // 4. ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        var weeklyComparisonChartInstance = null;
        function updateWeeklyComparisonChart(yearlyComparison) {
            var weeklyComparisonElement = document.getElementById('kt_weekly_comparison_chart');
            if (!weeklyComparisonElement) return;

            console.log('ì£¼ê°„ í˜„í™© ë¹„êµ ë°ì´í„°:', yearlyComparison);
            
            // ë°ì´í„° ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° ë° ê²€ì¦ (ê°•í™”ëœ ë²„ì „)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, ë¹ˆ ë¬¸ìì—´ ëª¨ë‘ ì²´í¬
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // ë³€í™˜ í›„ì—ë„ í•œë²ˆ ë” ì²´í¬
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }
            
            let currentTotalCalls = safeNumber(yearlyComparison?.totalCallsCurrentYear);
            let previousTotalCalls = safeNumber(yearlyComparison?.totalCallsPreviousYear);
            let currentCompletedCalls = safeNumber(yearlyComparison?.cmplCslCurrYr);
            let previousCompletedCalls = safeNumber(yearlyComparison?.cmplCslPrevYr);
            
            // ì¦ê°ë¥  ì•ˆì „í•˜ê²Œ ê³„ì‚°
            let totalCallsRate = safeNumber(yearlyComparison?.totalCallsComparisonRate);
            let completedCallsRate = safeNumber(yearlyComparison?.completedCounselingCallsComparisonRate);
            
            // ë°ì´í„°ê°€ ëª¨ë‘ 0ì¸ ê²½ìš° ì²´í¬
            const hasValidData = currentTotalCalls > 0 || previousTotalCalls > 0 || currentCompletedCalls > 0 || previousCompletedCalls > 0;
            
            if (!hasValidData) {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
                weeklyComparisonElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #999; font-size: 16px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            // ë¹„êµ ì°¨íŠ¸ ì„¤ì •
            var weeklyComparisonOptions = {
                series: [{
                    name: 'ê¸ˆì£¼',
                    data: [currentTotalCalls, currentCompletedCalls]
                }, {
                    name: 'ì „ì£¼',
                    data: [previousTotalCalls, previousCompletedCalls]
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    stacked: false,
                    toolbar: {
                        show: true
                    },
                    title: {
                        text: 'ê¸ˆì£¼ì™€ ì „ì£¼ í†µê³„ ë¹„êµ',
                        align: 'center',
                        style: {
                            fontSize: '14px'
                        }
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return (isFinite(val) && !isNaN(val)) ? Math.round(val) : '0';
                    },
                    offsetY: -20,
                    style: {
                        fontSize: '12px',
                        colors: ["#304758"]
                    }
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: ['ì´ì½œ', 'ì™„ë£Œì½œ'],
                    title: {
                        text: 'êµ¬ë¶„'
                    }
                },
                yaxis: {
                    title: {
                        text: 'ê±´ìˆ˜'
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (isFinite(val) && !isNaN(val)) ? val.toFixed(0) : '0'; 
                        } 
                    }
                },
                fill: {
                    opacity: 1,
                    colors: ['#009ef7', '#ff6384']
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " ê±´";
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                },
                // ì°¨íŠ¸ í•˜ë‹¨ì— ì¦ê°ë¥  í‘œì‹œ
                annotations: {
                    texts: [
                        {
                            x: 'ì´ì½œ',
                            y: 0,
                            yAxisIndex: 0,
                            borderColor: '#775DD0',
                            label: {
                                borderColor: '#775DD0',
                                style: {
                                    color: '#fff',
                                    background: '#775DD0',
                                },
                                text: 'ì¦ê°ë¥ : ' + (isFinite(totalCallsRate) ? totalCallsRate.toFixed(1) : '0.0') + '%',
                                position: 'bottom',
                                offsetY: 10
                            }
                        },
                        {
                            x: 'ì™„ë£Œì½œ',
                            y: 0,
                            yAxisIndex: 0,
                            borderColor: '#775DD0',
                            label: {
                                borderColor: '#775DD0',
                                style: {
                                    color: '#fff',
                                    background: '#775DD0',
                                },
                                text: 'ì¦ê°ë¥ : ' + (isFinite(completedCallsRate) ? completedCallsRate.toFixed(1) : '0.0') + '%',
                                position: 'bottom',
                                offsetY: 10
                            }
                        }
                    ]
                }
            };

            // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            try {
                if (weeklyComparisonChartInstance) {
                    weeklyComparisonChartInstance.destroy();
                    weeklyComparisonChartInstance = null;
                }
                weeklyComparisonChartInstance = new ApexCharts(weeklyComparisonElement, weeklyComparisonOptions);
                weeklyComparisonChartInstance.render();
            } catch (error) {
                console.error('ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
                weeklyComparisonElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #f44336; font-size: 16px;">ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // ì£¼ê°„ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        async function downloadWeeklyOperationExcel() {
            try {
                console.log('ğŸ“¥ ì£¼ê°„ ìš´ì˜í˜„í™© ì´ë¯¸ì§€ í¬í•¨ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘...');
                showToast('ì°¨íŠ¸ì™€ í…Œì´ë¸”ì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤...', 'info');
                
                const images = {};
                
                // 1. ì£¼ê°„ í†µê³„ í˜„í™© í…Œì´ë¸” ì´ë¯¸ì§€ ìƒì„±
                const summaryTable = document.querySelector('.card:first-child');
                if (summaryTable) {
                    console.log('ğŸ“Š ì£¼ê°„ í†µê³„ í˜„í™© í…Œì´ë¸” ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                    const tableCanvas = await html2canvas(summaryTable, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // ì ì ˆí•œ í•´ìƒë„ë¡œ ì¡°ì •
                        useCORS: true,
                        allowTaint: true,
                        width: summaryTable.offsetWidth,
                        height: summaryTable.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.summaryTableImage = tableCanvas.toDataURL('image/png', 1.0);
                }
                
                // 2. ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (ApexCharts - ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€)
                if (weeklyTrendChartInstance) {
                    console.log('ğŸ“ˆ ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                    try {
                        images.weeklyTrendChartImage = await weeklyTrendChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€
                        });
                    } catch (error) {
                        console.warn('ì£¼ê°„ ìš´ì˜ ì¶”ì´ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                    }
                }
                
                // 3. ìƒë‹´ìœ í˜• í˜„í™© ì„¹ì…˜ ì´ë¯¸ì§€ ìƒì„±
                const counselingSection = document.querySelector('.row.g-5.g-xl-8');
                if (counselingSection) {
                    console.log('ğŸ“Š ìƒë‹´ìœ í˜• í˜„í™© ì„¹ì…˜ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                    const counselingCanvas = await html2canvas(counselingSection, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // ì ì ˆí•œ í•´ìƒë„ë¡œ ì¡°ì •
                        useCORS: true,
                        allowTaint: true,
                        width: counselingSection.offsetWidth,
                        height: counselingSection.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.counselingSectionImage = counselingCanvas.toDataURL('image/png', 1.0);
                }
                
                // 4. ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (ApexCharts - ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€)
                if (counselingTypesChartInstance) {
                    console.log('ğŸ• ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                    try {
                        images.counselingTypesChartImage = await counselingTypesChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€
                        });
                    } catch (error) {
                        console.warn('ìƒë‹´ìœ í˜• ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                    }
                }
                
                // 5. ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (ApexCharts - ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€)
                if (weeklyComparisonChartInstance) {
                    console.log('ğŸ“Š ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                    try {
                        images.weeklyComparisonChartImage = await weeklyComparisonChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ì›ë³¸ í¬ê¸° ë¹„ìœ¨ ìœ ì§€
                        });
                    } catch (error) {
                        console.warn('ì£¼ê°„ í˜„í™© ë¹„êµ ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                    }
                }
                
                console.log('âœ… ëª¨ë“  ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ');
                
                // íŒŒë¼ë¯¸í„° ì¤€ë¹„
                const selectedDates = datepicker.selectedDates;
                const startDate = formatDate(selectedDates[0]);
                const endDate = formatDate(selectedDates[1]);
                const params = {
                    startDate: startDate,
                    endDate: endDate,
                    ...images
                };
                
                // ì„œë²„ë¡œ POST ìš”ì²­ (ì´ë¯¸ì§€ í¬í•¨)
                await downloadWeeklyExcelWithImages(params);
                
            } catch (error) {
                console.error('âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                showToast('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ì£¼ê°„ ìš´ì˜í˜„í™© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­
        async function downloadWeeklyExcelWithImages(params) {
            try {
                showToast('ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                
                const response = await fetch('/stat/weekly/excel-with-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ì£¼ê°„ìš´ì˜í˜„í™©_' + params.startDate + '_' + params.endDate + '.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;
            
            switch (type) {
                case 'success':
                    toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                default:
                    toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // ê¸°ì¡´ ì°¨íŠ¸ ì´ˆê¸°í™” ì½”ë“œëŠ” ì‚­ì œ (fetchWeeklyOperationData ì„±ê³µ ì‹œ ë™ì ìœ¼ë¡œ ìƒì„± ë° ì—…ë°ì´íŠ¸)

    </script>
    <!--end::Javascript-->
</div>
</html> 