<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}">
<!--begin::Main-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<div layout:fragment="content">
    <script src="/assets/plugins/global/plugins.bundle.js"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <div class="d-flex flex-column flex-column-fluid">
        <!--begin::Toolbar-->
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <!--begin::Toolbar container-->
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <!--begin::Page title-->
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <!--begin::Title-->
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">Ï£ºÍ∞Ñ Ïö¥ÏòÅÌòÑÌô©</h1>
                    <!--end::Title-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/main" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">ÌÜµÍ≥Ñ</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">Ï£ºÍ∞Ñ Ïö¥ÏòÅÌòÑÌô©</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
                <!--end::Page title-->
            </div>
            <!--end::Toolbar container-->
        </div>
        <!--end::Toolbar-->

        <!--begin::Content-->
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <!--begin::Content container-->
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- 1.Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">1.Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô©</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="d-flex align-items-center position-relative">
                                <input class="form-control form-control-solid w-250px" placeholder="ÎÇ†Ïßú Î≤îÏúÑ ÏÑ†ÌÉù" id="weekly_datepicker" readonly/>
                                <button type="button" class="btn btn-primary ms-3" id="searchBtn">Ï°∞Ìöå</button>
                                <button type="button" class="btn btn-success ms-3" id="excelDownloadBtn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ÏùºÏûê</th>
                                    <th>Ï¥ùÏΩú</th>
                                    <th>Ï§ëÎ≥µÏ†úÍ±∞Ìò∏</th>
                                    <th>ÏùëÎåÄÌò∏</th>
                                    <th>Ìè¨Í∏∞Ìò∏</th>
                                    <th>Î∂ÄÏû¨Ìò∏(BUSY)</th>
                                    <th>Ï¥ùÏÉÅÎã¥ÏôÑÎ£åÌò∏</th>
                                    <th>ÏàòÏã†Ìò∏</th>
                                    <th>Î∞úÏã†Ìò∏</th>
                                    <th>ÏùëÎåÄÏú®</th>
                                    <th>ÏôÑÎ£åÏú®</th>
                                    <th>ÏàòÏã†ÎπÑÏú®</th>
                                    <th>Î∞úÏã†ÎπÑÏú®</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <tr>
                                    <td>2024-02-02</td>
                                    <td>23</td>
                                    <td>15</td>
                                    <td>6</td>
                                    <td>17</td>
                                    <td>16</td>
                                    <td>1</td>
                                    <td>18</td>
                                    <td>5</td>
                                    <td>94.1%</td>
                                    <td>94.1%</td>
                                    <td>78.3%</td>
                                    <td>21.7%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-05</td>
                                    <td>21</td>
                                    <td>8</td>
                                    <td>9</td>
                                    <td>12</td>
                                    <td>11</td>
                                    <td>1</td>
                                    <td>12</td>
                                    <td>9</td>
                                    <td>91.7%</td>
                                    <td>91.7%</td>
                                    <td>52.4%</td>
                                    <td>47.6%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-06</td>
                                    <td>18</td>
                                    <td>11</td>
                                    <td>5</td>
                                    <td>13</td>
                                    <td>8</td>
                                    <td>5</td>
                                    <td>10</td>
                                    <td>8</td>
                                    <td>61.5%</td>
                                    <td>61.5%</td>
                                    <td>55.6%</td>
                                    <td>44.4%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-07</td>
                                    <td>10</td>
                                    <td>7</td>
                                    <td>3</td>
                                    <td>7</td>
                                    <td>5</td>
                                    <td>2</td>
                                    <td>5</td>
                                    <td>5</td>
                                    <td>71.4%</td>
                                    <td>71.4%</td>
                                    <td>50.0%</td>
                                    <td>50.0%</td>
                                </tr>
                                <tr>
                                    <td>2024-02-08</td>
                                    <td>6</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>0</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                    <td>100%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_weekly_trend_chart" style="height: 350px;"></div>
                    </div>
                </div>

                <!-- 2.Ï£ºÍ∞Ñ ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô©
                <div class="card card-flush mb-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">2.Ï£ºÍ∞Ñ ÌÜµÌôî ÏãúÍ∞Ñ ÌòÑÌô©</span>
                        </h3>
                    </div>
                    <div class="card-body pt-0">
                        <table class="table table-row-bordered table-striped gy-5 gs-7">
                            <thead>
                                <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                    <th>ÏùºÏûê</th>
                                    <th>ÌÜµÌôîÏù∏Ïõê</th>
                                    <th>Ï¥ùÌÜµÌôîÏãúÍ∞Ñ(Ï¥à)</th>
                                    <th>Ï°∞ÌöåÌò∏</th>
                                    <th>CBÍ±¥Ïàò</th>
                                    <th>Í∞úÏãúÍ±¥</th>
                                    <th>ÌèâÍ∑†</th>
                                    <th>Ï¥ùÌÜµÌôîÏãúÍ∞Ñ</th>
                                    <th>IN ÌÜµÌôîÏãúÍ∞Ñ</th>
                                </tr>
                            </thead>
                            <tbody class="text-center">
                                <tr>
                                    <td>2024-02-02</td>
                                    <td>2</td>
                                    <td>15</td>
                                    <td>16</td>
                                    <td>2</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>29</td>
                                    <td>1:08:17</td>
                                </tr>
                                <tr>
                                    <td>2024-02-03</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0:00:00</td>
                                </tr>
                                <tr>
                                    <td>2024-02-04</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0:00:00</td>
                                </tr>
                                <tr>
                                    <td>2024-02-05</td>
                                    <td>2</td>
                                    <td>8</td>
                                    <td>11</td>
                                    <td>3</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>25</td>
                                    <td>0:35:40</td>
                                </tr>
                                <tr>
                                    <td>2024-02-06</td>
                                    <td>2</td>
                                    <td>11</td>
                                    <td>8</td>
                                    <td>5</td>
                                    <td>7</td>
                                    <td>0</td>
                                    <td>20</td>
                                    <td>0:34:55</td>
                                </tr>
                                <tr>
                                    <td>2024-02-07</td>
                                    <td>2</td>
                                    <td>7</td>
                                    <td>5</td>
                                    <td>0</td>
                                    <td>9</td>
                                    <td>0</td>
                                    <td>14</td>
                                    <td>0:16:39</td>
                                </tr>
                                <tr>
                                    <td>2024-02-08</td>
                                    <td>2</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>0</td>
                                    <td>11</td>
                                    <td>0</td>
                                    <td>14</td>
                                    <td>0:07:05</td>
                                </tr>
                                <tr class="fw-bold bg-light-primary">
                                    <td>Ìï©Í≥Ñ</td>
                                    <td>10</td>
                                    <td>44</td>
                                    <td>43</td>
                                    <td>10</td>
                                    <td>49</td>
                                    <td>0</td>
                                    <td>102</td>
                                    <td>1:08:17</td>
                                </tr>
                                <tr class="fw-bold bg-light-secondary">
                                    <td>ÌèâÍ∑†</td>
                                    <td>2</td>
                                    <td>8.8</td>
                                    <td>8.6</td>
                                    <td>2</td>
                                    <td>9.8</td>
                                    <td>0</td>
                                    <td>20.4</td>
                                    <td>1:08:17</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
 -->
                <!-- 3.ÏÉÅÎã¥Ïú†Ìòï ÏÉÅÎã¥ÌòÑÌô© -->
                <div class="row g-5 g-xl-8">
                    <div class="col-xl-5">
                        <div class="card card-flush h-xl-100">
                            <div class="card-header border-0 pt-5">
                                <h3 class="card-title align-items-start flex-column">
                                    <span class="card-label fw-bold fs-3 mb-1">2.ÏÉÅÎã¥Ïú†Ìòï ÏÉÅÎã¥ÌòÑÌô©</span>
                                </h3>
                            </div>
                            <div class="card-body pt-0">
                                <table class="table table-row-bordered table-striped gy-5 gs-7">
                                    <thead>
                                        <tr class="fw-semibold fs-6 text-gray-800 text-center border-bottom border-gray-200">
                                            <th>ÏÉÅÎã¥Ïú†Ìòï</th>
                                            <th>ÏÉÅÎã¥Ïàò</th>
                                            <th>ÎπÑÏú®</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center">
                                        <tr>
                                            <td rowspan="2">ÏßÅÏõê</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td>Ï†ÅÍ∑πÍ∂åÏú†/Ï∂îÏ≤ú</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td rowspan="3">ÏÉÅÌíà</td>
                                            <td>1</td>
                                            <td>3.2%</td>
                                        </tr>
                                        <tr>
                                            <td>ÏùºÎ∞òÎ¨∏Ïùò</td>
                                            <td>3</td>
                                            <td>9.7%</td>
                                        </tr>
                                        <tr>
                                            <td>ÏûêÎ∞úÏ†ÅÎ¨∏Ïùò</td>
                                            <td>1</td>
                                            <td>3.2%</td>
                                        </tr>
                                        <tr>
                                            <td>Í≤∞Ï†ú</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                        <tr>
                                            <td>Í∏∞ÌÉÄ</td>
                                            <td>0</td>
                                            <td>0%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card card-flush h-xl-100">
                            <div class="card-body p-0">
                                <div id="kt_weekly_counseling_types" class="min-h-auto" style="height: 400px"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ -->
                <div class="card card-flush mt-6">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">3.Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê (Í∏àÏ£º vs Ï†ÑÏ£º)</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">Ï†ÑÏ£º ÎåÄÎπÑ Ïù¥Î≤àÏ£º ÌÜµÍ≥Ñ ÎπÑÍµê</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="kt_weekly_comparison_chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>
            <!--end::Content container-->
        </div>
        <!--end::Content-->
    </div>

    <!--begin::Javascript-->
    <script>
        // ÌèâÏùº Í∏∞Ï§ÄÏúºÎ°ú Ïù¥Ï†Ñ 5 ÏòÅÏóÖÏùº(Ï£ºÎßê Ï†úÏô∏)Ïùò ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏùÑ Í≥ÑÏÇ∞ÌïòÎäî Ìï®Ïàò
        function getLastFiveBusinessDays() {
            const today = new Date();
            let endDate = new Date(today);
            
            // Ïò§ÎäòÏù¥ Ï£ºÎßêÏù∏ Í≤ΩÏö∞ Í∏àÏöîÏùºÎ°ú Ï°∞Ï†ï
            const dayOfWeek = today.getDay(); // 0: ÏùºÏöîÏùº, 6: ÌÜ†ÏöîÏùº
            if (dayOfWeek === 0) { // ÏùºÏöîÏùºÏù∏ Í≤ΩÏö∞
                endDate = new Date(today);
                endDate.setDate(today.getDate() - 2); // Í∏àÏöîÏùºÎ°ú ÏÑ§Ï†ï
            } else if (dayOfWeek === 6) { // ÌÜ†ÏöîÏùºÏù∏ Í≤ΩÏö∞
                endDate = new Date(today);
                endDate.setDate(today.getDate() - 1); // Í∏àÏöîÏùºÎ°ú ÏÑ§Ï†ï
            }
            
            // ÏãúÏûëÏùº Í≥ÑÏÇ∞ (ÌèâÏùº 5Ïùº Ï†ÑÏúºÎ°ú, Ï£ºÎßê Ï†úÏô∏)
            let startDate = new Date(endDate);
            let businessDays = 0;
            while (businessDays < 4) { // ÏãúÏûëÏùº Ìè¨Ìï® 5ÏùºÏù¥ÎØÄÎ°ú 4Ïùº Ï†ÑÏúºÎ°ú ÏÑ§Ï†ï
                startDate.setDate(startDate.getDate() - 1);
                const dayOfWeek = startDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Ï£ºÎßêÏù¥ ÏïÑÎãå Í≤ΩÏö∞
                    businessDays++;
                }
            }
            
            return [startDate, endDate];
        }
        
        // ÎÇ†Ïßú Î≤îÏúÑ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        const defaultDateRange = getLastFiveBusinessDays();
        var datepicker = $("#weekly_datepicker").flatpickr({
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: defaultDateRange,
            locale: "ko",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    // ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú Î∞îÎ°ú Ï°∞Ìöå Ìï®Ïàò Ìò∏Ï∂ú
                    fetchWeeklyOperationData(selectedDates[0], selectedDates[1]);
                }
            }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Î≥∏ ÎÇ†ÏßúÎ°ú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
        // Ï†ÑÏó≠ Ïò§Î•ò Ï≤òÎ¶¨
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Infinity')) {
                console.warn('Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Ïóê Infinity Í∞íÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Ïù¥Îäî Î¨¥ÏãúÎê©ÎãàÎã§.');
                return true; // Ïò§Î•òÎ•º "Ï≤òÎ¶¨Îê®"ÏúºÎ°ú ÌëúÏãú
            }
        });

        $(document).ready(function() {
            const initialDates = datepicker.selectedDates;
            if (initialDates.length === 2) {
                fetchWeeklyOperationData(initialDates[0], initialDates[1]);
            }
        });

        // Í≤ÄÏÉâ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('searchBtn').addEventListener('click', function() {
            const selectedDates = datepicker.selectedDates;
            if (selectedDates.length === 2) {
                fetchWeeklyOperationData(selectedDates[0], selectedDates[1]);
            }
        });

        // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('excelDownloadBtn').addEventListener('click', function() {
            const selectedDates = datepicker.selectedDates;
            if (selectedDates.length !== 2) {
                alert('ÎÇ†Ïßú Î≤îÏúÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            downloadWeeklyOperationExcel();
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function fetchWeeklyOperationData(startDate, endDate) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            // Date Í∞ùÏ≤¥Î•º YYYY-MM-DD ÌòïÏãùÏùò Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
            const formattedStartDate = startDate instanceof Date ? formatDate(startDate) : startDate;
            const formattedEndDate = endDate instanceof Date ? formatDate(endDate) : endDate;
            
            $.ajax({
                url: '/stat/weekly/search',
                type: 'POST',
                data: {
                    startDate: formattedStartDate,
                    endDate: formattedEndDate
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    console.log('Ï£ºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÏÑ±Í≥µ:', response);
                    if (response) {
                        // 1. Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
                        updateSummaryTable(response.summaryStatsList);
                        // 2. Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        updateWeeklyTrendChart(response.summaryStatsList);
                        // 3. ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Î∞è Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        updateCounselingTypeTableAndChart(response.counselingTypeStats);
                        // 4. Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        updateWeeklyComparisonChart(response.yearlyComparison);
                    } else {
                        console.error('ÏàòÏã†Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                        // ÌÖåÏù¥Î∏î Î∞è Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî ÎòêÎäî ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú Î°úÏßÅ Ï∂îÍ∞Ä
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ï£ºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:', error);
                    alert('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            });
        }

        // 1. Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (tbody ÎÇ¥Ïö© ÍµêÏ≤¥)
        function updateSummaryTable(summaryStatsList) {
            const tbody = $('#kt_app_content_container .card:eq(0) tbody'); // Ï≤´Î≤àÏß∏ Ïπ¥ÎìúÏùò tbody
            tbody.empty(); // Í∏∞Ï°¥ ÎÇ¥Ïö© ÏÇ≠Ï†ú

            console.log('Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© Îç∞Ïù¥ÌÑ∞:', summaryStatsList);

            if (summaryStatsList && summaryStatsList.length > 0) { // Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥ ÌòïÌÉúÎùºÍ≥† Í∞ÄÏ†ï
                summaryStatsList.forEach(stat => {
                    // ÌïÑÎìú Îß§Ìïë:
                    // statDate: ÏùºÏûê
                    // totalCalls: Ï¥ùÏΩú
                    // uniqueInboundCalls: Ï§ëÎ≥µÏ†úÍ±∞Ìò∏
                    // answeredCalls: ÏùëÎåÄÌò∏
                    // abandonedCalls: Ìè¨Í∏∞Ìò∏
                    // busyCalls: Î∂ÄÏû¨Ìò∏(BUSY)
                    // completedCounselingCalls: Ï¥ùÏÉÅÎã¥ÏôÑÎ£åÌò∏
                    // inboundCalls: ÏàòÏã†Ìò∏
                    // outboundCalls: Î∞úÏã†Ìò∏
                    // answerRate: ÏùëÎåÄÏú®
                    // completionRate: ÏôÑÎ£åÏú®
                    // inboundRate: ÏàòÏã†ÎπÑÏú®
                    // outboundRate: Î∞úÏã†ÎπÑÏú®
                    const row = `<tr>
                                    <td>${stat.statDate || 'N/A'}</td> 
                                    <td>${stat.totalCalls || 0}</td>
                                    <td>${stat.uniqueInboundCalls || 0}</td>
                                    <td>${stat.answeredCalls || 0}</td>
                                    <td>${stat.abandonedCalls || 0}</td>
                                    <td>${stat.busyCalls || 0}</td>
                                    <td>${stat.completedCounselingCalls || 0}</td>
                                    <td>${stat.inboundCalls || 0}</td>
                                    <td>${stat.outboundCalls || 0}</td>
                                    <td>${(stat.answerRate !== undefined ? stat.answerRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.completionRate !== undefined ? stat.completionRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.inboundRate !== undefined ? stat.inboundRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(stat.outboundRate !== undefined ? stat.outboundRate.toFixed(1) : '0.0')}%</td>
                               </tr>`;
                    tbody.append(row);
                });
            } else if (summaryStatsList) { // Îã®Ïùº Í∞ùÏ≤¥ Îç∞Ïù¥ÌÑ∞Ïù∏ Í≤ΩÏö∞ (Ïòà: Ìï©Í≥Ñ)
                const row = `<tr>
                                    <td>Ï†ÑÏ≤¥Í∏∞Í∞Ñ</td> 
                                    <td>${summaryStatsList.totalCalls || 0}</td>
                                    <td>${summaryStatsList.uniqueInboundCalls || 0}</td>
                                    <td>${summaryStatsList.answeredCalls || 0}</td>
                                    <td>${summaryStatsList.abandonedCalls || 0}</td>
                                    <td>${summaryStatsList.busyCalls || 0}</td>
                                    <td>${summaryStatsList.completedCounselingCalls || 0}</td>
                                    <td>${summaryStatsList.inboundCalls || 0}</td>
                                    <td>${summaryStatsList.outboundCalls || 0}</td>
                                    <td>${(summaryStatsList.answerRate !== undefined ? summaryStatsList.answerRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.completionRate !== undefined ? summaryStatsList.completionRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.inboundRate !== undefined ? summaryStatsList.inboundRate.toFixed(1) : '0.0')}%</td>
                                    <td>${(summaryStatsList.outboundRate !== undefined ? summaryStatsList.outboundRate.toFixed(1) : '0.0')}%</td>
                           </tr>`;
                tbody.append(row);
            } else {
                tbody.append('<tr><td colspan="13">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>');
            }
        }

        // 2. Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var weeklyTrendChartInstance = null; // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•Ïö©
        function updateWeeklyTrendChart(summaryStatsList) {
            var weeklyTrendElement = document.getElementById('kt_weekly_trend_chart');
            if (!weeklyTrendElement) return;

            console.log('Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞:', summaryStatsList);

            // Îç∞Ïù¥ÌÑ∞ ÏïàÏ†ÑÏÑ± Í≤ÄÏ¶ù Ìï®Ïàò (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, Îπà Î¨∏ÏûêÏó¥ Î™®Îëê Ï≤¥ÌÅ¨
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // Î≥ÄÌôò ÌõÑÏóêÎèÑ ÌïúÎ≤à Îçî Ï≤¥ÌÅ¨
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }

            // summaryStatsListÎ•º Í∏∞Î∞òÏúºÎ°ú Ï∞®Ìä∏ ÏãúÎ¶¨Ï¶àÏôÄ xÏ∂ïÏùÑ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
            let categories = [];
            let totalCallsData = [];
            let uniqueCallsData = [];
            let completionRateData = [];

            if (summaryStatsList && summaryStatsList.length > 0) {
                // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÌïÑÏöîÌïú Í≤ΩÏö∞)
                summaryStatsList.sort((a, b) => {
                    return new Date(a.statDate) - new Date(b.statDate);
                });
                
                summaryStatsList.forEach(data => {
                    console.log('ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞:', {
                        date: data.statDate,
                        totalCalls: data.totalCalls,
                        uniqueInboundCalls: data.uniqueInboundCalls,
                        completionRate: data.completionRate
                    });
                    
                    categories.push(data.statDate || 'ÎÇ†Ïßú ÏóÜÏùå');
                    totalCallsData.push(safeNumber(data.totalCalls));
                    uniqueCallsData.push(safeNumber(data.uniqueInboundCalls));
                    completionRateData.push(safeNumber(data.completionRate));
                });
                
                console.log('Ï≤òÎ¶¨Îêú Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞:', {
                    categories,
                    totalCallsData,
                    uniqueCallsData,
                    completionRateData
                });
            }

            // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
            const hasValidData = totalCallsData.some(val => val > 0) || 
                                uniqueCallsData.some(val => val > 0) || 
                                completionRateData.some(val => val > 0);

            if (!hasValidData) {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå" Î©îÏãúÏßÄ ÌëúÏãú
                weeklyTrendElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #999; font-size: 16px;">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            var weeklyTrendOptions = {
                series: [{
                    name: 'Ï¥ùÏΩú',
                    type: 'column',
                    data: totalCallsData
                }, {
                    name: 'Ï§ëÎ≥µÏ†úÍ±∞Ìò∏',
                    type: 'column',
                    data: uniqueCallsData
                }, {
                    name: 'ÏôÑÎ£åÏú®',
                    type: 'line',
                    data: completionRateData
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    stacked: false
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    width: [0, 0, 3]
                },
                title: {
                    text: 'Ï£ºÍ∞Ñ ÌÜµÌôîÍ±¥Ïàò Î∞è ÏôÑÎ£åÏú®',
                    align: 'left'
                },
                xaxis: {
                    categories: categories
                },
                yaxis: [{
                    title: {
                        text: 'ÌÜµÌôîÍ±¥Ïàò(Í±¥)',
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(0) : '0'; 
                        } 
                    }
                }, {
                    opposite: true,
                    title: {
                        text: 'ÏôÑÎ£åÏú®(%)'
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (!isNaN(val) && isFinite(val)) ? Number(val).toFixed(1) + '%' : '0.0%'; 
                        } 
                    }
                }],
                tooltip: {
                    y: {
                        formatter: function (val, opts) {
                            if (!isFinite(val) || isNaN(val)) return '0';
                            
                            if (opts.seriesIndex === 0 || opts.seriesIndex === 1) {
                                return Number(val).toFixed(0) + " Í±¥";
                            } else if (opts.seriesIndex === 2) {
                                return Number(val).toFixed(1) + "%";
                            }
                            return val;
                        }
                    }
                },
                fill: {
                    opacity: [0.85, 0.85, 1],
                    colors: ['#009ef7', '#50cd89', '#ff6384']
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -25
                }
            };

            // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ ÏïàÏ†ÑÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            try {
                if (weeklyTrendChartInstance) {
                    weeklyTrendChartInstance.destroy();
                    weeklyTrendChartInstance = null;
                }
                weeklyTrendChartInstance = new ApexCharts(weeklyTrendElement, weeklyTrendOptions);
                weeklyTrendChartInstance.render();
            } catch (error) {
                console.error('Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
                weeklyTrendElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #f44336; font-size: 16px;">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>';
            }
        }

        // 3. ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÌÖåÏù¥Î∏î Î∞è Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var counselingTypesChartInstance = null;
        function updateCounselingTypeTableAndChart(counselingTypeStats) {
            const tableBody = $('#kt_app_content_container .row.g-5.g-xl-8 .card:eq(0) tbody'); // ÏÉÅÎã¥Ïú†Ìòï ÌÖåÏù¥Î∏îÏùò tbody
            tableBody.empty();

            // Îç∞Ïù¥ÌÑ∞ ÏïàÏ†ÑÏÑ± Í≤ÄÏ¶ù Ìï®Ïàò (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, Îπà Î¨∏ÏûêÏó¥ Î™®Îëê Ï≤¥ÌÅ¨
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // Î≥ÄÌôò ÌõÑÏóêÎèÑ ÌïúÎ≤à Îçî Ï≤¥ÌÅ¨
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }

            let chartSeries = [];
            let chartLabels = [];

            if (counselingTypeStats && counselingTypeStats.length > 0) {
                let groupedStats = {};
                // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Í∞Ä { counselingType: "Ïú†ÌòïÎ™Ö", count: 10, percentage: 20.0 } ÌòïÌÉúÏùò Î∞∞Ïó¥Î°ú Í∞ÄÏ†ï
                // ÎßåÏïΩ Ïú†ÌòïÎ≥ÑÎ°ú Ïó¨Îü¨ Ìï≠Î™©(Ïòà: ÏÉÅÎã¥Í≤ΩÎ°ú)Ïù¥ ÏûàÎã§Î©¥, ÏÑúÎ≤ÑÏóêÏÑú Ï£º Ïú†ÌòïÎ≥ÑÎ°ú ÏßëÍ≥ÑÌï¥ÏÑú ÎÇ¥Î†§Ï£ºÍ±∞ÎÇò ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ï∂îÍ∞Ä Ï≤òÎ¶¨ ÌïÑÏöî
                // ÌòÑÏû¨Îäî counselingTypeÏù¥ Ï£º Ïú†ÌòïÏù¥ÎùºÍ≥† Í∞ÄÏ†ïÌïòÍ≥† ÏßÑÌñâ
                counselingTypeStats.forEach(stat => {
                    const safeCount = safeNumber(stat.count);
                    const safePercentage = safeNumber(stat.percentage);
                    const row = `<tr>
                                    <td>${stat.counselingTypeName || 'N/A'}</td>
                                    <td>${safeCount}</td>
                                    <td>${safePercentage.toFixed(1)}%</td>
                                 </tr>`;
                    tableBody.append(row);
                    chartLabels.push(stat.counselingTypeName || 'N/A');
                    chartSeries.push(safeCount); // ÌååÏù¥Ï∞®Ìä∏ seriesÎäî Í∞íÏùò Î∞∞Ïó¥
                });
            } else {
                tableBody.append('<tr><td colspan="4">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>');
            }

            var counselingTypesElement = document.getElementById('kt_weekly_counseling_types');
            if (!counselingTypesElement) return;

            // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Î™®Îì† Í∞íÏù¥ 0Ïù∏ Í≤ΩÏö∞ Ï≤¥ÌÅ¨
            const hasValidData = chartSeries.length > 0 && chartSeries.some(val => val > 0);
            
            if (!hasValidData) {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå" Î©îÏãúÏßÄ ÌëúÏãú
                counselingTypesElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #999; font-size: 16px;">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            var counselingTypesOptions = {
                series: chartSeries, // ÏòàÏãú: [44, 55, 13, 43, 22]
                chart: {
                    type: 'pie',
                    height: 400
                },
                labels: chartLabels, // ÏòàÏãú: ['ÏÉÅÌíà', 'ÏßÅÏõê', 'Í≤∞Ï†ú', 'Ïö¥ÏòÅ', 'Í∏∞ÌÉÄ']
                colors: ['#fe5151', '#5ead60', '#7250e7', '#efc22e', '#487eb3', '#009ef7', '#78c091', '#9d69dd', '#ff9900', '#50cd89'],
                legend: {
                    position: 'right',
                    offsetY: 50
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };

            // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ ÏïàÏ†ÑÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            try {
                if (counselingTypesChartInstance) {
                    counselingTypesChartInstance.destroy();
                    counselingTypesChartInstance = null;
                }
                counselingTypesChartInstance = new ApexCharts(counselingTypesElement, counselingTypesOptions);
                counselingTypesChartInstance.render();
            } catch (error) {
                console.error('ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
                counselingTypesElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #f44336; font-size: 16px;">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>';
            }
        }

        // 4. Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        var weeklyComparisonChartInstance = null;
        function updateWeeklyComparisonChart(yearlyComparison) {
            var weeklyComparisonElement = document.getElementById('kt_weekly_comparison_chart');
            if (!weeklyComparisonElement) return;

            console.log('Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Îç∞Ïù¥ÌÑ∞:', yearlyComparison);
            
            // Îç∞Ïù¥ÌÑ∞ ÏïàÏ†ÑÌïòÍ≤å Í∞ÄÏ†∏Ïò§Í∏∞ Î∞è Í≤ÄÏ¶ù (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
            function safeNumber(value, defaultValue = 0) {
                // null, undefined, NaN, Infinity, Îπà Î¨∏ÏûêÏó¥ Î™®Îëê Ï≤¥ÌÅ¨
                if (value === null || value === undefined || value === '' || 
                    isNaN(value) || !isFinite(value) || value === Infinity || value === -Infinity) {
                    return defaultValue;
                }
                const num = Number(value);
                // Î≥ÄÌôò ÌõÑÏóêÎèÑ ÌïúÎ≤à Îçî Ï≤¥ÌÅ¨
                if (isNaN(num) || !isFinite(num)) {
                    return defaultValue;
                }
                return num;
            }
            
            let currentTotalCalls = safeNumber(yearlyComparison?.totalCallsCurrentYear);
            let previousTotalCalls = safeNumber(yearlyComparison?.totalCallsPreviousYear);
            let currentCompletedCalls = safeNumber(yearlyComparison?.cmplCslCurrYr);
            let previousCompletedCalls = safeNumber(yearlyComparison?.cmplCslPrevYr);
            
            // Ï¶ùÍ∞êÎ•† ÏïàÏ†ÑÌïòÍ≤å Í≥ÑÏÇ∞
            let totalCallsRate = safeNumber(yearlyComparison?.totalCallsComparisonRate);
            let completedCallsRate = safeNumber(yearlyComparison?.completedCounselingCallsComparisonRate);
            
            // Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê 0Ïù∏ Í≤ΩÏö∞ Ï≤¥ÌÅ¨
            const hasValidData = currentTotalCalls > 0 || previousTotalCalls > 0 || currentCompletedCalls > 0 || previousCompletedCalls > 0;
            
            if (!hasValidData) {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå" Î©îÏãúÏßÄ ÌëúÏãú
                weeklyComparisonElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #999; font-size: 16px;">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            // ÎπÑÍµê Ï∞®Ìä∏ ÏÑ§Ï†ï
            var weeklyComparisonOptions = {
                series: [{
                    name: 'Í∏àÏ£º',
                    data: [currentTotalCalls, currentCompletedCalls]
                }, {
                    name: 'Ï†ÑÏ£º',
                    data: [previousTotalCalls, previousCompletedCalls]
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    stacked: false,
                    toolbar: {
                        show: true
                    },
                    title: {
                        text: 'Í∏àÏ£ºÏôÄ Ï†ÑÏ£º ÌÜµÍ≥Ñ ÎπÑÍµê',
                        align: 'center',
                        style: {
                            fontSize: '14px'
                        }
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return (isFinite(val) && !isNaN(val)) ? Math.round(val) : '0';
                    },
                    offsetY: -20,
                    style: {
                        fontSize: '12px',
                        colors: ["#304758"]
                    }
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: ['Ï¥ùÏΩú', 'ÏôÑÎ£åÏΩú'],
                    title: {
                        text: 'Íµ¨Î∂Ñ'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Í±¥Ïàò'
                    },
                    labels: { 
                        formatter: function (val) { 
                            return (isFinite(val) && !isNaN(val)) ? val.toFixed(0) : '0'; 
                        } 
                    }
                },
                fill: {
                    opacity: 1,
                    colors: ['#009ef7', '#ff6384']
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " Í±¥";
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                },
                // Ï∞®Ìä∏ ÌïòÎã®Ïóê Ï¶ùÍ∞êÎ•† ÌëúÏãú
                annotations: {
                    texts: [
                        {
                            x: 'Ï¥ùÏΩú',
                            y: 0,
                            yAxisIndex: 0,
                            borderColor: '#775DD0',
                            label: {
                                borderColor: '#775DD0',
                                style: {
                                    color: '#fff',
                                    background: '#775DD0',
                                },
                                text: 'Ï¶ùÍ∞êÎ•†: ' + (isFinite(totalCallsRate) ? totalCallsRate.toFixed(1) : '0.0') + '%',
                                position: 'bottom',
                                offsetY: 10
                            }
                        },
                        {
                            x: 'ÏôÑÎ£åÏΩú',
                            y: 0,
                            yAxisIndex: 0,
                            borderColor: '#775DD0',
                            label: {
                                borderColor: '#775DD0',
                                style: {
                                    color: '#fff',
                                    background: '#775DD0',
                                },
                                text: 'Ï¶ùÍ∞êÎ•†: ' + (isFinite(completedCallsRate) ? completedCallsRate.toFixed(1) : '0.0') + '%',
                                position: 'bottom',
                                offsetY: 10
                            }
                        }
                    ]
                }
            };

            // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ ÏïàÏ†ÑÌïòÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            try {
                if (weeklyComparisonChartInstance) {
                    weeklyComparisonChartInstance.destroy();
                    weeklyComparisonChartInstance = null;
                }
                weeklyComparisonChartInstance = new ApexCharts(weeklyComparisonElement, weeklyComparisonOptions);
                weeklyComparisonChartInstance.render();
            } catch (error) {
                console.error('Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
                weeklyComparisonElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #f44336; font-size: 16px;">Ï∞®Ìä∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>';
            }
        }

        // Ï£ºÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ìï®Ïàò
        async function downloadWeeklyOperationExcel() {
            try {
                console.log('üì• Ï£ºÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï® ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏãúÏûë...');
                showToast('Ï∞®Ìä∏ÏôÄ ÌÖåÏù¥Î∏îÏùÑ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÌôò Ï§ëÏûÖÎãàÎã§...', 'info');
                
                const images = {};
                
                // 1. Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                const summaryTable = document.querySelector('.card:first-child');
                if (summaryTable) {
                    console.log('üìä Ï£ºÍ∞Ñ ÌÜµÍ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    const tableCanvas = await html2canvas(summaryTable, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // Ï†ÅÏ†àÌïú Ìï¥ÏÉÅÎèÑÎ°ú Ï°∞Ï†ï
                        useCORS: true,
                        allowTaint: true,
                        width: summaryTable.offsetWidth,
                        height: summaryTable.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.summaryTableImage = tableCanvas.toDataURL('image/png', 1.0);
                }
                
                // 2. Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (weeklyTrendChartInstance) {
                    console.log('üìà Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.weeklyTrendChartImage = await weeklyTrendChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('Ï£ºÍ∞Ñ Ïö¥ÏòÅ Ï∂îÏù¥ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                // 3. ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
                const counselingSection = document.querySelector('.row.g-5.g-xl-8');
                if (counselingSection) {
                    console.log('üìä ÏÉÅÎã¥Ïú†Ìòï ÌòÑÌô© ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    const counselingCanvas = await html2canvas(counselingSection, {
                        backgroundColor: '#ffffff',
                        scale: 2,  // Ï†ÅÏ†àÌïú Ìï¥ÏÉÅÎèÑÎ°ú Ï°∞Ï†ï
                        useCORS: true,
                        allowTaint: true,
                        width: counselingSection.offsetWidth,
                        height: counselingSection.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        foreignObjectRendering: true
                    });
                    images.counselingSectionImage = counselingCanvas.toDataURL('image/png', 1.0);
                }
                
                // 4. ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (counselingTypesChartInstance) {
                    console.log('üçï ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.counselingTypesChartImage = await counselingTypesChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('ÏÉÅÎã¥Ïú†Ìòï Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                // 5. Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ApexCharts - ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ)
                if (weeklyComparisonChartInstance) {
                    console.log('üìä Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...');
                    try {
                        images.weeklyComparisonChartImage = await weeklyComparisonChartInstance.dataURI({
                            type: 'png',
                            scale: 1  // ÏõêÎ≥∏ ÌÅ¨Í∏∞ ÎπÑÏú® Ïú†ÏßÄ
                        });
                    } catch (error) {
                        console.warn('Ï£ºÍ∞Ñ ÌòÑÌô© ÎπÑÍµê Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    }
                }
                
                console.log('‚úÖ Î™®Îì† Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å');
                
                // ÌååÎùºÎØ∏ÌÑ∞ Ï§ÄÎπÑ
                const selectedDates = datepicker.selectedDates;
                const startDate = formatDate(selectedDates[0]);
                const endDate = formatDate(selectedDates[1]);
                const params = {
                    startDate: startDate,
                    endDate: endDate,
                    ...images
                };
                
                // ÏÑúÎ≤ÑÎ°ú POST ÏöîÏ≤≠ (Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®)
                await downloadWeeklyExcelWithImages(params);
                
            } catch (error) {
                console.error('‚ùå Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                showToast('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Ïù¥ÎØ∏ÏßÄÎ•º Ìè¨Ìï®Ìïú Ï£ºÍ∞Ñ Ïö¥ÏòÅÌòÑÌô© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏöîÏ≤≠
        async function downloadWeeklyExcelWithImages(params) {
            try {
                showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...', 'info');
                
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                
                const response = await fetch('/stat/weekly/excel-with-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    // ÌååÏùº Îã§Ïö¥Î°úÎìú
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Ï£ºÍ∞ÑÏö¥ÏòÅÌòÑÌô©_' + params.startDate + '_' + params.endDate + '.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
                }
                
            } catch (error) {
                console.error('‚ùå ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                showToast('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;
            
            switch (type) {
                case 'success':
                    toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                default:
                    toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî ÏΩîÎìúÎäî ÏÇ≠Ï†ú (fetchWeeklyOperationData ÏÑ±Í≥µ Ïãú ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± Î∞è ÏóÖÎç∞Ïù¥Ìä∏)

    </script>
    <!--end::Javascript-->
</div>
</html> 