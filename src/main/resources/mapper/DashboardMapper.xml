<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wio.crm.mapper.DashboardMapper">
    <select id="findDataForCard1" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[


        SELECT
            nvl(count_miss,0) as count_miss,
            nvl(count_com,0) as count_com,
            nvl(count_miss+count_com,0) as count_sum,
            nvl(ROUND((count_com / NULLIF(count_miss + count_com, 0)) * 100, 2),0) AS processing_rate
        FROM (
                 SELECT
                     (SELECT COUNT(*)
                      FROM (
                               SELECT *
                               FROM CALL_LOG_D B
                                        JOIN (
                                   SELECT MAX(CALLDATE) AS CALL_DATE, CLID, CUST_CODE, PROJECT_CODE
                                   FROM CALL_LOG_D
                                   WHERE REPLACE(substr(calldate,0,10),'-') = '20240205'
                                   GROUP BY CLID, CUST_CODE, PROJECT_CODE
                               ) A ON A.CALL_DATE = B.CALLDATE AND A.CLID = B.CLID
                                        LEFT JOIN temp01 T ON T.empno = B.empno
                                        LEFT JOIN tcnt01 C ON C.CUST_CODE = B.CUST_CODE
                               WHERE REPLACE(substr(B.calldate,0,10),'-') = '20240205'
                                 AND B.RESULT <> 'ANSWER'
                                 AND B.CONFIRM = '0'
                                 AND B.context <> 'outbound'
                           )) AS count_miss,

                     (SELECT COUNT(*)
                      FROM TBND01 A
                      WHERE A.PRC_GUBN = '2'
                        AND TO_CHAR(A.IN_DATE, 'YYYYMMDD')= '20240205'
                        AND CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                     ) AS count_com
                 FROM dual
             )


        ]]>
    </select>
    <select id="findDataForCard2" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[
        SELECT
            NVL(
                    TO_CHAR(
                            CASE
                                WHEN percentChange > 100 THEN percentChange - 100
                                ELSE percentChange
                                END,
                            'FM999999990.00'
                        ),
                    '0'
                ) AS processing_rate,
            dailyPoint,
            dailyPointN
        FROM (
                 SELECT
                             (today.dailyPointN - yesterday.dailyPointN) / NULLIF(yesterday.dailyPointN, 0) * 100 AS percentChange,
                             today.dailyPoint as dailyPoint,
                             today.dailyPointN as dailyPointN
                 FROM
                     (
                         SELECT
                             NVL(TO_CHAR(SUM(point) * -1, '999,999,999,999'), '0') AS dailyPoint,
                             NVL(SUM(point) * -1, 0) AS dailyPointN
                         FROM
                             tcnt01_point
                         WHERE
                             call_code IS NOT NULL
                           AND ISSUE_DATE = '20240205' -- 오늘 날짜
                           AND CUST_CODE = DECODE(#{username}, '', CUST_CODE, #{username})
                     ) today,
                     (
                         SELECT
                             NVL(TO_CHAR(SUM(point) * -1, '999,999,999,999'), '0') AS dailyPoint,
                             NVL(SUM(point) * -1, 0) AS dailyPointN
                         FROM
                             tcnt01_point
                         WHERE
                             call_code IS NOT NULL
                           AND ISSUE_DATE = '20240210' -- 어제 날짜; 날짜가 잘못 지정되었으니 적절히 조정해야 함
                           AND CUST_CODE = DECODE(#{username}, '', CUST_CODE, #{username})
                     ) yesterday
             )
        ]]>
    </select>
    <select id="findPointList" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[



        WITH AggregatedData AS (
            SELECT
                CS_TYPE,
                count(POINT) AS TotalPoints
            FROM tcnt01_point b
                     INNER JOIN tcnt01 a ON a.cust_code = b.cust_code
                     INNER JOIN tbnd01 c ON b.cust_code = c.cust_code
                AND b.projct_code = c.project_code
                AND b.call_code = c.call_code
                AND b.person_code = c.person_code
            WHERE b.issue_date = '20240205'
              AND b.CUST_CODE = DECODE(#{username}, '', b.CUST_CODE, #{username})
            GROUP BY CS_TYPE
        ),
             RankedData AS (
                 SELECT
                     CS_TYPE,
                     TotalPoints,
                     ROW_NUMBER() OVER (ORDER BY TotalPoints DESC) AS Rank
                 FROM AggregatedData A
             ),
             FinalData AS (
                 SELECT
                     CASE
                         WHEN Rank <= 2 THEN CS_TYPE
                         ELSE '기타'
                         END AS GroupingKey,
                     SUM(TotalPoints) AS Points
                 FROM RankedData
                 GROUP BY
                     CASE
                         WHEN Rank <= 2 THEN CS_TYPE
                         ELSE '기타'
                         END
             )
        SELECT
            DECODE((SELECT ADM_SNAME FROM TSYS01 WHERE ADM_GUBN='4002' AND ADM_CODE= GroupingKey),NULL,'기타',(SELECT ADM_SNAME FROM TSYS01 WHERE ADM_GUBN='4002' AND ADM_CODE= GroupingKey)) AS CS_TYPE,
            TO_CHAR(nvl(Points,0),'999,999,999,999') as dailyPoint , nvl(Points,0) dailyPointN
        FROM FinalData
        ORDER BY
            CASE WHEN GroupingKey = '기타' THEN 1 ELSE 0 END, Points DESC
        ]]>
    </select>
    <select id="dashConSum" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[
        SELECT
            (
                SELECT
                    COUNT(*)
                FROM
                    (
                        SELECT
                            B.CALLDATE,
                            B.CLID,
                            B.PERSON_CODE,
                            B.CUST_CODE,
                            B.PROJECT_CODE,
                            B.empno,
                            B.INCALL_NO,
                            T.emp_name,
                            C.cust_name AS PJN,
                            1 AS COUNT,
          B.RESULT,
          DECODE(B.CONTEXT, 'outbound', 'OUT', 'IN') AS CONTEXT
                        FROM
                            (
                            SELECT
                            MAX(CALLDATE) AS CALL_DATE,
                            CLID,
                            CUST_CODE,
                            PROJECT_CODE
                            FROM
                            CALL_LOG_D
                            WHERE
                            REPLACE(substr(calldate, 0, 10), '-') = '20240202'
                            GROUP BY
                            CLID,
                            CUST_CODE,
                            PROJECT_CODE
                            ) A
                            INNER JOIN CALL_LOG_D B ON A.CALL_DATE = B.CALLDATE
                            AND A.CLID = B.CLID
                            LEFT JOIN temp01 T ON T.empno = B.empno
                            LEFT JOIN tcnt01 C ON C.CUST_CODE = B.CUST_CODE
                        WHERE
                            REPLACE(substr(B.calldate, 0, 10), '-') = '20240202'
                          AND B.RESULT <> 'ANSWER'
                          AND B.CONFIRM = '0'
                          AND B.context <> 'outbound'
                    )
            ) AS yesterdayMiss,
            (
                SELECT
                    COUNT(*)
                FROM
                    TBND01 a
                WHERE
                    1 = 1
                  AND A.CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                  AND A.PRC_GUBN = '2'
                  AND TO_CHAR(IN_DATE, 'YYYYMMDD') = '20240202'
            ) AS yesterdayCom,
            (
                SELECT
                    COUNT(*)
                FROM
                    TBND01 a
                WHERE
                    1 = 1
                  AND A.CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                  AND A.PRC_GUBN = '2'
                  AND EMG_GUBN = '1'
                  AND TO_CHAR(IN_DATE, 'YYYYMMDD') = '20240202'
            ) AS yseterdayEme,
            (
                SELECT
                    COUNT(*)
                FROM
                    (
                        SELECT
                            B.CALLDATE,
                            B.CLID,
                            B.PERSON_CODE,
                            B.CUST_CODE,
                            B.PROJECT_CODE,
                            B.empno,
                            B.INCALL_NO,
                            T.emp_name,
                            C.cust_name AS PJN,
                            1 AS COUNT,
          B.RESULT,
          DECODE(B.CONTEXT, 'outbound', 'OUT', 'IN') AS CONTEXT
                        FROM
                            (
                            SELECT
                            MAX(CALLDATE) AS CALL_DATE,
                            CLID,
                            CUST_CODE,
                            PROJECT_CODE
                            FROM
                            CALL_LOG_D
                            WHERE
                            REPLACE(substr(calldate, 0, 10), '-') = '20240205'
                            GROUP BY
                            CLID,
                            CUST_CODE,
                            PROJECT_CODE
                            ) A
                            INNER JOIN CALL_LOG_D B ON A.CALL_DATE = B.CALLDATE
                            AND A.CLID = B.CLID
                            LEFT JOIN temp01 T ON T.empno = B.empno
                            LEFT JOIN tcnt01 C ON C.CUST_CODE = B.CUST_CODE
                        WHERE
                            REPLACE(substr(B.calldate, 0, 10), '-') = '20240205'
                          AND B.RESULT <> 'ANSWER'
                          AND B.CONFIRM = '0'
                          AND B.context <> 'outbound'
                    )
            ) AS todayMiss,
            (
                SELECT
                    COUNT(*)
                FROM
                    TBND01 a
                WHERE
                    1 = 1
                  AND A.CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                  AND A.PRC_GUBN = '2'
                  AND TO_CHAR(IN_DATE, 'YYYYMMDD') = '20240205'
            ) AS todayCom,
            (
                SELECT
                    COUNT(*)
                FROM
                    TBND01 a
                WHERE
                    1 = 1
                  AND A.CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                  AND A.PRC_GUBN = '2'
                  AND EMG_GUBN = '1'
                  AND TO_CHAR(IN_DATE, 'YYYYMMDD') = '20240205'
            ) AS todayEme
        FROM
            dual]]>
    </select>
    <select id="dashStatCount" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[



        WITH AggregatedData AS (
            SELECT
                CS_TYPE,
                COUNT(POINT)TotalCount,
                SUM(POINT)*-1 AS TotalPoints
            FROM tcnt01_point b
                     INNER JOIN tcnt01 a ON a.cust_code = b.cust_code
                     INNER JOIN tbnd01 c ON b.cust_code = c.cust_code
                AND b.projct_code = c.project_code
                AND b.call_code = c.call_code
                AND b.person_code = c.person_code
            WHERE b.issue_date = '20240205'
              AND b.CUST_CODE = DECODE(#{username}, '', b.CUST_CODE, #{username})
            GROUP BY CS_TYPE
        ),
             RankedData AS (
                 SELECT
                     CS_TYPE,
                     TotalCount,
                     TotalPoints,
                     ROW_NUMBER() OVER (ORDER BY TotalPoints DESC) AS Rank
                 FROM AggregatedData A
             ),
             FinalData AS (
                 SELECT
                     CASE
                         WHEN Rank <= 5 THEN CS_TYPE
                         ELSE '기타'
                         END AS GroupingKey,
                     SUM(TotalCount) AS TotalCount,
                     SUM(TotalPoints) AS Points
                 FROM RankedData
                 GROUP BY
                     CASE
                         WHEN Rank <= 5 THEN CS_TYPE
                         ELSE '기타'
                         END
             )
        SELECT
            DECODE((SELECT ADM_SNAME FROM TSYS01 WHERE ADM_GUBN='4002' AND ADM_CODE= GroupingKey),NULL,'기타',(SELECT ADM_SNAME FROM TSYS01 WHERE ADM_GUBN='4002' AND ADM_CODE= GroupingKey)) AS CS_TYPE,TotalCount,
            TO_CHAR(nvl(Points,0),'999,999,999,999') as dailyPoint , nvl(Points,0) dailyPointN
        FROM FinalData
        ORDER BY
            CASE WHEN GroupingKey = '기타' THEN 1 ELSE 0 END, Points DESC



        ]]>
    </select>
    <select id="getDashboardCallCount" resultType="com.wio.crm.model.DashboardData">
        <![CDATA[
        SELECT  PRC_DATE,GUBN,HOUR_09,HOUR_10,HOUR_11,HOUR_12,HOUR_13,HOUR_14,HOUR_15,HOUR_16,HOUR_17,HOUR_18,HOUR_09+HOUR_10+HOUR_11+HOUR_12+HOUR_13+HOUR_14+HOUR_15+HOUR_16+HOUR_17+HOUR_18+HOUR_19 as callSum
          FROM (
                  SELECT TO_CHAR(IN_DATE, 'YYYYMMDD') PRC_DATE,'1' GUBN
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '09', 1, 0)) HOUR_09
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '10', 1, 0)) HOUR_10
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '11', 1, 0)) HOUR_11
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '12', 1, 0)) HOUR_12
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '13', 1, 0)) HOUR_13
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '14', 1, 0)) HOUR_14
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '15', 1, 0)) HOUR_15
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '16', 1, 0)) HOUR_16
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '17', 1, 0)) HOUR_17
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '18', 1, 0)) HOUR_18
                       , SUM(DECODE(TO_CHAR(IN_DATE, 'HH24'), '19', 1, 0)) HOUR_19
                  FROM TBND01 A
                  WHERE 1=1
                    AND PRC_GUBN IN ('1', '2')
                    AND TO_CHAR(IN_DATE, 'YYYYMMDD') = '20240205'
                  GROUP BY TO_CHAR(IN_DATE, 'YYYYMMDD')
                  UNION ALL
                  SELECT SUBSTR(REPLACE(CALLDATE,'-',''), 1,8) PRC_DATE ,'2' GUBN
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '09', 1, 0)) HOUR_09
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '10', 1, 0)) HOUR_10
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '11', 1, 0)) HOUR_11
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '12', 1, 0)) HOUR_12
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '13', 1, 0)) HOUR_13
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '14', 1, 0)) HOUR_14
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '15', 1, 0)) HOUR_15
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '16', 1, 0)) HOUR_16
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '17', 1, 0)) HOUR_17
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '18', 1, 0)) HOUR_18
                       , SUM(DECODE(SUBSTR(CALLDATE, 12,2), '19', 1, 0)) HOUR_19
                  FROM (SELECT B.CALLDATE,B.CLID,B.PERSON_CODE,B.CUST_CODE,B.PROJECT_CODE,B.empno,B.INCALL_NO ,1 COUNT,B.RESULT,B.CONTEXT
                        FROM
                            (SELECT MAX(CALLDATE)CALL_DATE ,CLID,CUST_CODE,PROJECT_CODE
                            FROM CALL_LOG_D
                            WHERE substr(calldate,0,10)= '2024-02-5'
                            GROUP BY SUBSTR(calldate,0,10) , CLID,CUST_CODE,PROJECT_CODE) A,CALL_LOG_D B
                        WHERE A.CALL_DATE = B.CALLDATE
                          AND substr(calldate,0,10) = '2024-02-5'
                          AND A.CLID = B.CLID
                          AND RESULT <>'ANSWER'   and b.context <> 'outbound'
                          AND A.CUST_CODE = DECODE(#{username}, '', A.CUST_CODE, #{username})
                        ORDER BY CALLDATE DESC) a
                  WHERE 1=1
                    AND CUST_CODE IS NOT NULL
                  GROUP BY SUBSTR(REPLACE(CALLDATE,'-',''), 1,8)
            )
        ORDER BY PRC_DATE

        ]]>
    </select>
</mapper>