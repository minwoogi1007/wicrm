<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wio.crm.mapper.ReturnItemMapper">

    <!-- Í≤∞Í≥º Îß§Ìïë -->
    <resultMap id="ReturnItemResultMap" type="com.wio.crm.model.ReturnItem">
        <id column="RETURN_ID" property="id"/>
        <result column="RETURN_TYPE_CODE" property="returnTypeCode"/>
        <result column="ORDER_DATE" property="orderDate"/>
        <result column="CS_RECEIVED_DATE" property="csReceivedDate"/>
        <result column="SITE_NAME" property="siteName"/>
        <result column="ORDER_NUMBER" property="orderNumber"/>
        <result column="REFUND_AMOUNT" property="refundAmount"/>
        <result column="CUSTOMER_NAME" property="customerName"/>
        <result column="CUSTOMER_PHONE" property="customerPhone"/>
        <result column="ORDER_ITEM_CODE" property="orderItemCode"/>
        <result column="PRODUCT_COLOR" property="productColor"/>
        <result column="PRODUCT_SIZE" property="productSize"/>
        <result column="QUANTITY" property="quantity"/>
        <result column="SHIPPING_FEE" property="shippingFee"/>
        <result column="RETURN_REASON" property="returnReason"/>
        <result column="DEFECT_DETAIL" property="defectDetail"/>
        <result column="DEFECT_PHOTO_URL" property="defectPhotoUrl"/>
        <result column="TRACKING_NUMBER" property="trackingNumber"/>
        <result column="COLLECTION_COMPLETED_DATE" property="collectionCompletedDate"/>
        <result column="LOGISTICS_CONFIRMED_DATE" property="logisticsConfirmedDate"/>
        <result column="SHIPPING_DATE" property="shippingDate"/>
        <result column="REFUND_DATE" property="refundDate"/>
        <result column="IS_COMPLETED" property="isCompleted"/>
        <result column="REMARKS" property="remarks"/>
        <result column="RETURN_STATUS_CODE" property="returnStatusCode"/>
        <result column="PROCESSOR" property="processor"/>
        <result column="CREATE_DATE" property="createDate"/>
        <result column="UPDATE_DATE" property="updateDate"/>
        <result column="CREATED_BY" property="createdBy"/>
        <result column="UPDATED_BY" property="updatedBy"/>
        <result column="PAYMENT_STATUS" property="paymentStatus"/>
        <result column="PAYMENT_ID" property="paymentId"/>
        <result column="COLLECTION_UPDATED_BY" property="collectionUpdatedBy"/>
        <result column="LOGISTICS_UPDATED_BY" property="logisticsUpdatedBy"/>
        <result column="SHIPPING_UPDATED_BY" property="shippingUpdatedBy"/>
        <result column="REFUND_UPDATED_BY" property="refundUpdatedBy"/>
        <result column="COLLECTION_UPDATED_DATE" property="collectionUpdatedDate"/>
        <result column="LOGISTICS_UPDATED_DATE" property="logisticsUpdatedDate"/>
        <result column="SHIPPING_UPDATED_DATE" property="shippingUpdatedDate"/>
        <result column="REFUND_UPDATED_DATE" property="refundUpdatedDate"/>
    </resultMap>

    <!-- Í≥µÌÜµ Ï°∞Í±¥ SQL (Ïù∏Îç±Ïä§ ÏàúÏÑú ÏµúÏ†ÅÌôî) -->
    <sql id="searchCondition">
        <where>
            <!-- üéØ Ïù∏Îç±Ïä§ Ïª¨Îüº ÏàúÏÑúÏóê Îî∞Î•∏ Ï°∞Í±¥ Î∞∞Ïπò (IDX_RETURN_ITEM_SEARCH) -->
            <!-- 1. CS_RECEIVED_DATE (Ïù∏Îç±Ïä§ Ï≤´ Î≤àÏß∏ Ïª¨Îüº) -->
            <if test="searchParams.startDate != null and searchParams.startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and searchParams.endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD')
            </if>
            
            <!-- 2. LOGISTICS_CONFIRMED_DATE (Ïù∏Îç±Ïä§ Îëê Î≤àÏß∏ Ïª¨Îüº) -->
            <if test="searchParams.logisticsStartDate != null and searchParams.logisticsStartDate != ''">
                AND LOGISTICS_CONFIRMED_DATE >= TO_DATE(#{searchParams.logisticsStartDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.logisticsEndDate != null and searchParams.logisticsEndDate != ''">
                AND LOGISTICS_CONFIRMED_DATE &lt;= TO_DATE(#{searchParams.logisticsEndDate}, 'YYYY-MM-DD')
            </if>
            
            <!-- 3. RETURN_TYPE_CODE (Ïù∏Îç±Ïä§ ÏÑ∏ Î≤àÏß∏ Ïª¨Îüº) -->
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != '' and searchParams.returnTypeCode != 'null'">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            
            <!-- 4. RETURN_STATUS_CODE (Ïù∏Îç±Ïä§ ÎÑ§ Î≤àÏß∏ Ïª¨Îüº) -->
            <if test="searchParams.returnStatusCode != null and searchParams.returnStatusCode != '' and searchParams.returnStatusCode != 'null'">
                AND RETURN_STATUS_CODE = #{searchParams.returnStatusCode}
            </if>
            
            <!-- 5. SITE_NAME (Ïù∏Îç±Ïä§ Îã§ÏÑØ Î≤àÏß∏ Ïª¨Îüº) -->
            <if test="searchParams.siteName != null and searchParams.siteName != '' and searchParams.siteName != 'null'">
                AND SITE_NAME = #{searchParams.siteName}
            </if>
            
            <!-- üéØ Î∏åÎûúÎìú ÌïÑÌÑ∞ÎßÅ Ï°∞Í±¥ (ÏÇ¨Ïù¥Ìä∏Î™Ö Í∏∞Î∞ò) -->
            <if test="searchParams.brandFilter != null and searchParams.brandFilter != '' and searchParams.brandFilter != 'null'">
                <choose>
                    <when test="searchParams.brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="searchParams.brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                    <when test="searchParams.brandFilter == 'OTHER'">
                        AND UPPER(SITE_NAME) NOT LIKE UPPER('%Î†àÎÖ∏Îßà%') 
                        AND UPPER(SITE_NAME) NOT LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
            
            <!-- üéØ Í∏∞ÌÉÄ Îì±Ìò∏ Ï°∞Í±¥Îì§ (Ïù∏Îç±Ïä§ Ïù¥ÌõÑ) -->
            <if test="searchParams.paymentStatus != null and searchParams.paymentStatus != '' and searchParams.paymentStatus != 'null'">
                AND PAYMENT_STATUS = #{searchParams.paymentStatus}
            </if>
            <if test="searchParams.processor != null and searchParams.processor != ''">
                AND PROCESSOR = #{searchParams.processor}
            </if>
            
            <!-- üéØ Í∞úÎ≥Ñ ÌïÑÎìú Í≤ÄÏÉâ Ï°∞Í±¥Îì§ (LIKE Ï°∞Í±¥) -->
            <if test="searchParams.orderNumber != null and searchParams.orderNumber != ''">
                AND ORDER_NUMBER LIKE '%' || #{searchParams.orderNumber} || '%'
            </if>
            <if test="searchParams.customerName != null and searchParams.customerName != ''">
                AND CUSTOMER_NAME LIKE '%' || #{searchParams.customerName} || '%'
            </if>
            <if test="searchParams.customerPhone != null and searchParams.customerPhone != ''">
                AND CUSTOMER_PHONE LIKE '%' || #{searchParams.customerPhone} || '%'
            </if>
            <if test="searchParams.orderItemCode != null and searchParams.orderItemCode != ''">
                AND ORDER_ITEM_CODE LIKE '%' || #{searchParams.orderItemCode} || '%'
            </if>
            
            <!-- üîç ÌÜµÌï© ÌÇ§ÏõåÎìú Í≤ÄÏÉâ (Í∞ÄÏû• ÎßàÏßÄÎßâ - Î≥ÑÎèÑ Ïù∏Îç±Ïä§ ÌôúÏö©) -->
            <if test="searchParams.keyword != null and searchParams.keyword != ''">
                AND (
                    <!-- Ïà´Ïûê Ìå®ÌÑ¥: Ï£ºÎ¨∏Î≤àÌò∏, Ï†ÑÌôîÎ≤àÌò∏Îßå Í≤ÄÏÉâ (IDX_RETURN_ITEM_KEYWORD ÌôúÏö©) -->
                    <choose>
                        <when test='searchParams.keyword.matches("^\\d+$")'>
                            UPPER(ORDER_NUMBER) LIKE UPPER(#{searchParams.keyword} || '%') OR
                            UPPER(CUSTOMER_PHONE) LIKE UPPER(#{searchParams.keyword} || '%')
                        </when>
                        <when test='searchParams.keyword.matches("^[Í∞Ä-Ìû£]+$")'>
                            <!-- ÌïúÍ∏Ä Ìå®ÌÑ¥: Í≥†Í∞ùÎ™Ö, ÏÇ¨Ïù¥Ìä∏Î™ÖÎßå Í≤ÄÏÉâ (IDX_RETURN_ITEM_KEYWORD ÌôúÏö©) -->
                            UPPER(CUSTOMER_NAME) LIKE UPPER(#{searchParams.keyword} || '%') OR
                            UPPER(SITE_NAME) LIKE UPPER(#{searchParams.keyword} || '%')
                        </when>
                        <otherwise>
                            <!-- Í∏∞ÌÉÄ Ìå®ÌÑ¥: ÏÉÅÌíàÏΩîÎìú, Ï∂îÏ†ÅÎ≤àÌò∏ Ïö∞ÏÑ† Í≤ÄÏÉâ -->
                            UPPER(ORDER_ITEM_CODE) LIKE UPPER(#{searchParams.keyword} || '%') OR
                            UPPER(TRACKING_NUMBER) LIKE UPPER(#{searchParams.keyword} || '%') OR
                            UPPER(ORDER_NUMBER) LIKE UPPER(#{searchParams.keyword} || '%') OR
                            UPPER(CUSTOMER_NAME) LIKE UPPER(#{searchParams.keyword} || '%')
                        </otherwise>
                    </choose>
                )
            </if>
            
            <!-- üéØ Ïπ¥Îìú ÌïÑÌÑ∞ÎßÅ Ï°∞Í±¥Îì§ Ï∂îÍ∞Ä (OGNL ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ± Í∞úÏÑ†) -->
            <if test="searchParams.collectionCompleted != null and 'Y'.equals(searchParams.collectionCompleted)">
                AND COLLECTION_COMPLETED_DATE IS NOT NULL
            </if>
            <if test="searchParams.collectionPending != null and 'Y'.equals(searchParams.collectionPending)">
                AND COLLECTION_COMPLETED_DATE IS NULL
            </if>
            <if test="searchParams.logisticsConfirmed != null and 'Y'.equals(searchParams.logisticsConfirmed)">
                AND LOGISTICS_CONFIRMED_DATE IS NOT NULL
            </if>
            <if test="searchParams.logisticsPending != null and 'Y'.equals(searchParams.logisticsPending)">
                AND LOGISTICS_CONFIRMED_DATE IS NULL
            </if>
            <if test="searchParams.shippingCompleted != null and 'Y'.equals(searchParams.shippingCompleted)">
                AND RETURN_TYPE_CODE IN ('EXCHANGE', 'FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
                AND SHIPPING_DATE IS NOT NULL
            </if>
            <if test="searchParams.shippingPending != null and 'Y'.equals(searchParams.shippingPending)">
                AND RETURN_TYPE_CODE IN ('EXCHANGE', 'FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
                AND SHIPPING_DATE IS NULL
            </if>
            <if test="searchParams.refundCompleted != null and 'Y'.equals(searchParams.refundCompleted)">
                AND RETURN_TYPE_CODE IN ('RETURN', 'FULL_RETURN', 'PARTIAL_RETURN')
                AND REFUND_DATE IS NOT NULL
            </if>
            <if test="searchParams.refundPending != null and 'Y'.equals(searchParams.refundPending)">
                AND RETURN_TYPE_CODE IN ('RETURN', 'FULL_RETURN', 'PARTIAL_RETURN')
                AND REFUND_DATE IS NULL
            </if>
            <if test="searchParams.paymentCompleted != null and 'Y'.equals(searchParams.paymentCompleted)">
                AND PAYMENT_STATUS = 'COMPLETED'
            </if>
            <if test="searchParams.paymentPending != null and 'Y'.equals(searchParams.paymentPending)">
                AND SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï'
            </if>
            <if test="searchParams.completed != null and 'Y'.equals(searchParams.completed)">
                AND IS_COMPLETED = 1
            </if>
            <if test="searchParams.incompleted != null and 'Y'.equals(searchParams.incompleted)">
                AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
            </if>
        </where>
    </sql>

    <!-- ÍµêÌôò/Î∞òÌíà Î™©Î°ù Ï°∞Ìöå (Oracle 11g ROW_NUMBER ÏµúÏ†ÅÌôî) -->
    <select id="selectReturnItemList" resultMap="ReturnItemResultMap">
        SELECT * FROM (
            SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) FIRST_ROWS */ 
                   ROW_NUMBER() OVER (
                       ORDER BY 
                           <choose>
                               <when test="searchParams.sortBy != null and searchParams.sortOrder != null">
                                   ${searchParams.sortBy} ${searchParams.sortOrder}
                               </when>
                               <otherwise>
                                   CASE WHEN (IS_COMPLETED IS NULL OR IS_COMPLETED = 0) THEN 0 ELSE 1 END ASC,
                                   RETURN_ID DESC
                               </otherwise>
                           </choose>
                   ) AS RN,
                   RETURN_ID,
                   RETURN_TYPE_CODE,
                   ORDER_DATE,
                   CS_RECEIVED_DATE,
                   SITE_NAME,
                   ORDER_NUMBER,
                   REFUND_AMOUNT,
                   CUSTOMER_NAME,
                   CUSTOMER_PHONE,
                   ORDER_ITEM_CODE,
                   PRODUCT_COLOR,
                   PRODUCT_SIZE,
                   QUANTITY,
                   SHIPPING_FEE,
                   RETURN_REASON,
                   DEFECT_DETAIL,
                   DEFECT_PHOTO_URL,
                   TRACKING_NUMBER,
                   COLLECTION_COMPLETED_DATE,
                   LOGISTICS_CONFIRMED_DATE,
                   SHIPPING_DATE,
                   REFUND_DATE,
                   IS_COMPLETED,
                   REMARKS,
                   RETURN_STATUS_CODE,
                   PROCESSOR,
                   CREATE_DATE,
                   UPDATE_DATE,
                   CREATED_BY,
                   UPDATED_BY,
                   PAYMENT_STATUS,
                   PAYMENT_ID,
                   COLLECTION_UPDATED_BY,
                   LOGISTICS_UPDATED_BY,
                   SHIPPING_UPDATED_BY,
                   REFUND_UPDATED_BY,
                   COLLECTION_UPDATED_DATE,
                   LOGISTICS_UPDATED_DATE,
                   SHIPPING_UPDATED_DATE,
                   REFUND_UPDATED_DATE
            FROM TB_RETURN_ITEM
            <include refid="searchCondition"/>
        )
        WHERE RN BETWEEN #{searchParams.startRow} + 1 AND #{searchParams.endRow}
    </select>

    <!-- ÍµêÌôò/Î∞òÌíà Î™©Î°ù Ï¥ù Í∞úÏàò -->
    <select id="selectReturnItemCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <include refid="searchCondition"/>
    </select>

    <!-- ÍµêÌôò/Î∞òÌíà ÏÉÅÏÑ∏ Ï°∞Ìöå -->
    <select id="selectReturnItemById" resultMap="ReturnItemResultMap">
        SELECT 
            RETURN_ID,
            RETURN_TYPE_CODE,
            ORDER_DATE,
            CS_RECEIVED_DATE,
            SITE_NAME,
            ORDER_NUMBER,
            REFUND_AMOUNT,
            CUSTOMER_NAME,
            CUSTOMER_PHONE,
            ORDER_ITEM_CODE,
            PRODUCT_COLOR,
            PRODUCT_SIZE,
            QUANTITY,
            SHIPPING_FEE,
            RETURN_REASON,
            DEFECT_DETAIL,
            DEFECT_PHOTO_URL,
            TRACKING_NUMBER,
            COLLECTION_COMPLETED_DATE,
            LOGISTICS_CONFIRMED_DATE,
            SHIPPING_DATE,
            REFUND_DATE,
            IS_COMPLETED,
            REMARKS,
            RETURN_STATUS_CODE,
            PROCESSOR,
            CREATE_DATE,
            UPDATE_DATE,
            CREATED_BY,
            UPDATED_BY,
            PAYMENT_STATUS,
            PAYMENT_ID,
            COLLECTION_UPDATED_BY,
            LOGISTICS_UPDATED_BY,
            SHIPPING_UPDATED_BY,
            REFUND_UPDATED_BY,
            COLLECTION_UPDATED_DATE,
            LOGISTICS_UPDATED_DATE,
            SHIPPING_UPDATED_DATE,
            REFUND_UPDATED_DATE
        FROM TB_RETURN_ITEM
        WHERE RETURN_ID = #{returnId}
    </select>

    <!-- ÍµêÌôò/Î∞òÌíà ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ -->
    <update id="updateReturnItemStatus">
        UPDATE TB_RETURN_ITEM
        SET RETURN_STATUS_CODE = #{returnStatusCode},
            UPDATED_BY = #{updatedBy},
            UPDATE_DATE = SYSDATE
        WHERE RETURN_ID = #{returnId}
    </update>

    <!-- ÏùºÍ¥Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ -->
    <update id="updateReturnItemStatusBatch">
        UPDATE TB_RETURN_ITEM
        SET RETURN_STATUS_CODE = #{returnStatusCode},
            UPDATED_BY = #{updatedBy},
            UPDATE_DATE = SYSDATE
        WHERE RETURN_ID IN
        <foreach collection="returnIds" item="returnId" open="(" separator="," close=")">
            #{returnId}
        </foreach>
    </update>

    <!-- ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ - ÏÉÅÌÉúÎ≥Ñ Ïπ¥Ïö¥Ìä∏ -->
    <select id="selectReturnItemStatusStats" resultType="map">
        SELECT 
            RETURN_STATUS_CODE as statusCode,
            COUNT(*) as count
        FROM TB_RETURN_ITEM
        GROUP BY RETURN_STATUS_CODE
        ORDER BY RETURN_STATUS_CODE
    </select>

    <!-- ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ - ÏõîÎ≥Ñ ÍµêÌôò/Î∞òÌíà Í±¥Ïàò -->
    <select id="selectMonthlyReturnItemStats" resultType="map">
        SELECT 
            TO_CHAR(CS_RECEIVED_DATE, 'MM') as month,
            COUNT(*) as count,
            RETURN_TYPE_CODE as returnType
        FROM TB_RETURN_ITEM
        WHERE EXTRACT(YEAR FROM CS_RECEIVED_DATE) = #{year}
        GROUP BY TO_CHAR(CS_RECEIVED_DATE, 'MM'), RETURN_TYPE_CODE
        ORDER BY month, returnType
    </select>

    <!-- ÍµêÌôò/Î∞òÌíà ÌÉÄÏûÖÎ≥Ñ ÌÜµÍ≥Ñ -->
    <select id="selectReturnItemTypeStats" resultType="map">
        SELECT 
            RETURN_TYPE_CODE as returnType,
            COUNT(*) as count,
            NVL(SUM(REFUND_AMOUNT), 0) as totalAmount
        FROM TB_RETURN_ITEM
        WHERE CS_RECEIVED_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                   AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        GROUP BY RETURN_TYPE_CODE
        ORDER BY count DESC
    </select>

    <!-- ==================== Ïπ¥Ïö¥Ìä∏ ÏøºÎ¶¨Îì§ ==================== -->
    
    <!-- Ï†ÑÏ≤¥ Í±¥Ïàò -->
    <select id="getTotalCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM
    </select>
    
    <!-- üéØ Ïò§Îäò Îì±Î°ù Í±¥Ïàò (Ïã§Ï†ú Ïò§Îäò ÎÇ†Ïßú Í∏∞Ï§Ä) -->
    <select id="getTodayRegisteredCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE TRUNC(CS_RECEIVED_DATE) = TRUNC(SYSDATE)
    </select>
    
    <!-- Ïñ¥Ï†úÍπåÏßÄ Îì±Î°ù Í±¥Ïàò -->
    <select id="getUntilYesterdayCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE CS_RECEIVED_DATE &lt; TRUNC(SYSDATE)
    </select>
    
    <!-- ÌöåÏàòÏôÑÎ£å Í±¥Ïàò -->
    <select id="getCollectionCompletedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE COLLECTION_COMPLETED_DATE IS NOT NULL
    </select>
    
    <!-- ÌöåÏàòÎØ∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getCollectionPendingCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE COLLECTION_COMPLETED_DATE IS NULL
    </select>
    
    <!-- Î¨ºÎ•òÌôïÏù∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getLogisticsConfirmedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE LOGISTICS_CONFIRMED_DATE IS NOT NULL
    </select>
    
    <!-- Î¨ºÎ•òÌôïÏù∏ÎØ∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getLogisticsPendingCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE LOGISTICS_CONFIRMED_DATE IS NULL
    </select>
    
    <!-- ÍµêÌôò Ï∂úÍ≥†ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getExchangeShippedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE RETURN_TYPE_CODE IN ('EXCHANGE', 'FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
        AND SHIPPING_DATE IS NOT NULL
    </select>
    
    <!-- ÍµêÌôò Ï∂úÍ≥†ÎØ∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getExchangeNotShippedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE RETURN_TYPE_CODE IN ('EXCHANGE', 'FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
        AND SHIPPING_DATE IS NULL
    </select>
    
    <!-- Î∞òÌíà ÌôòÎ∂àÏôÑÎ£å Í±¥Ïàò -->
    <select id="getReturnRefundedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE RETURN_TYPE_CODE IN ('RETURN', 'FULL_RETURN', 'PARTIAL_RETURN')
        AND REFUND_DATE IS NOT NULL
    </select>
    
    <!-- Î∞òÌíà ÌôòÎ∂àÎØ∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getReturnNotRefundedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE RETURN_TYPE_CODE IN ('RETURN', 'FULL_RETURN', 'PARTIAL_RETURN')
        AND REFUND_DATE IS NULL
    </select>
    
    <!-- Î∞∞ÏÜ°ÎπÑ ÏûÖÍ∏àÏôÑÎ£å Í±¥Ïàò -->
    <select id="getPaymentCompletedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE PAYMENT_STATUS = 'COMPLETED'
    </select>
    
    <!-- Î∞∞ÏÜ°ÎπÑ ÏûÖÍ∏àÎØ∏ÏôÑÎ£å Í±¥Ïàò (SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï') -->
    <select id="getPaymentPendingCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï'
    </select>
    
    <!-- ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getCompletedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE IS_COMPLETED = 1
    </select>
    
    <!-- ÎØ∏ÏôÑÎ£å Í±¥Ïàò -->
    <select id="getIncompletedCount" resultType="long">
        SELECT COUNT(*) FROM TB_RETURN_ITEM 
        WHERE IS_COMPLETED = 0 OR IS_COMPLETED IS NULL
    </select>
    
    <!-- ==================== Ïã§ÏãúÍ∞Ñ ÌÜµÍ≥Ñ ÏøºÎ¶¨Îì§ ==================== -->
    
    <!-- üéØ ÏÇ¨Ïú†Î≥Ñ ÌÜµÍ≥Ñ -->
    <select id="getReasonCounts" resultType="map">
        SELECT 
            RETURN_REASON as reason,
            COUNT(*) as count
        FROM TB_RETURN_ITEM 
        WHERE RETURN_REASON IS NOT NULL
        GROUP BY RETURN_REASON
        ORDER BY COUNT(*) DESC
    </select>
    
    <!-- üéØ ÏÇ¨Ïù¥Ìä∏Î≥Ñ ÌÜµÍ≥Ñ -->
    <select id="getSiteCounts" resultType="map">
        SELECT 
            SITE_NAME as siteName,
            COUNT(*) as count
        FROM TB_RETURN_ITEM 
        WHERE SITE_NAME IS NOT NULL
        GROUP BY SITE_NAME
        ORDER BY COUNT(*) DESC
    </select>
    
    <!-- üéØ Í∏àÏï° ÏöîÏïΩ ÌÜµÍ≥Ñ (ÌèâÍ∑†Í∏àÏï° Ï†úÍ±∞) -->
    <select id="getAmountSummary" resultType="map">
        SELECT 
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            COALESCE(MAX(REFUND_AMOUNT), 0) as maxRefundAmount,
            COALESCE(MIN(REFUND_AMOUNT), 0) as minRefundAmount,
            COALESCE(SUM(TO_NUMBER(REGEXP_REPLACE(SHIPPING_FEE, '[^0-9]', ''))), 0) as totalShippingFee
        FROM TB_RETURN_ITEM 
        WHERE REFUND_AMOUNT IS NOT NULL OR SHIPPING_FEE IS NOT NULL
    </select>
    
    <!-- üéØ Î∏åÎûúÎìúÎ≥Ñ ÌÜµÍ≥Ñ (Î∞∞ÏÜ°ÎπÑ Í≤∞Ï†ú ÌÖåÏù¥Î∏îÏóêÏÑú) -->
    <select id="getBrandCounts" resultType="map">
        SELECT 
            sp.BRAND as brand,
            COUNT(DISTINCT ri.RETURN_ID) as count
        FROM TB_RETURN_ITEM ri
        LEFT JOIN TB_SHIPPING_PAYMENT_REGISTER sp ON ri.PAYMENT_ID = sp.REGISTER_ID
        WHERE sp.BRAND IS NOT NULL
        GROUP BY sp.BRAND
        ORDER BY COUNT(DISTINCT ri.RETURN_ID) DESC
    </select>
    
    <!-- üéØ Ïú†ÌòïÎ≥Ñ ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ -->
    <select id="getTypeCounts" resultType="map">
        SELECT 
            RETURN_TYPE_CODE as returnType,
            COUNT(*) as count
        FROM TB_RETURN_ITEM 
        WHERE RETURN_TYPE_CODE IS NOT NULL
        GROUP BY RETURN_TYPE_CODE
        ORDER BY COUNT(*) DESC
    </select>
    
    <!-- ==================== ÌïÑÌÑ∞ÎßÅ Í≤ÄÏÉâ ÏøºÎ¶¨Îì§ ==================== -->
    
    <!-- üéØ ÌïÑÌÑ∞ÎßÅ Ìè¨Ìï® Í≤ÄÏÉâ Ï°∞Í±¥ Í∏∞Î∞ò Ï°∞Ìöå (Oracle ROWNUM ÌéòÏù¥Ïßï) -->
    <select id="findBySearchCriteria" resultMap="ReturnItemResultMap">
        SELECT * FROM (
            SELECT ROWNUM AS RN, T.* FROM (
                SELECT 
                    RETURN_ID,
                    RETURN_TYPE_CODE,
                    ORDER_DATE,
                    CS_RECEIVED_DATE,
                    SITE_NAME,
                    ORDER_NUMBER,
                    REFUND_AMOUNT,
                    CUSTOMER_NAME,
                    CUSTOMER_PHONE,
                    ORDER_ITEM_CODE,
                    PRODUCT_COLOR,
                    PRODUCT_SIZE,
                    QUANTITY,
                    SHIPPING_FEE,
                    RETURN_REASON,
                    DEFECT_DETAIL,
                    DEFECT_PHOTO_URL,
                    TRACKING_NUMBER,
                    COLLECTION_COMPLETED_DATE,
                    LOGISTICS_CONFIRMED_DATE,
                    SHIPPING_DATE,
                    REFUND_DATE,
                    IS_COMPLETED,
                    REMARKS,
                    RETURN_STATUS_CODE,
                    PROCESSOR,
                    CREATE_DATE,
                    UPDATE_DATE,
                    CREATED_BY,
                    UPDATED_BY,
                    PAYMENT_STATUS,
                    PAYMENT_ID,
                    COLLECTION_UPDATED_BY,
                    LOGISTICS_UPDATED_BY,
                    SHIPPING_UPDATED_BY,
                    REFUND_UPDATED_BY,
                    COLLECTION_UPDATED_DATE,
                    LOGISTICS_UPDATED_DATE,
                    SHIPPING_UPDATED_DATE,
                    REFUND_UPDATED_DATE
                FROM TB_RETURN_ITEM
                <include refid="searchCondition"/>
                ORDER BY RETURN_ID DESC
            ) T
            WHERE ROWNUM &lt;= #{searchParams.endRow}
        )
        WHERE RN >= #{searchParams.startRow}
    </select>
    
    <!-- üéØ ÌïÑÌÑ∞ÎßÅ Ìè¨Ìï® Í≤ÄÏÉâ Ï°∞Í±¥ Í∏∞Î∞ò Ï¥ù Í∞úÏàò -->
    <select id="countBySearchCriteria" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <include refid="searchCondition"/>
    </select>

    <!-- ==================== ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú Ï°∞Ìöå ÏøºÎ¶¨Îì§ ==================== -->
    
    <!-- üöÄ ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú Î©îÏù∏ Î™©Î°ù Ï°∞Ìöå (Í∏∞Ï°¥ Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_ID_DESC ÌôúÏö©) -->
    <select id="selectReturnItemListOptimized" resultMap="ReturnItemResultMap">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_ID_DESC) */ * FROM (
            SELECT ROWNUM AS RN, T.* FROM (
                SELECT 
                    RETURN_ID, RETURN_TYPE_CODE, ORDER_DATE, CS_RECEIVED_DATE,
                    SITE_NAME, ORDER_NUMBER, REFUND_AMOUNT, CUSTOMER_NAME, CUSTOMER_PHONE,
                    ORDER_ITEM_CODE, PRODUCT_COLOR, PRODUCT_SIZE, QUANTITY, SHIPPING_FEE,
                    RETURN_REASON, DEFECT_DETAIL, DEFECT_PHOTO_URL, TRACKING_NUMBER,
                    COLLECTION_COMPLETED_DATE, LOGISTICS_CONFIRMED_DATE, SHIPPING_DATE, REFUND_DATE,
                    IS_COMPLETED, REMARKS, RETURN_STATUS_CODE, PROCESSOR,
                    CREATE_DATE, UPDATE_DATE, CREATED_BY, UPDATED_BY,
                    PAYMENT_STATUS, PAYMENT_ID,
                    COLLECTION_UPDATED_BY, LOGISTICS_UPDATED_BY, SHIPPING_UPDATED_BY, REFUND_UPDATED_BY,
                    COLLECTION_UPDATED_DATE, LOGISTICS_UPDATED_DATE, SHIPPING_UPDATED_DATE, REFUND_UPDATED_DATE
                FROM TB_RETURN_ITEM
                ]]>
                <include refid="optimizedSearchCondition"/>
                ORDER BY CASE WHEN (IS_COMPLETED IS NULL OR IS_COMPLETED = 0) THEN 0 ELSE 1 END ASC, RETURN_ID DESC
            ) T
            WHERE ROWNUM &lt;= #{searchParams.endRow}
        )
        WHERE RN > #{searchParams.startRow}
    </select>

    <!-- üöÄ ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú Í≤ÄÏÉâ Ï°∞Í±¥ (Ïù∏Îç±Ïä§ ÌûåÌä∏ Ìè¨Ìï®) -->
    <sql id="optimizedSearchCondition">
        <where>
            <!-- üîç ÌÜµÌï© ÌÇ§ÏõåÎìú Í≤ÄÏÉâ (Í∞ÄÏû• Ï§ëÏöîÌïú Í≤ÄÏÉâ Ï°∞Í±¥) -->
            <if test="searchParams.keyword != null and searchParams.keyword != ''">
                AND (
                    UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(SITE_NAME) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(ORDER_ITEM_CODE) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(PRODUCT_COLOR) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(PRODUCT_SIZE) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(TRACKING_NUMBER) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(RETURN_REASON) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(PROCESSOR) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(REMARKS) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Y' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
                )
            </if>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.returnStatusCode != null and searchParams.returnStatusCode != ''">
                AND RETURN_STATUS_CODE = #{searchParams.returnStatusCode}
            </if>
            <if test="searchParams.paymentStatus != null and searchParams.paymentStatus != ''">
                AND PAYMENT_STATUS = #{searchParams.paymentStatus}
            </if>
            <if test="searchParams.startDate != null and searchParams.endDate != null">
                AND CS_RECEIVED_DATE BETWEEN TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD') 
                                         AND TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.startDate != null and (searchParams.endDate == null or searchParams.endDate == '')">
                AND CS_RECEIVED_DATE &gt;= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and (searchParams.startDate == null or searchParams.startDate == '')">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <!-- Î¨ºÎ•òÌôïÏù∏Ïùº Í≤ÄÏÉâ Ï°∞Í±¥ -->
            <if test="searchParams.logisticsStartDate != null and searchParams.logisticsEndDate != null">
                AND LOGISTICS_CONFIRMED_DATE BETWEEN TO_DATE(#{searchParams.logisticsStartDate}, 'YYYY-MM-DD') 
                                                 AND TO_DATE(#{searchParams.logisticsEndDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.logisticsStartDate != null and (searchParams.logisticsEndDate == null or searchParams.logisticsEndDate == '')">
                AND LOGISTICS_CONFIRMED_DATE &gt;= TO_DATE(#{searchParams.logisticsStartDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.logisticsEndDate != null and (searchParams.logisticsStartDate == null or searchParams.logisticsStartDate == '')">
                AND LOGISTICS_CONFIRMED_DATE &lt;= TO_DATE(#{searchParams.logisticsEndDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <!-- Í≥†Í∞ùÎ™Ö Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_CUSTOMER ÌôúÏö©) -->
            <if test="searchParams.customerName != null and searchParams.customerName != ''">
                AND CUSTOMER_NAME LIKE #{searchParams.customerName} || '%'
            </if>
            <!-- Ï†ÑÌôîÎ≤àÌò∏ Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_PHONE ÌôúÏö©) -->
            <if test="searchParams.customerPhone != null and searchParams.customerPhone != ''">
                AND CUSTOMER_PHONE LIKE #{searchParams.customerPhone} || '%'
            </if>
            <!-- Ï£ºÎ¨∏Î≤àÌò∏ Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_ORDER_NUM ÌôúÏö©) -->
            <if test="searchParams.orderNumber != null and searchParams.orderNumber != ''">
                AND ORDER_NUMBER LIKE #{searchParams.orderNumber} || '%'
            </if>
            <!-- ÌíàÎ≤à Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_ITEM_CODE ÌôúÏö©) -->
            <if test="searchParams.orderItemCode != null and searchParams.orderItemCode != ''">
                AND ORDER_ITEM_CODE LIKE #{searchParams.orderItemCode} || '%'
            </if>
            <!-- Ïö¥ÏÜ°Ïû•Î≤àÌò∏ Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_TRACKING ÌôúÏö©) -->
            <if test="searchParams.trackingNumber != null and searchParams.trackingNumber != ''">
                AND TRACKING_NUMBER LIKE #{searchParams.trackingNumber} || '%'
            </if>
            <!-- ÏÇ¨Ïù¥Ìä∏Î™Ö Í≤ÄÏÉâ (Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_SITE ÌôúÏö©) -->
            <if test="searchParams.siteName != null and searchParams.siteName != ''">
                AND SITE_NAME = #{searchParams.siteName}
            </if>
            <!-- ÎØ∏ÏôÑÎ£å ÌïÑÌÑ∞ (Oracle Boolean Ï≤òÎ¶¨) -->
            <if test="searchParams.incompleted != null and searchParams.incompleted == 'Y'">
                AND (IS_COMPLETED IS NULL OR IS_COMPLETED = 0)
            </if>
            <!-- ÏôÑÎ£å ÌïÑÌÑ∞ (Oracle Boolean Ï≤òÎ¶¨) -->
            <if test="searchParams.completed != null and searchParams.completed == 'Y'">
                AND IS_COMPLETED = 1
            </if>
        </where>
    </sql>

    <!-- üöÄ ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú COUNT ÏøºÎ¶¨ (Ïù∏Îç±Ïä§ ÌôúÏö©) -->
    <select id="selectReturnItemCountOptimized" resultType="long">
        SELECT /*+ INDEX_COMBINE(TB_RETURN_ITEM) */ COUNT(*)
        FROM TB_RETURN_ITEM
        <include refid="optimizedSearchCondition"/>
    </select>

    <!-- üìà Ìä∏Î†åÎìú Ï∞®Ìä∏Ïö© Í≤ΩÎüâ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (ÏÑ±Îä• ÏµúÏ†ÅÌôî) -->
    <select id="selectReturnItemListForTrend" resultType="map">
        <![CDATA[
        SELECT /*+ INDEX_FAST_FULL_SCAN(TB_RETURN_ITEM IDX_RETURN_ITEM_CS_DATE) FIRST_ROWS */ 
            CS_RECEIVED_DATE as csReceivedDate, 
            RETURN_TYPE_CODE as returnTypeCode,
            RETURN_ID as returnId
        FROM TB_RETURN_ITEM
        ]]>
        <where>
            CS_RECEIVED_DATE IS NOT NULL
            
            <!-- üî• FIX: @Param("searchParams") ÌååÎùºÎØ∏ÌÑ∞ Ï†ëÍ∑º -->
            <if test="searchParams.startDate != null and searchParams.endDate != null">
                AND TO_CHAR(CS_RECEIVED_DATE, 'YYYY-MM-DD') BETWEEN #{searchParams.startDate} AND #{searchParams.endDate}
            </if>
            <if test="searchParams.startDate != null and (searchParams.endDate == null or searchParams.endDate == '')">
                AND CS_RECEIVED_DATE &gt;= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and (searchParams.startDate == null or searchParams.startDate == '')">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.returnStatusCode != null and searchParams.returnStatusCode != ''">
                AND RETURN_STATUS_CODE = #{searchParams.returnStatusCode}
            </if>
            <if test="searchParams.paymentStatus != null and searchParams.paymentStatus != ''">
                AND PAYMENT_STATUS = #{searchParams.paymentStatus}
            </if>
            <if test="searchParams.siteName != null and searchParams.siteName != ''">
                AND SITE_NAME = #{searchParams.siteName}
            </if>
            <if test="searchParams.keyword != null and searchParams.keyword != ''">
                AND (
                    UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Y' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
                )
            </if>
        </where>
        ORDER BY CS_RECEIVED_DATE DESC
    </select>

    <sql id="trendSearchCondition">
        <where>
            CS_RECEIVED_DATE IS NOT NULL
            
            <if test="searchParams.startDate != null and searchParams.endDate != null">
                AND CS_RECEIVED_DATE BETWEEN TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD') 
                                         AND TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.startDate != null and (searchParams.endDate == null or searchParams.endDate == '')">
                AND CS_RECEIVED_DATE &gt;= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and (searchParams.startDate == null or searchParams.startDate == '')">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.returnStatusCode != null and searchParams.returnStatusCode != ''">
                AND RETURN_STATUS_CODE = #{searchParams.returnStatusCode}
            </if>
            <if test="searchParams.paymentStatus != null and searchParams.paymentStatus != ''">
                AND PAYMENT_STATUS = #{searchParams.paymentStatus}
            </if>
            <if test="searchParams.siteName != null and searchParams.siteName != ''">
                AND SITE_NAME = #{searchParams.siteName}
            </if>
            <if test="searchParams.keyword != null and searchParams.keyword != ''">
                AND (
                    UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{searchParams.keyword} || '%') OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'Y' AND IS_COMPLETED = 1) OR
                    (UPPER(TRIM(#{searchParams.keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
                )
            </if>
        </where>
    </sql>

    <!-- üöÄ ÎåÄÏãúÎ≥¥ÎìúÏö© Í≤ÄÏÉâ Ï°∞Í±¥ (ÌéòÏù¥Ïßï Ï†úÏô∏) -->
    <sql id="dashboardSearchCondition">
        <where>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.returnStatusCode != null and searchParams.returnStatusCode != ''">
                AND RETURN_STATUS_CODE = #{searchParams.returnStatusCode}
            </if>
            <if test="searchParams.paymentStatus != null and searchParams.paymentStatus != ''">
                AND PAYMENT_STATUS = #{searchParams.paymentStatus}
            </if>
            <if test="searchParams.startDate != null and searchParams.endDate != null">
                AND CS_RECEIVED_DATE BETWEEN TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD') 
                                         AND TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.siteName != null and searchParams.siteName != ''">
                AND SITE_NAME = #{searchParams.siteName}
            </if>
            <if test="searchParams.keyword != null and searchParams.keyword != ''">
                AND (CUSTOMER_NAME LIKE #{searchParams.keyword} || '%' 
                     OR CUSTOMER_PHONE LIKE #{searchParams.keyword} || '%'
                     OR ORDER_NUMBER LIKE #{searchParams.keyword} || '%'
                     OR ORDER_ITEM_CODE LIKE #{searchParams.keyword} || '%'
                     OR TRACKING_NUMBER LIKE #{searchParams.keyword} || '%'
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1)
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1)
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1)
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'Y' AND IS_COMPLETED = 1)
                     OR (UPPER(TRIM(#{searchParams.keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)))
            </if>
        </where>
    </sql>

    <!-- üöÄ [ÏÑ±Îä• ÏµúÏ†ÅÌôî] ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú ÌÜµÍ≥Ñ ÏøºÎ¶¨ (Í∏∞Ï°¥ 12Í∞ú ÏøºÎ¶¨ ‚Üí 1Í∞ú ÏøºÎ¶¨) -->
    <select id="getDashboardStatsUnified" resultType="map">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_COMPOSITE) ALL_ROWS */
            -- üìä Ï†ÑÏ≤¥ Í∏∞Î≥∏ ÌÜµÍ≥Ñ
            COUNT(*) as totalCount,
            COUNT(CASE WHEN TRUNC(CS_RECEIVED_DATE) = TRUNC(SYSDATE) THEN 1 END) as todayCount,
            
            -- üì¶ ÌöåÏàò Í¥ÄÎ†® ÌÜµÍ≥Ñ (Ï†ÑÏ≤¥ÏôÑÎ£å Ï†úÏô∏)
            COUNT(CASE WHEN COLLECTION_COMPLETED_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as COLLECTIONCOMPLETEDCOUNT,
            COUNT(CASE WHEN COLLECTION_COMPLETED_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as COLLECTIONPENDINGCOUNT,
            
            -- üöõ Î¨ºÎ•ò Í¥ÄÎ†® ÌÜµÍ≥Ñ (Ï†ÑÏ≤¥ÏôÑÎ£å Ï†úÏô∏)
            COUNT(CASE WHEN LOGISTICS_CONFIRMED_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as LOGISTICSCONFIRMEDCOUNT,
            COUNT(CASE WHEN LOGISTICS_CONFIRMED_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as LOGISTICSPENDINGCOUNT,
            
            -- üì§ ÍµêÌôò Ï∂úÍ≥† Í¥ÄÎ†® ÌÜµÍ≥Ñ (Ï†ÑÏ≤¥ÏôÑÎ£å Ï†úÏô∏, ÍµêÌôòÍ±¥Îßå)
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE') 
                       AND SHIPPING_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as EXCHANGESHIPPEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE') 
                       AND SHIPPING_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as EXCHANGENOTSHIPPEDCOUNT,
            
            -- üí∞ Î∞òÌíà ÌôòÎ∂à Í¥ÄÎ†® ÌÜµÍ≥Ñ (Ï†ÑÏ≤¥ÏôÑÎ£å Ï†úÏô∏, Î∞òÌíàÍ±¥Îßå)
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') 
                       AND REFUND_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as RETURNREFUNDEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') 
                       AND REFUND_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as RETURNNOTREFUNDEDCOUNT,
            
            -- üí≥ Î∞∞ÏÜ°ÎπÑ ÏûÖÍ∏à Í¥ÄÎ†® ÌÜµÍ≥Ñ (Ï†ÑÏ≤¥ÏôÑÎ£å Ï†úÏô∏, Î™®Îì† ÍµêÌôò/Î∞òÌíà)
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE', 'FULL_RETURN', 'PARTIAL_RETURN') 
                       AND PAYMENT_STATUS = 'COMPLETED' 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as PAYMENTCOMPLETEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE', 'FULL_RETURN', 'PARTIAL_RETURN') 
                       AND (PAYMENT_STATUS = 'PENDING' OR SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï') 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as PAYMENTPENDINGCOUNT,
            
            -- ‚úÖ ÏôÑÎ£å ÏÉÅÌÉú ÌÜµÍ≥Ñ (Oracle Boolean Ï≤òÎ¶¨)
            COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) as COMPLETEDCOUNT,
            COUNT(CASE WHEN IS_COMPLETED IS NULL OR IS_COMPLETED = 0 THEN 1 END) as INCOMPLETEDCOUNT,
            
            -- üìà Ï∂îÍ∞Ä Î∂ÑÏÑù ÌÜµÍ≥Ñ
            COUNT(CASE WHEN (IS_COMPLETED IS NULL OR IS_COMPLETED = 0) 
                       AND CS_RECEIVED_DATE <= SYSDATE - 7 THEN 1 END) as delayedCount,
            -- üö® Ï≤òÎ¶¨Í∏∞Í∞Ñ ÏûÑÎ∞ï ÌÜµÍ≥Ñ (10Ïùº Ïù¥ÏÉÅ ÎØ∏ÏôÑÎ£å)
            COUNT(CASE WHEN (IS_COMPLETED IS NULL OR IS_COMPLETED = 0) 
                       AND CS_RECEIVED_DATE <= SYSDATE - 10 THEN 1 END) as OVERDUETENDAYSCOUNT,
            
            -- üí∞ Í∏àÏï° ÌÜµÍ≥Ñ (NULL Ï≤òÎ¶¨ Ìè¨Ìï®)
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            COALESCE(ROUND(AVG(REFUND_AMOUNT), 0), 0) as avgRefundAmount,
            
            -- üè∑Ô∏è Ïú†ÌòïÎ≥Ñ ÌÜµÍ≥Ñ
            COUNT(CASE WHEN RETURN_TYPE_CODE = 'FULL_EXCHANGE' THEN 1 END) as fullExchangeCount,
            COUNT(CASE WHEN RETURN_TYPE_CODE = 'PARTIAL_EXCHANGE' THEN 1 END) as partialExchangeCount,
            COUNT(CASE WHEN RETURN_TYPE_CODE = 'FULL_RETURN' THEN 1 END) as fullReturnCount,
            COUNT(CASE WHEN RETURN_TYPE_CODE = 'PARTIAL_RETURN' THEN 1 END) as partialReturnCount,
            
            -- üåê Î∏åÎûúÎìúÎ≥Ñ ÌÜµÍ≥Ñ (CASE WHENÏúºÎ°ú ÏµúÏ†ÅÌôî)
            COUNT(CASE WHEN UPPER(SITE_NAME) LIKE '%Î†àÎÖ∏Îßà%' THEN 1 END) as renomaCount,
            COUNT(CASE WHEN UPPER(SITE_NAME) LIKE '%ÏΩîÎûÑÎ¶¨ÌÅ¨%' THEN 1 END) as coralicCount
            
        FROM TB_RETURN_ITEM
        ]]>
        <if test="searchParams != null">
            <include refid="dashboardSearchCondition"/>
        </if>
    </select>

    <!-- üöÄ Í≤ÄÏÉâ Ï°∞Í±¥Î≥Ñ ÌÜµÌï© ÌÜµÍ≥Ñ ÏøºÎ¶¨ (Í≤ÄÏÉâ Ïãú ÏÇ¨Ïö©) -->
    <select id="getDashboardStatsBySearch" resultType="map">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) ALL_ROWS */
            COUNT(*) as totalCount,
            COUNT(CASE WHEN TRUNC(CS_RECEIVED_DATE) = TRUNC(SYSDATE) THEN 1 END) as todayCount,
            COUNT(CASE WHEN COLLECTION_COMPLETED_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as COLLECTIONCOMPLETEDCOUNT,
            COUNT(CASE WHEN COLLECTION_COMPLETED_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as COLLECTIONPENDINGCOUNT,
            COUNT(CASE WHEN LOGISTICS_CONFIRMED_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as LOGISTICSCONFIRMEDCOUNT,
            COUNT(CASE WHEN LOGISTICS_CONFIRMED_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as LOGISTICSPENDINGCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE') 
                       AND SHIPPING_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as EXCHANGESHIPPEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE') 
                       AND SHIPPING_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as EXCHANGENOTSHIPPEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') 
                       AND REFUND_DATE IS NOT NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as RETURNREFUNDEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') 
                       AND REFUND_DATE IS NULL 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as RETURNNOTREFUNDEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE', 'FULL_RETURN', 'PARTIAL_RETURN') 
                       AND PAYMENT_STATUS = 'COMPLETED' 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as PAYMENTCOMPLETEDCOUNT,
            COUNT(CASE WHEN RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE', 'EXCHANGE', 'FULL_RETURN', 'PARTIAL_RETURN') 
                       AND (PAYMENT_STATUS = 'PENDING' OR SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï') 
                       AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL) THEN 1 END) as PAYMENTPENDINGCOUNT,
            COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) as COMPLETEDCOUNT,
            COUNT(CASE WHEN IS_COMPLETED IS NULL OR IS_COMPLETED = 0 THEN 1 END) as INCOMPLETEDCOUNT,
            -- üö® Ï≤òÎ¶¨Í∏∞Í∞Ñ ÏûÑÎ∞ï ÌÜµÍ≥Ñ (10Ïùº Ïù¥ÏÉÅ ÎØ∏ÏôÑÎ£å)
            COUNT(CASE WHEN (IS_COMPLETED IS NULL OR IS_COMPLETED = 0) 
                       AND CS_RECEIVED_DATE <= SYSDATE - 10 THEN 1 END) as OVERDUETENDAYSCOUNT,
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            COALESCE(ROUND(AVG(REFUND_AMOUNT), 0), 0) as avgRefundAmount
        FROM TB_RETURN_ITEM
        ]]>
        <include refid="searchCondition"/>
    </select>

    <!-- üöÄ ÏÉÅÌÉúÎ≥Ñ Ï°∞Ìöå ÏµúÏ†ÅÌôî (Î≥µÌï© Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_STATUS_DATE ÌôúÏö©) -->
    <select id="selectByStatusOptimized" resultMap="ReturnItemResultMap">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_STATUS_DATE) */ * FROM (
            SELECT ROWNUM AS RN, T.* FROM (
                SELECT * FROM TB_RETURN_ITEM
                WHERE RETURN_STATUS_CODE = #{status}
        ]]>
                <if test="startDate != null and endDate != null">
                    AND CS_RECEIVED_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                             AND TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
                </if>
                ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC
            ) T
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RN > #{startRow}
    </select>

    <!-- üöÄ ÌÉÄÏûÖÎ≥Ñ Ï°∞Ìöå ÏµúÏ†ÅÌôî (Î≥µÌï© Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_TYPE_DATE ÌôúÏö©) -->
    <select id="selectByTypeOptimized" resultMap="ReturnItemResultMap">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_TYPE_DATE) */ * FROM (
            SELECT ROWNUM AS RN, T.* FROM (
                SELECT * FROM TB_RETURN_ITEM
                WHERE RETURN_TYPE_CODE = #{type}
        ]]>
                <if test="startDate != null and endDate != null">
                    AND CS_RECEIVED_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                             AND TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
                </if>
                ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC
            ) T
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RN > #{startRow}
    </select>

    <!-- üöÄ Ï≤òÎ¶¨ ÏßÄÏó∞ Í±¥ Ï°∞Ìöå (14Ïùº Ïù¥ÏÉÅ ÎØ∏ÏôÑÎ£å) -->
    <select id="selectDelayedItems" resultMap="ReturnItemResultMap">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_CS_DATE) */ * FROM (
            SELECT ROWNUM AS RN, T.* FROM (
                SELECT * FROM TB_RETURN_ITEM
                WHERE (IS_COMPLETED IS NULL OR IS_COMPLETED = 0)
                AND CS_RECEIVED_DATE <= SYSDATE - 14
                ORDER BY CS_RECEIVED_DATE ASC, RETURN_ID DESC
            ) T
            WHERE ROWNUM <= #{endRow}
        )
        WHERE RN > #{startRow}
        ]]>
    </select>

    <!-- üöÄ Í≥†Í∞ùÏ†ïÎ≥¥ Í∏∞Î∞ò ÏûêÎèô Îß§Ìïë Ï°∞Ìöå (Î≥µÌï© Ïù∏Îç±Ïä§ IDX_RETURN_ITEM_CUSTOMER_PAY ÌôúÏö©) -->
    <select id="selectByCustomerForMapping" resultMap="ReturnItemResultMap">
        <![CDATA[
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_CUSTOMER_PAY) */ 
            RETURN_ID, CUSTOMER_NAME, CUSTOMER_PHONE, REFUND_AMOUNT, SHIPPING_FEE,
            RETURN_TYPE_CODE, PAYMENT_STATUS, CS_RECEIVED_DATE
        FROM TB_RETURN_ITEM
        WHERE CUSTOMER_NAME = #{customerName}
        AND PAYMENT_STATUS = 'PENDING'
        ORDER BY CS_RECEIVED_DATE DESC
        ]]>
    </select>
    
    <!-- üéØ ÌÜµÍ≥Ñ APIÏö© Í∞úÎ≥Ñ Ïπ¥Ïö¥Ìä∏ ÏøºÎ¶¨Îì§ -->
    
    <!-- ÌöåÏàòÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getCollectionCompletedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            COLLECTION_COMPLETED_DATE IS NOT NULL
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Î¨ºÎ•òÌôïÏù∏ Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getLogisticsConfirmedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            LOGISTICS_CONFIRMED_DATE IS NOT NULL
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- ÍµêÌôò Ï∂úÍ≥†ÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getExchangeShippedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
            AND SHIPPING_DATE IS NOT NULL
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Î∞òÌíà ÌôòÎ∂àÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getReturnRefundedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN')
            AND REFUND_DATE IS NOT NULL
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Î∞∞ÏÜ°ÎπÑ ÏûÖÍ∏àÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getPaymentCompletedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            PAYMENT_STATUS = 'COMPLETED'
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Ï†ÑÏ≤¥ÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) - IS_COMPLETED = 1 -->
    <select id="getCompletedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            IS_COMPLETED = 1
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- Ï†ÑÏ≤¥ÎØ∏ÏôÑÎ£å Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) - IS_COMPLETED = 0 OR NULL -->
    <select id="getIncompletedCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Ï†ÑÏ≤¥ Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getTotalCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            1=1
            <if test="startDate != null and startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="returnTypeCode != null and returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{returnTypeCode}
            </if>
            <if test="brandFilter != null and brandFilter != ''">
                <choose>
                    <when test="brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- ÍµêÌôò Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getExchangeCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
            <include refid="searchCondition"/>
        </where>
    </select>
    
    <!-- Î∞òÌíà Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getReturnCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN')
            <include refid="searchCondition"/>
        </where>
    </select>
    
    <!-- Î∞∞ÏÜ°ÎπÑ ÌïÑÏöî Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getPaymentRequiredCountBySearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE')
            <include refid="searchCondition"/>
        </where>
    </select>
    
    <!-- Ïú†ÌòïÎ≥Ñ Í±¥Ïàò (Í≤ÄÏÉâ Ï°∞Í±¥ Ï†ÅÏö©) -->
    <select id="getCountByTypeAndSearch" resultType="long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <where>
            RETURN_TYPE_CODE = #{returnType}
            <if test="searchParams.startDate != null and searchParams.startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and searchParams.endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.brandFilter != null and searchParams.brandFilter != ''">
                <choose>
                    <when test="searchParams.brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="searchParams.brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
    
    <!-- Í≤ÄÏÉâ Ï°∞Í±¥Ïóê ÎßûÎäî Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ (ÌéòÏù¥Ïßï ÏóÜÏù¥) -->
    <select id="findBySearch" resultMap="ReturnItemResultMap">
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) FIRST_ROWS */
            RETURN_ID,
            RETURN_TYPE_CODE,
            ORDER_DATE,
            CS_RECEIVED_DATE,
            SITE_NAME,
            ORDER_NUMBER,
            REFUND_AMOUNT,
            CUSTOMER_NAME,
            CUSTOMER_PHONE,
            ORDER_ITEM_CODE,
            PRODUCT_COLOR,
            PRODUCT_SIZE,
            QUANTITY,
            SHIPPING_FEE,
            RETURN_REASON,
            DEFECT_DETAIL,
            DEFECT_PHOTO_URL,
            TRACKING_NUMBER,
            COLLECTION_COMPLETED_DATE,
            LOGISTICS_CONFIRMED_DATE,
            SHIPPING_DATE,
            REFUND_DATE,
            IS_COMPLETED,
            REMARKS,
            RETURN_STATUS_CODE,
            PROCESSOR,
            CREATE_DATE,
            UPDATE_DATE,
            CREATED_BY,
            UPDATED_BY,
            PAYMENT_STATUS,
            PAYMENT_ID,
            COLLECTION_UPDATED_BY,
            LOGISTICS_UPDATED_BY,
            SHIPPING_UPDATED_BY,
            REFUND_UPDATED_BY,
            COLLECTION_UPDATED_DATE,
            LOGISTICS_UPDATED_DATE,
            SHIPPING_UPDATED_DATE,
            REFUND_UPDATED_DATE
        FROM TB_RETURN_ITEM
        <include refid="searchCondition"/>
        ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC
    </select>
    
    <!-- ÌéòÏù¥Ïßï ÏóÜÎäî Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ -->
    <select id="findAllItems" resultMap="ReturnItemResultMap">
        SELECT 
            RETURN_ID,
            RETURN_TYPE_CODE,
            ORDER_DATE,
            CS_RECEIVED_DATE,
            SITE_NAME,
            ORDER_NUMBER,
            REFUND_AMOUNT,
            CUSTOMER_NAME,
            CUSTOMER_PHONE,
            ORDER_ITEM_CODE,
            PRODUCT_COLOR,
            PRODUCT_SIZE,
            QUANTITY,
            SHIPPING_FEE,
            RETURN_REASON,
            DEFECT_DETAIL,
            DEFECT_PHOTO_URL,
            TRACKING_NUMBER,
            COLLECTION_COMPLETED_DATE,
            LOGISTICS_CONFIRMED_DATE,
            SHIPPING_DATE,
            REFUND_DATE,
            IS_COMPLETED,
            REMARKS,
            RETURN_STATUS_CODE,
            PROCESSOR,
            CREATE_DATE,
            UPDATE_DATE,
            CREATED_BY,
            UPDATED_BY,
            PAYMENT_STATUS,
            PAYMENT_ID,
            COLLECTION_UPDATED_BY,
            LOGISTICS_UPDATED_BY,
            SHIPPING_UPDATED_BY,
            REFUND_UPDATED_BY,
            COLLECTION_UPDATED_DATE,
            LOGISTICS_UPDATED_DATE,
            SHIPPING_UPDATED_DATE,
            REFUND_UPDATED_DATE
        FROM TB_RETURN_ITEM
        ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC
    </select>
    
    <!-- üí∞ Í≤ÄÏÉâ Ï°∞Í±¥ Í∏∞Î∞ò Í∏àÏï° ÌÜµÍ≥Ñ (DB ÏßÅÏ†ë ÏßëÍ≥Ñ) -->
    <select id="getAmountStatsBySearch" resultType="java.util.HashMap">
        SELECT 
            COUNT(*) AS TOTAL_COUNT,
            NVL(SUM(CASE WHEN REFUND_AMOUNT > 0 THEN REFUND_AMOUNT ELSE 0 END), 0) AS TOTAL_REFUND_AMOUNT,
            COUNT(CASE WHEN REFUND_AMOUNT > 0 THEN 1 END) AS REFUND_COUNT,
            NVL(SUM(
                CASE 
                    WHEN SHIPPING_FEE IS NOT NULL 
                         AND REGEXP_LIKE(SHIPPING_FEE, '^[0-9]+$') 
                         AND TO_NUMBER(SHIPPING_FEE) > 0 
                    THEN TO_NUMBER(SHIPPING_FEE) 
                    ELSE 0 
                END
            ), 0) AS TOTAL_SHIPPING_FEE
        FROM TB_RETURN_ITEM
        <where>
            1=1
            <if test="searchParams.startDate != null and searchParams.startDate != ''">
                AND CS_RECEIVED_DATE >= TO_DATE(#{searchParams.startDate}, 'YYYY-MM-DD')
            </if>
            <if test="searchParams.endDate != null and searchParams.endDate != ''">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{searchParams.endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="searchParams.returnTypeCode != null and searchParams.returnTypeCode != ''">
                AND RETURN_TYPE_CODE = #{searchParams.returnTypeCode}
            </if>
            <if test="searchParams.brandFilter != null and searchParams.brandFilter != ''">
                <choose>
                    <when test="searchParams.brandFilter == 'RENOMA'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%Î†àÎÖ∏Îßà%')
                    </when>
                    <when test="searchParams.brandFilter == 'CORALIC'">
                        AND UPPER(SITE_NAME) LIKE UPPER('%ÏΩîÎûÑÎ¶¨ÌÅ¨%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- üéØ Îã§Ï§ë ÌïÑÌÑ∞ ÌÜµÌï© Ï°∞Ìöå ÏµúÏ†ÅÌôî (DB Î†àÎ≤®) -->
    <select id="findByMultipleFiltersOptimized" resultMap="ReturnItemResultMap">
        SELECT * FROM (
            SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) FIRST_ROWS */
                RETURN_ID,
                RETURN_TYPE_CODE,
                ORDER_DATE,
                CS_RECEIVED_DATE,
                SITE_NAME,
                ORDER_NUMBER,
                REFUND_AMOUNT,
                CUSTOMER_NAME,
                CUSTOMER_PHONE,
                ORDER_ITEM_CODE,
                PRODUCT_COLOR,
                PRODUCT_SIZE,
                QUANTITY,
                SHIPPING_FEE,
                RETURN_REASON,
                DEFECT_DETAIL,
                DEFECT_PHOTO_URL,
                TRACKING_NUMBER,
                COLLECTION_COMPLETED_DATE,
                LOGISTICS_CONFIRMED_DATE,
                SHIPPING_DATE,
                REFUND_DATE,
                IS_COMPLETED,
                REMARKS,
                RETURN_STATUS_CODE,
                PROCESSOR,
                CREATE_DATE,
                UPDATE_DATE,
                CREATED_BY,
                UPDATED_BY,
                PAYMENT_STATUS,
                PAYMENT_ID,
                COLLECTION_UPDATED_BY,
                LOGISTICS_UPDATED_BY,
                SHIPPING_UPDATED_BY,
                REFUND_UPDATED_BY,
                COLLECTION_UPDATED_DATE,
                LOGISTICS_UPDATED_DATE,
                SHIPPING_UPDATED_DATE,
                REFUND_UPDATED_DATE,
                ROW_NUMBER() OVER (ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC) AS RN
            FROM TB_RETURN_ITEM
            WHERE 1=1
            <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå ÎØ∏ÏôÑÎ£å Ï°∞Í±¥ Ï†ÅÏö© -->
            <if test="filters == null or filters.size == 0 or !filters.contains('completed')">
                AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
            </if>
            <if test="filters != null and filters.size > 0">
                <foreach collection="filters" item="filter">
                    <choose>
                        <when test="filter == 'collection-completed'">
                            AND (COLLECTION_COMPLETED_DATE IS NOT NULL)
                        </when>
                        <when test="filter == 'collection-pending'">
                            AND (COLLECTION_COMPLETED_DATE IS NULL)
                        </when>
                        <when test="filter == 'logistics-confirmed'">
                            AND (LOGISTICS_CONFIRMED_DATE IS NOT NULL)
                        </when>
                        <when test="filter == 'logistics-pending'">
                            AND (LOGISTICS_CONFIRMED_DATE IS NULL)
                        </when>
                        <when test="filter == 'shipping-completed'">
                            AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NOT NULL)
                        </when>
                        <when test="filter == 'shipping-pending'">
                            AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NULL)
                        </when>
                        <when test="filter == 'refund-completed'">
                            AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NOT NULL)
                        </when>
                        <when test="filter == 'refund-pending'">
                            AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NULL)
                        </when>
                        <when test="filter == 'payment-completed'">
                            AND (PAYMENT_STATUS = 'COMPLETED')
                        </when>
                        <when test="filter == 'payment-pending'">
                            AND (SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï')
                        </when>
                        <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞ Ï∂îÍ∞Ä -->
                        <when test="filter == 'completed'">
                            AND (IS_COMPLETED = 1)
                        </when>
                        <when test="filter == 'incompleted'">
                            AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
                        </when>
                        <when test="filter == 'overdue-ten-days'">
                            AND (CS_RECEIVED_DATE &lt;= SYSDATE - 10)
                        </when>
                    </choose>
                </foreach>
            </if>
            <if test="keyword != null and keyword != '' and keyword != 'null'">
                AND (
                    UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{keyword} || '%') OR
                    UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                    UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{keyword} || '%') OR
                    UPPER(SITE_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                    UPPER(ORDER_ITEM_CODE) LIKE UPPER('%' || #{keyword} || '%') OR
                    UPPER(TRACKING_NUMBER) LIKE UPPER('%' || #{keyword} || '%')
                )
            </if>
            <if test="startDate != null and startDate != '' and startDate != 'null'">
                AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
            </if>
            <if test="endDate != null and endDate != '' and endDate != 'null'">
                AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
            </if>
            <if test="logisticsStartDate != null and logisticsStartDate != '' and logisticsStartDate != 'null'">
                AND LOGISTICS_CONFIRMED_DATE >= TO_DATE(#{logisticsStartDate}, 'YYYY-MM-DD')
            </if>
            <if test="logisticsEndDate != null and logisticsEndDate != '' and logisticsEndDate != 'null'">
                AND LOGISTICS_CONFIRMED_DATE &lt;= TO_DATE(#{logisticsEndDate}, 'YYYY-MM-DD') + 0.99999
            </if>
        )
        WHERE RN BETWEEN (#{page} * #{size} + 1) AND ((#{page} + 1) * #{size})
    </select>

    <!-- üéØ Îã§Ï§ë ÌïÑÌÑ∞ ÌÜµÌï© Ï°∞Ìöå Ïπ¥Ïö¥Ìä∏ ÏµúÏ†ÅÌôî -->
    <select id="countByMultipleFiltersOptimized" resultType="long">
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) FIRST_ROWS */ COUNT(*)
        FROM TB_RETURN_ITEM
        WHERE 1=1
        <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå ÎØ∏ÏôÑÎ£å Ï°∞Í±¥ Ï†ÅÏö© -->
        <if test="filters == null or filters.size == 0 or !filters.contains('completed')">
            AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
        </if>
        <if test="filters != null and filters.size > 0">
            <foreach collection="filters" item="filter">
                <choose>
                    <when test="filter == 'collection-completed'">
                        AND (COLLECTION_COMPLETED_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'collection-pending'">
                        AND (COLLECTION_COMPLETED_DATE IS NULL)
                    </when>
                    <when test="filter == 'logistics-confirmed'">
                        AND (LOGISTICS_CONFIRMED_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'logistics-pending'">
                        AND (LOGISTICS_CONFIRMED_DATE IS NULL)
                    </when>
                    <when test="filter == 'shipping-completed'">
                        AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'shipping-pending'">
                        AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NULL)
                    </when>
                    <when test="filter == 'refund-completed'">
                        AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'refund-pending'">
                        AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NULL)
                    </when>
                    <when test="filter == 'payment-completed'">
                        AND (PAYMENT_STATUS = 'COMPLETED')
                    </when>
                    <when test="filter == 'payment-pending'">
                        AND (SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï')
                    </when>
                    <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞ Ï∂îÍ∞Ä -->
                    <when test="filter == 'completed'">
                        AND (IS_COMPLETED = 1)
                    </when>
                    <when test="filter == 'incompleted'">
                        AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
                    </when>
                    <when test="filter == 'overdue-ten-days'">
                        AND (CS_RECEIVED_DATE &lt;= SYSDATE - 10)
                    </when>
                </choose>
            </foreach>
        </if>
        <if test="keyword != null and keyword != '' and keyword != 'null'">
            AND (
                UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(SITE_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(ORDER_ITEM_CODE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PRODUCT_COLOR) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PRODUCT_SIZE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(TRACKING_NUMBER) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(RETURN_REASON) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PROCESSOR) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(REMARKS) LIKE UPPER('%' || #{keyword} || '%') OR
                (UPPER(TRIM(#{keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                (UPPER(TRIM(#{keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                (UPPER(TRIM(#{keyword})) = 'Y' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
            )
        </if>
        <if test="startDate != null and startDate != '' and startDate != 'null'">
            AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
        </if>
        <if test="endDate != null and endDate != '' and endDate != 'null'">
            AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
        </if>
        <if test="logisticsStartDate != null and logisticsStartDate != '' and logisticsStartDate != 'null'">
            AND LOGISTICS_CONFIRMED_DATE >= TO_DATE(#{logisticsStartDate}, 'YYYY-MM-DD')
        </if>
        <if test="logisticsEndDate != null and logisticsEndDate != '' and logisticsEndDate != 'null'">
            AND LOGISTICS_CONFIRMED_DATE &lt;= TO_DATE(#{logisticsEndDate}, 'YYYY-MM-DD') + 0.99999
        </if>
    </select>

    <!-- üéØ Îã§Ï§ë ÌïÑÌÑ∞ ÌÜµÌï© Ï°∞Ìöå ÏµúÏ†ÅÌôî (ÌéòÏù¥Ïßï ÏóÜÏùå, ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÏö©) -->
    <select id="findByMultipleFiltersUnlimited" resultMap="ReturnItemResultMap">
        SELECT /*+ INDEX(TB_RETURN_ITEM IDX_RETURN_ITEM_SEARCH) FIRST_ROWS */
            RETURN_ID,
            RETURN_TYPE_CODE,
            ORDER_DATE,
            CS_RECEIVED_DATE,
            SITE_NAME,
            ORDER_NUMBER,
            REFUND_AMOUNT,
            CUSTOMER_NAME,
            CUSTOMER_PHONE,
            ORDER_ITEM_CODE,
            PRODUCT_COLOR,
            PRODUCT_SIZE,
            QUANTITY,
            SHIPPING_FEE,
            RETURN_REASON,
            DEFECT_DETAIL,
            DEFECT_PHOTO_URL,
            TRACKING_NUMBER,
            COLLECTION_COMPLETED_DATE,
            LOGISTICS_CONFIRMED_DATE,
            SHIPPING_DATE,
            REFUND_DATE,
            IS_COMPLETED,
            REMARKS,
            RETURN_STATUS_CODE,
            PROCESSOR,
            CREATE_DATE,
            UPDATE_DATE,
            CREATED_BY,
            UPDATED_BY,
            PAYMENT_STATUS,
            PAYMENT_ID,
            COLLECTION_UPDATED_BY,
            LOGISTICS_UPDATED_BY,
            SHIPPING_UPDATED_BY,
            REFUND_UPDATED_BY,
            COLLECTION_UPDATED_DATE,
            LOGISTICS_UPDATED_DATE,
            SHIPPING_UPDATED_DATE,
            REFUND_UPDATED_DATE
        FROM TB_RETURN_ITEM
        WHERE 1=1
        <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå ÎØ∏ÏôÑÎ£å Ï°∞Í±¥ Ï†ÅÏö© -->
        <if test="filters == null or filters.size == 0 or !filters.contains('completed')">
            AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
        </if>
        <if test="filters != null and filters.size > 0">
            <foreach collection="filters" item="filter">
                <choose>
                    <when test="filter == 'collection-completed'">
                        AND (COLLECTION_COMPLETED_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'collection-pending'">
                        AND (COLLECTION_COMPLETED_DATE IS NULL)
                    </when>
                    <when test="filter == 'logistics-confirmed'">
                        AND (LOGISTICS_CONFIRMED_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'logistics-pending'">
                        AND (LOGISTICS_CONFIRMED_DATE IS NULL)
                    </when>
                    <when test="filter == 'shipping-completed'">
                        AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'shipping-pending'">
                        AND (RETURN_TYPE_CODE IN ('FULL_EXCHANGE', 'PARTIAL_EXCHANGE') AND SHIPPING_DATE IS NULL)
                    </when>
                    <when test="filter == 'refund-completed'">
                        AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NOT NULL)
                    </when>
                    <when test="filter == 'refund-pending'">
                        AND (RETURN_TYPE_CODE IN ('FULL_RETURN', 'PARTIAL_RETURN') AND REFUND_DATE IS NULL)
                    </when>
                    <when test="filter == 'payment-completed'">
                        AND (PAYMENT_STATUS = 'COMPLETED')
                    </when>
                    <when test="filter == 'payment-pending'">
                        AND (SHIPPING_FEE = 'ÏûÖÍ∏àÏòàÏ†ï')
                    </when>
                    <!-- üéØ Ï≤òÎ¶¨ÏôÑÎ£å ÌïÑÌÑ∞ Ï∂îÍ∞Ä -->
                    <when test="filter == 'completed'">
                        AND (IS_COMPLETED = 1)
                    </when>
                    <when test="filter == 'incompleted'">
                        AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
                    </when>
                    <when test="filter == 'overdue-ten-days'">
                        AND (CS_RECEIVED_DATE &lt;= SYSDATE - 10)
                    </when>
                </choose>
            </foreach>
        </if>
        <if test="keyword != null and keyword != '' and keyword != 'null'">
            AND (
                UPPER(ORDER_NUMBER) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(CUSTOMER_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(CUSTOMER_PHONE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(SITE_NAME) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(ORDER_ITEM_CODE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PRODUCT_COLOR) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PRODUCT_SIZE) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(TRACKING_NUMBER) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(RETURN_REASON) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(PROCESSOR) LIKE UPPER('%' || #{keyword} || '%') OR
                UPPER(REMARKS) LIKE UPPER('%' || #{keyword} || '%') OR
                (UPPER(TRIM(#{keyword})) = 'ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'Ï†ÑÏ≤¥ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'Ï≤òÎ¶¨ÏôÑÎ£å' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'ÎØ∏ÏôÑÎ£å' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                (UPPER(TRIM(#{keyword})) = 'ÏßÑÌñâÏ§ë' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)) OR
                (UPPER(TRIM(#{keyword})) = 'Y' AND IS_COMPLETED = 1) OR
                (UPPER(TRIM(#{keyword})) = 'N' AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL))
            )
        </if>
        <if test="startDate != null and startDate != '' and startDate != 'null'">
            AND CS_RECEIVED_DATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
        </if>
        <if test="endDate != null and endDate != '' and endDate != 'null'">
            AND CS_RECEIVED_DATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
        </if>
        <if test="logisticsStartDate != null and logisticsStartDate != '' and logisticsStartDate != 'null'">
            AND LOGISTICS_CONFIRMED_DATE >= TO_DATE(#{logisticsStartDate}, 'YYYY-MM-DD')
        </if>
        <if test="logisticsEndDate != null and logisticsEndDate != '' and logisticsEndDate != 'null'">
            AND LOGISTICS_CONFIRMED_DATE &lt;= TO_DATE(#{logisticsEndDate}, 'YYYY-MM-DD') + 0.99999
        </if>
        ORDER BY CS_RECEIVED_DATE DESC, RETURN_ID DESC
    </select>

</mapper> 