<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wio.crm.mapper.ExchangeStatsMapper">

    <!-- üöÄ ÍµêÌôòÎ∞òÌíà ÌÜµÍ≥Ñ Ï†ÑÏö© Îß§Ìçº XML (Ïã†Í∑ú ÏÑ§Í≥Ñ) -->
    <!-- Î™©Ï†Å: TB_RETURN_ITEM ÌÖåÏù¥Î∏î Í∏∞Ï§Ä ÏµúÏ†ÅÌôîÎêú ÌÜµÍ≥Ñ ÏøºÎ¶¨ -->
    <!-- ÌäπÏßï: Îã®ÏàúÌïòÍ≥† Î™ÖÌôïÌïú SQL, Ï§ëÎ≥µ Ï†úÍ±∞, ÏÑ±Îä• ÏµúÏ†ÅÌôî -->

    <!-- ==================== Í≥µÌÜµ Ï°∞Í±¥ Íµ¨Î¨∏ ==================== -->

    <!-- ÎÇ†Ïßú Ï°∞Í±¥ -->
    <sql id="dateCondition">
        <choose>
            <when test="request.dateFilterType == 'CS_RECEIVED'">
                AND CS_RECEIVED_DATE BETWEEN #{request.csStartDate} AND #{request.csEndDate}
            </when>
            <when test="request.dateFilterType == 'ORDER_DATE'">
                AND ORDER_DATE BETWEEN #{request.orderStartDate} AND #{request.orderEndDate}
            </when>
        </choose>
    </sql>

    <!-- Í∏∞ÌÉÄ ÌïÑÌÑ∞ Ï°∞Í±¥ -->
    <sql id="filterConditions">
        <if test="request.returnType != null and request.returnType != ''">
            AND RETURN_TYPE_CODE = #{request.returnType}
        </if>
        <if test="request.completionStatus != null and request.completionStatus != ''">
            <choose>
                <when test="request.completionStatus == 'COMPLETED'">
                    AND IS_COMPLETED = 1
                </when>
                <when test="request.completionStatus == 'INCOMPLETE'">
                    AND (IS_COMPLETED = 0 OR IS_COMPLETED IS NULL)
                </when>
            </choose>
        </if>
        <if test="request.siteName != null and request.siteName != ''">
            AND SITE_NAME = #{request.siteName}
        </if>
    </sql>

    <!-- Í∏∞Î≥∏ WHERE Ï†à -->
    <sql id="baseConditions">
        WHERE 1=1
        <include refid="dateCondition"/>
        <include refid="filterConditions"/>
    </sql>

    <!-- ==================== ÌïµÏã¨ ÌÜµÍ≥Ñ Ï°∞Ìöå ==================== -->

    <select id="getCoreStats" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$CoreStats">
        SELECT 
            COUNT(*) as totalCount,
            COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) as completedCount,
            COUNT(CASE WHEN IS_COMPLETED = 0 OR IS_COMPLETED IS NULL THEN 1 END) as incompleteCount,
            CASE 
                WHEN COUNT(*) > 0 THEN ROUND((COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) * 100.0 / COUNT(*)), 2)
                ELSE 0.0 
            END as completionRate,
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            COALESCE(SUM(SHIPPING_FEE), 0) as totalShippingFee
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
    </select>

    <!-- ==================== Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ==================== -->

    <select id="getTrendData" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$TrendPoint">
        SELECT 
            <choose>
                <when test="request.dateFilterType == 'CS_RECEIVED'">
                    TO_CHAR(CS_RECEIVED_DATE, 'YYYY-MM-DD') as dateLabel,
                </when>
                <when test="request.dateFilterType == 'ORDER_DATE'">
                    TO_CHAR(ORDER_DATE, 'YYYY-MM-DD') as dateLabel,
                </when>
                <otherwise>
                    TO_CHAR(CS_RECEIVED_DATE, 'YYYY-MM-DD') as dateLabel,
                </otherwise>
            </choose>
            COUNT(*) as totalCount,
            COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) as completedCount,
            COUNT(CASE WHEN IS_COMPLETED = 0 OR IS_COMPLETED IS NULL THEN 1 END) as incompleteCount,
            COALESCE(SUM(REFUND_AMOUNT), 0) as refundAmount,
            CASE 
                WHEN COUNT(*) > 0 THEN ROUND((COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) * 100.0 / COUNT(*)), 2)
                ELSE 0.0 
            END as completionRate
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
        GROUP BY 
            <choose>
                <when test="request.dateFilterType == 'CS_RECEIVED'">
                    TO_CHAR(CS_RECEIVED_DATE, 'YYYY-MM-DD')
                </when>
                <when test="request.dateFilterType == 'ORDER_DATE'">
                    TO_CHAR(ORDER_DATE, 'YYYY-MM-DD')
                </when>
                <otherwise>
                    TO_CHAR(CS_RECEIVED_DATE, 'YYYY-MM-DD')
                </otherwise>
            </choose>
        ORDER BY dateLabel
    </select>

    <!-- ==================== Ïú†ÌòïÎ≥Ñ Î∂ÑÌè¨ Ï°∞Ìöå ==================== -->

    <select id="getTypeDistribution" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$TypeDistribution">
        SELECT 
            RETURN_TYPE_CODE as returnType,
            COUNT(*) as count,
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            CASE 
                WHEN COUNT(*) > 0 THEN ROUND(AVG(REFUND_AMOUNT), 0)
                ELSE 0 
            END as averageRefundAmount
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
        AND RETURN_TYPE_CODE IS NOT NULL
        GROUP BY RETURN_TYPE_CODE
        ORDER BY count DESC
    </select>

    <!-- ==================== ÏÉÅÌÉúÎ≥Ñ Î∂ÑÌè¨ Ï°∞Ìöå ==================== -->

    <select id="getStatusDistribution" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$StatusDistribution">
        SELECT 
            CASE 
                WHEN IS_COMPLETED = 1 THEN 1
                ELSE 0 
            END as isCompleted,
            COUNT(*) as count,
            0.0 as percentage  -- ÎπÑÏú®ÏùÄ ÏÑúÎπÑÏä§ Î†àÏù¥Ïñ¥ÏóêÏÑú Í≥ÑÏÇ∞
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
        GROUP BY 
            CASE 
                WHEN IS_COMPLETED = 1 THEN 1
                ELSE 0 
            END
        ORDER BY isCompleted DESC
    </select>

    <!-- ==================== ÏÇ¨Ïú†Î≥Ñ Î∂ÑÏÑù Ï°∞Ìöå ==================== -->

    <select id="getReasonAnalysis" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$ReasonAnalysis">
        SELECT 
            COALESCE(RETURN_REASON, 'ÏÇ¨Ïú†ÏóÜÏùå') as returnReason,
            COUNT(*) as count,
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            CASE 
                WHEN COUNT(*) > 0 THEN ROUND(AVG(REFUND_AMOUNT), 0)
                ELSE 0 
            END as averageRefundAmount
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
        GROUP BY RETURN_REASON
        ORDER BY count DESC
        FETCH FIRST 10 ROWS ONLY  -- ÏÉÅÏúÑ 10Í∞ú ÏÇ¨Ïú†Îßå Ï°∞Ìöå
    </select>

    <!-- ==================== ÏÇ¨Ïù¥Ìä∏Î≥Ñ ÏÑ±Í≥º Ï°∞Ìöå ==================== -->

    <select id="getSitePerformance" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$SitePerformance">
        SELECT 
            COALESCE(SITE_NAME, 'ÎØ∏ÏßÄÏ†ï') as siteName,
            COUNT(*) as totalCount,
            COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) as completedCount,
            COUNT(CASE WHEN IS_COMPLETED = 0 OR IS_COMPLETED IS NULL THEN 1 END) as incompleteCount,
            CASE 
                WHEN COUNT(*) > 0 THEN ROUND((COUNT(CASE WHEN IS_COMPLETED = 1 THEN 1 END) * 100.0 / COUNT(*)), 2)
                ELSE 0.0 
            END as completionRate,
            COALESCE(SUM(REFUND_AMOUNT), 0) as totalRefundAmount,
            COALESCE(SUM(SHIPPING_FEE), 0) as totalShippingFee
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
        GROUP BY SITE_NAME
        ORDER BY totalCount DESC
    </select>

    <!-- ==================== Ìó¨Ïä§Ï≤¥ÌÅ¨ Î∞è ÎîîÎ≤ÑÍπÖ Î©îÏÑúÎìúÎì§ ==================== -->

    <!-- Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÌôïÏù∏ -->
    <select id="checkDatabaseConnection" resultType="Boolean">
        SELECT 
            CASE WHEN COUNT(*) >= 0 THEN 1 ELSE 0 END
        FROM DUAL
    </select>

    <!-- ÌÖåÏù¥Î∏î Ï°¥Ïû¨ ÌôïÏù∏ -->
    <select id="checkTableExists" parameterType="String" resultType="Boolean">
        SELECT 
            CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM USER_TABLES 
        WHERE TABLE_NAME = UPPER(#{tableName})
    </select>

    <!-- ÏµúÍ∑º Îç∞Ïù¥ÌÑ∞ Í±¥Ïàò ÌôïÏù∏ (7Ïùº Ïù¥ÎÇ¥) -->
    <select id="getRecentDataCount" resultType="Long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        WHERE CS_RECEIVED_DATE >= SYSDATE - 7
    </select>

    <!-- Í≤ÄÏÉâ Ï°∞Í±¥ Ïú†Ìö®ÏÑ± ÌôïÏù∏ -->
    <select id="validateSearchConditions" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="Long">
        SELECT COUNT(*)
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
    </select>

    <!-- ÏøºÎ¶¨ ÏÑ±Îä• ÌÖåÏä§Ìä∏ -->
    <select id="measureQueryPerformance" parameterType="com.wio.crm.dto.ExchangeStatsRequestDto" 
            resultType="com.wio.crm.dto.ExchangeStatsData$PerformanceInfo">
        SELECT 
            0 as queryExecutionTimeMs,      -- Ïã§Ï†ú Íµ¨ÌòÑÏãú Í≥ÑÏÇ∞ ÌïÑÏöî
            0 as totalProcessingTimeMs,     -- Ïã§Ï†ú Íµ¨ÌòÑÏãú Í≥ÑÏÇ∞ ÌïÑÏöî
            COUNT(*) as recordsProcessed,
            0.0 as recordsPerSecond         -- Ïã§Ï†ú Íµ¨ÌòÑÏãú Í≥ÑÏÇ∞ ÌïÑÏöî
        FROM TB_RETURN_ITEM
        <include refid="baseConditions"/>
    </select>

</mapper> 